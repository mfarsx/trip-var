e063ec3b2872a6431000e8f5f17ac9b1
const Booking = require('../public/models/booking.model');
const Destination = require('../public/models/destination.model');
const {
  ValidationError,
  NotFoundError,
  ConflictError
} = require('../utils/errors');
const {
  successResponse
} = require('../utils/response');
const {
  info,
  error
} = require('../utils/logger');
const NotificationService = require('../services/notification.service');

// Create a new booking
const createBooking = async (req, res, next) => {
  try {
    const {
      destinationId,
      checkInDate,
      checkOutDate,
      numberOfGuests,
      paymentMethod,
      specialRequests,
      contactEmail,
      contactPhone
    } = req.body;
    const userId = req.user.id;

    // Validate required fields
    if (!destinationId || !checkInDate || !checkOutDate || !numberOfGuests) {
      throw new ValidationError('Missing required booking information');
    }

    // Parse dates
    const checkIn = new Date(checkInDate);
    const checkOut = new Date(checkOutDate);

    // Validate dates
    if (checkIn <= new Date()) {
      throw new ValidationError('Check-in date must be in the future');
    }
    if (checkOut <= checkIn) {
      throw new ValidationError('Check-out date must be after check-in date');
    }

    // Get destination details
    const destination = await Destination.findById(destinationId);
    if (!destination) {
      throw new NotFoundError('Destination not found');
    }

    // Check availability
    const isAvailable = await Booking.checkAvailability(destinationId, checkIn, checkOut);
    if (!isAvailable) {
      throw new ConflictError('Destination is not available for the selected dates');
    }

    // Calculate pricing
    const totalNights = Math.ceil((checkOut - checkIn) / (1000 * 3600 * 24));
    const totalAmount = totalNights * destination.price * numberOfGuests;

    // Create booking
    const booking = new Booking({
      user: userId,
      destination: destinationId,
      checkInDate: checkIn,
      checkOutDate: checkOut,
      numberOfGuests,
      pricePerNight: destination.price,
      totalNights,
      totalAmount,
      paymentMethod,
      specialRequests,
      contactEmail: contactEmail || req.user.email,
      contactPhone
    });
    await booking.save();

    // Populate the booking with destination details
    await booking.populate([{
      path: 'destination',
      select: 'title location imageUrl'
    }]);
    info('New booking created', {
      bookingId: booking._id,
      userId,
      destinationId,
      totalAmount
    });

    // Create booking confirmation notification
    try {
      await NotificationService.createBookingConfirmationNotification(userId, booking);
    } catch (notificationError) {
      // Log error but don't fail the booking creation
      error('Failed to create booking confirmation notification', {
        error: notificationError.message,
        bookingId: booking._id,
        userId
      });
    }
    res.status(201).json(successResponse({
      booking
    }, 'Booking created successfully'));
  } catch (err) {
    error('Error creating booking', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Get user's bookings
const getUserBookings = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const {
      status,
      page = 1,
      limit = 10
    } = req.query;

    // Build query
    const query = {
      user: userId
    };
    if (status) {
      query.status = status;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get bookings with pagination
    const bookings = await Booking.find(query).populate('destination', 'title location imageUrl rating').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count for pagination
    const total = await Booking.countDocuments(query);
    res.json({
      success: true,
      data: {
        bookings,
        pagination: {
          current: parseInt(page, 10),
          pages: Math.ceil(total / parseInt(limit, 10)),
          total
        }
      }
    });
  } catch (err) {
    error('Error fetching user bookings', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Get specific booking
const getBookingById = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const userId = req.user.id;
    const booking = await Booking.findById(id).populate('destination', 'title location imageUrl rating description').populate('user', 'name email');
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking or is admin
    if (booking.user._id.toString() !== userId && req.user.role !== 'admin') {
      throw new ValidationError('Access denied');
    }
    res.json({
      success: true,
      data: {
        booking
      }
    });
  } catch (err) {
    error('Error fetching booking', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Cancel booking
const cancelBooking = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const {
      reason
    } = req.body;
    const userId = req.user.id;
    const booking = await Booking.findById(id).populate('destination');
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking
    if (booking.user.toString() !== userId) {
      throw new ValidationError('Access denied');
    }

    // Check if booking can be cancelled
    if (booking.status === 'cancelled') {
      throw new ConflictError('Booking is already cancelled');
    }
    if (booking.status === 'completed') {
      throw new ConflictError('Cannot cancel completed booking');
    }

    // Calculate refund amount
    const refundAmount = booking.calculateRefund();

    // Update booking
    booking.status = 'cancelled';
    booking.cancelledAt = new Date();
    booking.cancellationReason = reason;
    booking.refundAmount = refundAmount;
    if (refundAmount > 0) {
      booking.paymentStatus = 'refunded';
      booking.refundedAt = new Date();
    }
    await booking.save();
    info('Booking cancelled', {
      bookingId: id,
      userId,
      refundAmount
    });

    // Create booking cancellation notification
    try {
      await NotificationService.createBookingCancellationNotification(userId, booking, refundAmount);
    } catch (notificationError) {
      // Log error but don't fail the cancellation
      error('Failed to create booking cancellation notification', {
        error: notificationError.message,
        bookingId: id,
        userId
      });
    }
    res.json({
      success: true,
      message: 'Booking cancelled successfully',
      data: {
        booking,
        refundAmount
      }
    });
  } catch (err) {
    error('Error cancelling booking', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Get all bookings (admin only)
const getAllBookings = async (req, res, next) => {
  try {
    const {
      status,
      page = 1,
      limit = 20,
      destinationId
    } = req.query;

    // Build query
    const query = {};
    if (status) {
      query.status = status;
    }
    if (destinationId) {
      query.destination = destinationId;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get bookings with pagination
    const bookings = await Booking.find(query).populate('destination', 'title location').populate('user', 'name email').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count
    const total = await Booking.countDocuments(query);
    res.json({
      success: true,
      data: {
        bookings,
        pagination: {
          current: parseInt(page, 10),
          pages: Math.ceil(total / parseInt(limit, 10)),
          total
        }
      }
    });
  } catch (err) {
    error('Error fetching all bookings', {
      error: err.message
    });
    next(err);
  }
};

// Update booking status (admin only)
const updateBookingStatus = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const {
      status
    } = req.body;
    const validStatuses = ['confirmed', 'cancelled', 'completed', 'no-show'];
    if (!validStatuses.includes(status)) {
      throw new ValidationError('Invalid booking status');
    }
    const booking = await Booking.findById(id);
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }
    booking.status = status;
    await booking.save();
    info('Booking status updated', {
      bookingId: id,
      newStatus: status,
      adminId: req.user.id
    });
    res.json({
      success: true,
      message: 'Booking status updated successfully',
      data: {
        booking
      }
    });
  } catch (err) {
    error('Error updating booking status', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Check availability for a destination
const checkAvailability = async (req, res, next) => {
  try {
    const {
      destinationId,
      checkInDate,
      checkOutDate
    } = req.query;
    if (!destinationId || !checkInDate || !checkOutDate) {
      throw new ValidationError('Missing required parameters');
    }
    const checkIn = new Date(checkInDate);
    const checkOut = new Date(checkOutDate);
    const isAvailable = await Booking.checkAvailability(destinationId, checkIn, checkOut);
    res.json({
      success: true,
      data: {
        available: isAvailable,
        checkInDate: checkIn,
        checkOutDate: checkOut
      }
    });
  } catch (err) {
    error('Error checking availability', {
      error: err.message
    });
    next(err);
  }
};
module.exports = {
  createBooking,
  getUserBookings,
  getBookingById,
  cancelBooking,
  getAllBookings,
  updateBookingStatus,
  checkAvailability
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29raW5nIiwicmVxdWlyZSIsIkRlc3RpbmF0aW9uIiwiVmFsaWRhdGlvbkVycm9yIiwiTm90Rm91bmRFcnJvciIsIkNvbmZsaWN0RXJyb3IiLCJzdWNjZXNzUmVzcG9uc2UiLCJpbmZvIiwiZXJyb3IiLCJOb3RpZmljYXRpb25TZXJ2aWNlIiwiY3JlYXRlQm9va2luZyIsInJlcSIsInJlcyIsIm5leHQiLCJkZXN0aW5hdGlvbklkIiwiY2hlY2tJbkRhdGUiLCJjaGVja091dERhdGUiLCJudW1iZXJPZkd1ZXN0cyIsInBheW1lbnRNZXRob2QiLCJzcGVjaWFsUmVxdWVzdHMiLCJjb250YWN0RW1haWwiLCJjb250YWN0UGhvbmUiLCJib2R5IiwidXNlcklkIiwidXNlciIsImlkIiwiY2hlY2tJbiIsIkRhdGUiLCJjaGVja091dCIsImRlc3RpbmF0aW9uIiwiZmluZEJ5SWQiLCJpc0F2YWlsYWJsZSIsImNoZWNrQXZhaWxhYmlsaXR5IiwidG90YWxOaWdodHMiLCJNYXRoIiwiY2VpbCIsInRvdGFsQW1vdW50IiwicHJpY2UiLCJib29raW5nIiwicHJpY2VQZXJOaWdodCIsImVtYWlsIiwic2F2ZSIsInBvcHVsYXRlIiwicGF0aCIsInNlbGVjdCIsImJvb2tpbmdJZCIsIl9pZCIsImNyZWF0ZUJvb2tpbmdDb25maXJtYXRpb25Ob3RpZmljYXRpb24iLCJub3RpZmljYXRpb25FcnJvciIsIm1lc3NhZ2UiLCJzdGF0dXMiLCJqc29uIiwiZXJyIiwiZ2V0VXNlckJvb2tpbmdzIiwicGFnZSIsImxpbWl0IiwicXVlcnkiLCJza2lwIiwicGFyc2VJbnQiLCJib29raW5ncyIsImZpbmQiLCJzb3J0IiwiY3JlYXRlZEF0IiwidG90YWwiLCJjb3VudERvY3VtZW50cyIsInN1Y2Nlc3MiLCJkYXRhIiwicGFnaW5hdGlvbiIsImN1cnJlbnQiLCJwYWdlcyIsImdldEJvb2tpbmdCeUlkIiwicGFyYW1zIiwidG9TdHJpbmciLCJyb2xlIiwiY2FuY2VsQm9va2luZyIsInJlYXNvbiIsInJlZnVuZEFtb3VudCIsImNhbGN1bGF0ZVJlZnVuZCIsImNhbmNlbGxlZEF0IiwiY2FuY2VsbGF0aW9uUmVhc29uIiwicGF5bWVudFN0YXR1cyIsInJlZnVuZGVkQXQiLCJjcmVhdGVCb29raW5nQ2FuY2VsbGF0aW9uTm90aWZpY2F0aW9uIiwiZ2V0QWxsQm9va2luZ3MiLCJ1cGRhdGVCb29raW5nU3RhdHVzIiwidmFsaWRTdGF0dXNlcyIsImluY2x1ZGVzIiwibmV3U3RhdHVzIiwiYWRtaW5JZCIsImF2YWlsYWJsZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJib29raW5nLmNvbnRyb2xsZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQm9va2luZyA9IHJlcXVpcmUoJy4uL3B1YmxpYy9tb2RlbHMvYm9va2luZy5tb2RlbCcpO1xuY29uc3QgRGVzdGluYXRpb24gPSByZXF1aXJlKCcuLi9wdWJsaWMvbW9kZWxzL2Rlc3RpbmF0aW9uLm1vZGVsJyk7XG5jb25zdCB7IFZhbGlkYXRpb25FcnJvciwgTm90Rm91bmRFcnJvciwgQ29uZmxpY3RFcnJvciB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvZXJyb3JzJyk7XG5jb25zdCB7IHN1Y2Nlc3NSZXNwb25zZSB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvcmVzcG9uc2UnKTtcbmNvbnN0IHsgaW5mbywgZXJyb3IgfSA9IHJlcXVpcmUoJy4uL3V0aWxzL2xvZ2dlcicpO1xuY29uc3QgTm90aWZpY2F0aW9uU2VydmljZSA9IHJlcXVpcmUoJy4uL3NlcnZpY2VzL25vdGlmaWNhdGlvbi5zZXJ2aWNlJyk7XG5cbi8vIENyZWF0ZSBhIG5ldyBib29raW5nXG5jb25zdCBjcmVhdGVCb29raW5nID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7XG4gICAgICBkZXN0aW5hdGlvbklkLFxuICAgICAgY2hlY2tJbkRhdGUsXG4gICAgICBjaGVja091dERhdGUsXG4gICAgICBudW1iZXJPZkd1ZXN0cyxcbiAgICAgIHBheW1lbnRNZXRob2QsXG4gICAgICBzcGVjaWFsUmVxdWVzdHMsXG4gICAgICBjb250YWN0RW1haWwsXG4gICAgICBjb250YWN0UGhvbmVcbiAgICB9ID0gcmVxLmJvZHk7XG5cbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcblxuICAgIC8vIFZhbGlkYXRlIHJlcXVpcmVkIGZpZWxkc1xuICAgIGlmICghZGVzdGluYXRpb25JZCB8fCAhY2hlY2tJbkRhdGUgfHwgIWNoZWNrT3V0RGF0ZSB8fCAhbnVtYmVyT2ZHdWVzdHMpIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgYm9va2luZyBpbmZvcm1hdGlvbicpO1xuICAgIH1cblxuICAgIC8vIFBhcnNlIGRhdGVzXG4gICAgY29uc3QgY2hlY2tJbiA9IG5ldyBEYXRlKGNoZWNrSW5EYXRlKTtcbiAgICBjb25zdCBjaGVja091dCA9IG5ldyBEYXRlKGNoZWNrT3V0RGF0ZSk7XG5cbiAgICAvLyBWYWxpZGF0ZSBkYXRlc1xuICAgIGlmIChjaGVja0luIDw9IG5ldyBEYXRlKCkpIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ0NoZWNrLWluIGRhdGUgbXVzdCBiZSBpbiB0aGUgZnV0dXJlJyk7XG4gICAgfVxuXG4gICAgaWYgKGNoZWNrT3V0IDw9IGNoZWNrSW4pIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ0NoZWNrLW91dCBkYXRlIG11c3QgYmUgYWZ0ZXIgY2hlY2staW4gZGF0ZScpO1xuICAgIH1cblxuICAgIC8vIEdldCBkZXN0aW5hdGlvbiBkZXRhaWxzXG4gICAgY29uc3QgZGVzdGluYXRpb24gPSBhd2FpdCBEZXN0aW5hdGlvbi5maW5kQnlJZChkZXN0aW5hdGlvbklkKTtcbiAgICBpZiAoIWRlc3RpbmF0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcignRGVzdGluYXRpb24gbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgYXZhaWxhYmlsaXR5XG4gICAgY29uc3QgaXNBdmFpbGFibGUgPSBhd2FpdCBCb29raW5nLmNoZWNrQXZhaWxhYmlsaXR5KGRlc3RpbmF0aW9uSWQsIGNoZWNrSW4sIGNoZWNrT3V0KTtcbiAgICBpZiAoIWlzQXZhaWxhYmxlKSB7XG4gICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFcnJvcignRGVzdGluYXRpb24gaXMgbm90IGF2YWlsYWJsZSBmb3IgdGhlIHNlbGVjdGVkIGRhdGVzJyk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHByaWNpbmdcbiAgICBjb25zdCB0b3RhbE5pZ2h0cyA9IE1hdGguY2VpbCgoY2hlY2tPdXQgLSBjaGVja0luKSAvICgxMDAwICogMzYwMCAqIDI0KSk7XG4gICAgY29uc3QgdG90YWxBbW91bnQgPSB0b3RhbE5pZ2h0cyAqIGRlc3RpbmF0aW9uLnByaWNlICogbnVtYmVyT2ZHdWVzdHM7XG5cbiAgICAvLyBDcmVhdGUgYm9va2luZ1xuICAgIGNvbnN0IGJvb2tpbmcgPSBuZXcgQm9va2luZyh7XG4gICAgICB1c2VyOiB1c2VySWQsXG4gICAgICBkZXN0aW5hdGlvbjogZGVzdGluYXRpb25JZCxcbiAgICAgIGNoZWNrSW5EYXRlOiBjaGVja0luLFxuICAgICAgY2hlY2tPdXREYXRlOiBjaGVja091dCxcbiAgICAgIG51bWJlck9mR3Vlc3RzLFxuICAgICAgcHJpY2VQZXJOaWdodDogZGVzdGluYXRpb24ucHJpY2UsXG4gICAgICB0b3RhbE5pZ2h0cyxcbiAgICAgIHRvdGFsQW1vdW50LFxuICAgICAgcGF5bWVudE1ldGhvZCxcbiAgICAgIHNwZWNpYWxSZXF1ZXN0cyxcbiAgICAgIGNvbnRhY3RFbWFpbDogY29udGFjdEVtYWlsIHx8IHJlcS51c2VyLmVtYWlsLFxuICAgICAgY29udGFjdFBob25lXG4gICAgfSk7XG5cbiAgICBhd2FpdCBib29raW5nLnNhdmUoKTtcblxuICAgIC8vIFBvcHVsYXRlIHRoZSBib29raW5nIHdpdGggZGVzdGluYXRpb24gZGV0YWlsc1xuICAgIGF3YWl0IGJvb2tpbmcucG9wdWxhdGUoW1xuICAgICAgeyBwYXRoOiAnZGVzdGluYXRpb24nLCBzZWxlY3Q6ICd0aXRsZSBsb2NhdGlvbiBpbWFnZVVybCcgfVxuICAgIF0pO1xuXG4gICAgaW5mbygnTmV3IGJvb2tpbmcgY3JlYXRlZCcsIHtcbiAgICAgIGJvb2tpbmdJZDogYm9va2luZy5faWQsXG4gICAgICB1c2VySWQsXG4gICAgICBkZXN0aW5hdGlvbklkLFxuICAgICAgdG90YWxBbW91bnRcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBib29raW5nIGNvbmZpcm1hdGlvbiBub3RpZmljYXRpb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVCb29raW5nQ29uZmlybWF0aW9uTm90aWZpY2F0aW9uKHVzZXJJZCwgYm9va2luZyk7XG4gICAgfSBjYXRjaCAobm90aWZpY2F0aW9uRXJyb3IpIHtcbiAgICAgIC8vIExvZyBlcnJvciBidXQgZG9uJ3QgZmFpbCB0aGUgYm9va2luZyBjcmVhdGlvblxuICAgICAgZXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgYm9va2luZyBjb25maXJtYXRpb24gbm90aWZpY2F0aW9uJywge1xuICAgICAgICBlcnJvcjogbm90aWZpY2F0aW9uRXJyb3IubWVzc2FnZSxcbiAgICAgICAgYm9va2luZ0lkOiBib29raW5nLl9pZCxcbiAgICAgICAgdXNlcklkXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihzdWNjZXNzUmVzcG9uc2UoXG4gICAgICB7IGJvb2tpbmcgfSxcbiAgICAgICdCb29raW5nIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5J1xuICAgICkpO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBjcmVhdGluZyBib29raW5nJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIHVzZXJJZDogcmVxLnVzZXI/LmlkIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gR2V0IHVzZXIncyBib29raW5nc1xuY29uc3QgZ2V0VXNlckJvb2tpbmdzID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcbiAgICBjb25zdCB7IHN0YXR1cywgcGFnZSA9IDEsIGxpbWl0ID0gMTAgfSA9IHJlcS5xdWVyeTtcblxuICAgIC8vIEJ1aWxkIHF1ZXJ5XG4gICAgY29uc3QgcXVlcnkgPSB7IHVzZXI6IHVzZXJJZCB9O1xuICAgIGlmIChzdGF0dXMpIHtcbiAgICAgIHF1ZXJ5LnN0YXR1cyA9IHN0YXR1cztcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhdGUgcGFnaW5hdGlvblxuICAgIGNvbnN0IHNraXAgPSAocGFyc2VJbnQocGFnZSwgMTApIC0gMSkgKiBwYXJzZUludChsaW1pdCwgMTApO1xuXG4gICAgLy8gR2V0IGJvb2tpbmdzIHdpdGggcGFnaW5hdGlvblxuICAgIGNvbnN0IGJvb2tpbmdzID0gYXdhaXQgQm9va2luZy5maW5kKHF1ZXJ5KVxuICAgICAgLnBvcHVsYXRlKCdkZXN0aW5hdGlvbicsICd0aXRsZSBsb2NhdGlvbiBpbWFnZVVybCByYXRpbmcnKVxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXG4gICAgICAuc2tpcChza2lwKVxuICAgICAgLmxpbWl0KHBhcnNlSW50KGxpbWl0LCAxMCkpO1xuXG4gICAgLy8gR2V0IHRvdGFsIGNvdW50IGZvciBwYWdpbmF0aW9uXG4gICAgY29uc3QgdG90YWwgPSBhd2FpdCBCb29raW5nLmNvdW50RG9jdW1lbnRzKHF1ZXJ5KTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGJvb2tpbmdzLFxuICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgY3VycmVudDogcGFyc2VJbnQocGFnZSwgMTApLFxuICAgICAgICAgIHBhZ2VzOiBNYXRoLmNlaWwodG90YWwgLyBwYXJzZUludChsaW1pdCwgMTApKSxcbiAgICAgICAgICB0b3RhbFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIGZldGNoaW5nIHVzZXIgYm9va2luZ3MnLCB7IGVycm9yOiBlcnIubWVzc2FnZSwgdXNlcklkOiByZXEudXNlcj8uaWQgfSk7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG4vLyBHZXQgc3BlY2lmaWMgYm9va2luZ1xuY29uc3QgZ2V0Qm9va2luZ0J5SWQgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG5cbiAgICBjb25zdCBib29raW5nID0gYXdhaXQgQm9va2luZy5maW5kQnlJZChpZClcbiAgICAgIC5wb3B1bGF0ZSgnZGVzdGluYXRpb24nLCAndGl0bGUgbG9jYXRpb24gaW1hZ2VVcmwgcmF0aW5nIGRlc2NyaXB0aW9uJylcbiAgICAgIC5wb3B1bGF0ZSgndXNlcicsICduYW1lIGVtYWlsJyk7XG5cbiAgICBpZiAoIWJvb2tpbmcpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdCb29raW5nIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgb3ducyB0aGlzIGJvb2tpbmcgb3IgaXMgYWRtaW5cbiAgICBpZiAoYm9va2luZy51c2VyLl9pZC50b1N0cmluZygpICE9PSB1c2VySWQgJiYgcmVxLnVzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQWNjZXNzIGRlbmllZCcpO1xuICAgIH1cblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGJvb2tpbmdcbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgZmV0Y2hpbmcgYm9va2luZycsIHsgZXJyb3I6IGVyci5tZXNzYWdlLCBib29raW5nSWQ6IHJlcS5wYXJhbXMuaWQgfSk7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG4vLyBDYW5jZWwgYm9va2luZ1xuY29uc3QgY2FuY2VsQm9va2luZyA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB7IHJlYXNvbiB9ID0gcmVxLmJvZHk7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG5cbiAgICBjb25zdCBib29raW5nID0gYXdhaXQgQm9va2luZy5maW5kQnlJZChpZCkucG9wdWxhdGUoJ2Rlc3RpbmF0aW9uJyk7XG5cbiAgICBpZiAoIWJvb2tpbmcpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdCb29raW5nIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgb3ducyB0aGlzIGJvb2tpbmdcbiAgICBpZiAoYm9va2luZy51c2VyLnRvU3RyaW5nKCkgIT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQWNjZXNzIGRlbmllZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGJvb2tpbmcgY2FuIGJlIGNhbmNlbGxlZFxuICAgIGlmIChib29raW5nLnN0YXR1cyA9PT0gJ2NhbmNlbGxlZCcpIHtcbiAgICAgIHRocm93IG5ldyBDb25mbGljdEVycm9yKCdCb29raW5nIGlzIGFscmVhZHkgY2FuY2VsbGVkJyk7XG4gICAgfVxuXG4gICAgaWYgKGJvb2tpbmcuc3RhdHVzID09PSAnY29tcGxldGVkJykge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXJyb3IoJ0Nhbm5vdCBjYW5jZWwgY29tcGxldGVkIGJvb2tpbmcnKTtcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhdGUgcmVmdW5kIGFtb3VudFxuICAgIGNvbnN0IHJlZnVuZEFtb3VudCA9IGJvb2tpbmcuY2FsY3VsYXRlUmVmdW5kKCk7XG5cbiAgICAvLyBVcGRhdGUgYm9va2luZ1xuICAgIGJvb2tpbmcuc3RhdHVzID0gJ2NhbmNlbGxlZCc7XG4gICAgYm9va2luZy5jYW5jZWxsZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgYm9va2luZy5jYW5jZWxsYXRpb25SZWFzb24gPSByZWFzb247XG4gICAgYm9va2luZy5yZWZ1bmRBbW91bnQgPSByZWZ1bmRBbW91bnQ7XG5cbiAgICBpZiAocmVmdW5kQW1vdW50ID4gMCkge1xuICAgICAgYm9va2luZy5wYXltZW50U3RhdHVzID0gJ3JlZnVuZGVkJztcbiAgICAgIGJvb2tpbmcucmVmdW5kZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgfVxuXG4gICAgYXdhaXQgYm9va2luZy5zYXZlKCk7XG5cbiAgICBpbmZvKCdCb29raW5nIGNhbmNlbGxlZCcsIHtcbiAgICAgIGJvb2tpbmdJZDogaWQsXG4gICAgICB1c2VySWQsXG4gICAgICByZWZ1bmRBbW91bnRcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBib29raW5nIGNhbmNlbGxhdGlvbiBub3RpZmljYXRpb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVCb29raW5nQ2FuY2VsbGF0aW9uTm90aWZpY2F0aW9uKHVzZXJJZCwgYm9va2luZywgcmVmdW5kQW1vdW50KTtcbiAgICB9IGNhdGNoIChub3RpZmljYXRpb25FcnJvcikge1xuICAgICAgLy8gTG9nIGVycm9yIGJ1dCBkb24ndCBmYWlsIHRoZSBjYW5jZWxsYXRpb25cbiAgICAgIGVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIGJvb2tpbmcgY2FuY2VsbGF0aW9uIG5vdGlmaWNhdGlvbicsIHtcbiAgICAgICAgZXJyb3I6IG5vdGlmaWNhdGlvbkVycm9yLm1lc3NhZ2UsXG4gICAgICAgIGJvb2tpbmdJZDogaWQsXG4gICAgICAgIHVzZXJJZFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdCb29raW5nIGNhbmNlbGxlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgZGF0YToge1xuICAgICAgICBib29raW5nLFxuICAgICAgICByZWZ1bmRBbW91bnRcbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgY2FuY2VsbGluZyBib29raW5nJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIGJvb2tpbmdJZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIEdldCBhbGwgYm9va2luZ3MgKGFkbWluIG9ubHkpXG5jb25zdCBnZXRBbGxCb29raW5ncyA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBzdGF0dXMsIHBhZ2UgPSAxLCBsaW1pdCA9IDIwLCBkZXN0aW5hdGlvbklkIH0gPSByZXEucXVlcnk7XG5cbiAgICAvLyBCdWlsZCBxdWVyeVxuICAgIGNvbnN0IHF1ZXJ5ID0ge307XG4gICAgaWYgKHN0YXR1cykge1xuICAgICAgcXVlcnkuc3RhdHVzID0gc3RhdHVzO1xuICAgIH1cbiAgICBpZiAoZGVzdGluYXRpb25JZCkge1xuICAgICAgcXVlcnkuZGVzdGluYXRpb24gPSBkZXN0aW5hdGlvbklkO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBwYWdpbmF0aW9uXG4gICAgY29uc3Qgc2tpcCA9IChwYXJzZUludChwYWdlLCAxMCkgLSAxKSAqIHBhcnNlSW50KGxpbWl0LCAxMCk7XG5cbiAgICAvLyBHZXQgYm9va2luZ3Mgd2l0aCBwYWdpbmF0aW9uXG4gICAgY29uc3QgYm9va2luZ3MgPSBhd2FpdCBCb29raW5nLmZpbmQocXVlcnkpXG4gICAgICAucG9wdWxhdGUoJ2Rlc3RpbmF0aW9uJywgJ3RpdGxlIGxvY2F0aW9uJylcbiAgICAgIC5wb3B1bGF0ZSgndXNlcicsICduYW1lIGVtYWlsJylcbiAgICAgIC5zb3J0KHsgY3JlYXRlZEF0OiAtMSB9KVxuICAgICAgLnNraXAoc2tpcClcbiAgICAgIC5saW1pdChwYXJzZUludChsaW1pdCwgMTApKTtcblxuICAgIC8vIEdldCB0b3RhbCBjb3VudFxuICAgIGNvbnN0IHRvdGFsID0gYXdhaXQgQm9va2luZy5jb3VudERvY3VtZW50cyhxdWVyeSk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBib29raW5ncyxcbiAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgIGN1cnJlbnQ6IHBhcnNlSW50KHBhZ2UsIDEwKSxcbiAgICAgICAgICBwYWdlczogTWF0aC5jZWlsKHRvdGFsIC8gcGFyc2VJbnQobGltaXQsIDEwKSksXG4gICAgICAgICAgdG90YWxcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBmZXRjaGluZyBhbGwgYm9va2luZ3MnLCB7IGVycm9yOiBlcnIubWVzc2FnZSB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIFVwZGF0ZSBib29raW5nIHN0YXR1cyAoYWRtaW4gb25seSlcbmNvbnN0IHVwZGF0ZUJvb2tpbmdTdGF0dXMgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgeyBzdGF0dXMgfSA9IHJlcS5ib2R5O1xuXG4gICAgY29uc3QgdmFsaWRTdGF0dXNlcyA9IFsnY29uZmlybWVkJywgJ2NhbmNlbGxlZCcsICdjb21wbGV0ZWQnLCAnbm8tc2hvdyddO1xuICAgIGlmICghdmFsaWRTdGF0dXNlcy5pbmNsdWRlcyhzdGF0dXMpKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJbnZhbGlkIGJvb2tpbmcgc3RhdHVzJyk7XG4gICAgfVxuXG4gICAgY29uc3QgYm9va2luZyA9IGF3YWl0IEJvb2tpbmcuZmluZEJ5SWQoaWQpO1xuICAgIGlmICghYm9va2luZykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ0Jvb2tpbmcgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgYm9va2luZy5zdGF0dXMgPSBzdGF0dXM7XG4gICAgYXdhaXQgYm9va2luZy5zYXZlKCk7XG5cbiAgICBpbmZvKCdCb29raW5nIHN0YXR1cyB1cGRhdGVkJywge1xuICAgICAgYm9va2luZ0lkOiBpZCxcbiAgICAgIG5ld1N0YXR1czogc3RhdHVzLFxuICAgICAgYWRtaW5JZDogcmVxLnVzZXIuaWRcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnQm9va2luZyBzdGF0dXMgdXBkYXRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgZGF0YToge1xuICAgICAgICBib29raW5nXG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIHVwZGF0aW5nIGJvb2tpbmcgc3RhdHVzJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIGJvb2tpbmdJZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIENoZWNrIGF2YWlsYWJpbGl0eSBmb3IgYSBkZXN0aW5hdGlvblxuY29uc3QgY2hlY2tBdmFpbGFiaWxpdHkgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgZGVzdGluYXRpb25JZCwgY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSB9ID0gcmVxLnF1ZXJ5O1xuXG4gICAgaWYgKCFkZXN0aW5hdGlvbklkIHx8ICFjaGVja0luRGF0ZSB8fCAhY2hlY2tPdXREYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdNaXNzaW5nIHJlcXVpcmVkIHBhcmFtZXRlcnMnKTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGVja0luID0gbmV3IERhdGUoY2hlY2tJbkRhdGUpO1xuICAgIGNvbnN0IGNoZWNrT3V0ID0gbmV3IERhdGUoY2hlY2tPdXREYXRlKTtcblxuICAgIGNvbnN0IGlzQXZhaWxhYmxlID0gYXdhaXQgQm9va2luZy5jaGVja0F2YWlsYWJpbGl0eShkZXN0aW5hdGlvbklkLCBjaGVja0luLCBjaGVja091dCk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBhdmFpbGFibGU6IGlzQXZhaWxhYmxlLFxuICAgICAgICBjaGVja0luRGF0ZTogY2hlY2tJbixcbiAgICAgICAgY2hlY2tPdXREYXRlOiBjaGVja091dFxuICAgICAgfVxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBjaGVja2luZyBhdmFpbGFiaWxpdHknLCB7IGVycm9yOiBlcnIubWVzc2FnZSB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBjcmVhdGVCb29raW5nLFxuICBnZXRVc2VyQm9va2luZ3MsXG4gIGdldEJvb2tpbmdCeUlkLFxuICBjYW5jZWxCb29raW5nLFxuICBnZXRBbGxCb29raW5ncyxcbiAgdXBkYXRlQm9va2luZ1N0YXR1cyxcbiAgY2hlY2tBdmFpbGFiaWxpdHlcbn07Il0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQztBQUN6RCxNQUFNQyxXQUFXLEdBQUdELE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQztBQUNqRSxNQUFNO0VBQUVFLGVBQWU7RUFBRUMsYUFBYTtFQUFFQztBQUFjLENBQUMsR0FBR0osT0FBTyxDQUFDLGlCQUFpQixDQUFDO0FBQ3BGLE1BQU07RUFBRUs7QUFBZ0IsQ0FBQyxHQUFH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