{"version":3,"names":["userRepository","require","ValidationError","UnauthorizedError","NotFoundError","ConflictError","redisUtils","COUNTRIES","BaseService","UserService","register","userData","email","password","name","dateOfBirth","nationality","existingUser","findByEmail","formattedDateOfBirth","Date","undefined","user","create","token","generateAuthToken","login","credentials","findByEmailWithPassword","comparePassword","getProfile","userId","findById","select","lean","age","calculateAge","country","find","c","countryCode","code","updateProfile","updateData","filteredData","filterAllowedFields","updatedUser","updateById","updatePassword","passwordData","currentPassword","newPassword","deleteAccount","softDelete","clearUserCache","getAllUsers","options","page","limit","active","result","findActiveWithPagination","toggleFavorite","destinationId","isFavorite","favorites","getFavorites","today","birthDate","getFullYear","monthDiff","getMonth","getDate","obj","allowedFields","newObj","Object","keys","forEach","el","includes","cacheKeys","Promise","all","map","key","deleteCachedData","error","console","warn","message","getUserById","cacheKey","getCachedData","cacheData","module","exports"],"sources":["user.service.js"],"sourcesContent":["const userRepository = require('../repositories/user.repository');\nconst { ValidationError, UnauthorizedError, NotFoundError, ConflictError } = require('../utils/errors');\nconst { redisUtils } = require('../middleware/redisCache');\nconst COUNTRIES = require('../utils/countries');\nconst BaseService = require('./base.service');\n\nclass UserService extends BaseService {\n  /**\n   * Register a new user\n   * @param {Object} userData - User registration data\n   * @returns {Promise<Object>} User and token\n   */\n  async register(userData) {\n    const { email, password, name, dateOfBirth, nationality } = userData;\n\n    // Check if user already exists\n    const existingUser = await userRepository.findByEmail(email);\n    if (existingUser) {\n      throw new ConflictError('Email already registered');\n    }\n\n    // Format dateOfBirth to handle timezone issues\n    const formattedDateOfBirth = dateOfBirth ? new Date(dateOfBirth) : undefined;\n\n    // Create new user\n    const user = await userRepository.create({\n      email,\n      password,\n      name,\n      dateOfBirth: formattedDateOfBirth,\n      nationality\n    });\n\n    // Generate token\n    const token = user.generateAuthToken();\n\n    // Remove password from output\n    user.password = undefined;\n\n    return { user, token };\n  }\n\n  /**\n   * Login user\n   * @param {Object} credentials - Login credentials\n   * @returns {Promise<Object>} User and token\n   */\n  async login(credentials) {\n    const { email, password } = credentials;\n\n    // Check if email and password exist\n    if (!email || !password) {\n      throw new ValidationError('Please provide email and password');\n    }\n\n    // Check if user exists && password is correct\n    const user = await userRepository.findByEmailWithPassword(email);\n\n    if (!user || !(await user.comparePassword(password))) {\n      throw new UnauthorizedError('Invalid credentials');\n    }\n\n    // Generate token\n    const token = user.generateAuthToken();\n\n    // Remove password from output\n    user.password = undefined;\n\n    return { user, token };\n  }\n\n  /**\n   * Get user profile by ID\n   * @param {string} userId - User ID\n   * @returns {Promise<Object>} User profile with computed fields\n   */\n  async getProfile(userId) {\n    const user = await userRepository.findById(userId, {\n      select: '-password',\n      lean: true\n    });\n\n    if (!user) {\n      throw new NotFoundError('User not found');\n    }\n\n    // Calculate age if dateOfBirth exists\n    if (user.dateOfBirth) {\n      user.age = this.calculateAge(user.dateOfBirth);\n    }\n\n    // Get country code if nationality exists\n    if (user.nationality) {\n      const country = COUNTRIES.find(c => c.name === user.nationality);\n      if (country) {\n        user.countryCode = country.code;\n      }\n    }\n\n    return user;\n  }\n\n  /**\n   * Update user profile\n   * @param {string} userId - User ID\n   * @param {Object} updateData - Data to update\n   * @returns {Promise<Object>} Updated user profile\n   */\n  async updateProfile(userId, updateData) {\n    // Don't allow password updates here\n    if (updateData.password) {\n      throw new ValidationError(\n        'This route is not for password updates. Please use /auth/update-password'\n      );\n    }\n\n    // Filter out unwanted fields that are not allowed to be updated\n    const filteredData = this.filterAllowedFields(updateData, 'name', 'email', 'dateOfBirth', 'nationality');\n\n    const updatedUser = await userRepository.updateById(userId, filteredData, {\n      select: '-password'\n    });\n\n    // Calculate age if dateOfBirth exists\n    if (updatedUser.dateOfBirth) {\n      updatedUser.age = this.calculateAge(updatedUser.dateOfBirth);\n    }\n\n    // Get country code if nationality exists\n    if (updatedUser.nationality) {\n      const country = COUNTRIES.find(c => c.name === updatedUser.nationality);\n      if (country) {\n        updatedUser.countryCode = country.code;\n      }\n    }\n\n    return updatedUser;\n  }\n\n  /**\n   * Update user password\n   * @param {string} userId - User ID\n   * @param {Object} passwordData - Current and new password\n   * @returns {Promise<Object>} New token\n   */\n  async updatePassword(userId, passwordData) {\n    const { currentPassword, newPassword } = passwordData;\n\n    if (!currentPassword || !newPassword) {\n      throw new ValidationError('Please provide current and new password');\n    }\n\n    const user = await userRepository.findById(userId, { select: '+password' });\n\n    if (!user) {\n      throw new NotFoundError('User not found');\n    }\n\n    if (!(await user.comparePassword(currentPassword))) {\n      throw new UnauthorizedError('Current password is incorrect');\n    }\n\n    await userRepository.updatePassword(userId, newPassword);\n\n    // Get updated user to generate new token\n    const updatedUser = await userRepository.findById(userId);\n    const token = updatedUser.generateAuthToken();\n\n    return { token };\n  }\n\n  /**\n   * Delete user account (soft delete)\n   * @param {string} userId - User ID\n   * @returns {Promise<void>}\n   */\n  async deleteAccount(userId) {\n    await userRepository.softDelete(userId);\n\n    // Clear user-related cache\n    await this.clearUserCache(userId);\n  }\n\n  /**\n   * Get all users (admin only)\n   * @param {Object} options - Query options\n   * @returns {Promise<Array>} List of users\n   */\n  async getAllUsers(options = {}) {\n    const { page = 1, limit = 10, active = true } = options;\n\n    const result = await userRepository.findActiveWithPagination({}, {\n      page,\n      limit,\n      select: '-password'\n    });\n\n    return result;\n  }\n\n  /**\n   * Toggle favorite destination\n   * @param {string} userId - User ID\n   * @param {string} destinationId - Destination ID\n   * @returns {Promise<Object>} Updated favorites\n   */\n  async toggleFavorite(userId, destinationId) {\n    if (!destinationId) {\n      throw new ValidationError('Destination ID is required');\n    }\n\n    const result = await userRepository.toggleFavorite(userId, destinationId);\n\n    // Clear user cache\n    await this.clearUserCache(userId);\n\n    return {\n      isFavorite: result.isFavorite,\n      favorites: result.user.favorites\n    };\n  }\n\n  /**\n   * Get user's favorite destinations\n   * @param {string} userId - User ID\n   * @returns {Promise<Array>} Favorite destinations\n   */\n  async getFavorites(userId) {\n    return await userRepository.getFavorites(userId);\n  }\n\n  /**\n   * Calculate age from date of birth\n   * @param {Date} dateOfBirth - Date of birth\n   * @returns {number} Age\n   */\n  calculateAge(dateOfBirth) {\n    const today = new Date();\n    const birthDate = new Date(dateOfBirth);\n    let age = today.getFullYear() - birthDate.getFullYear();\n    const monthDiff = today.getMonth() - birthDate.getMonth();\n\n    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {\n      age--;\n    }\n\n    return age;\n  }\n\n  /**\n   * Filter object to only include allowed fields\n   * @param {Object} obj - Object to filter\n   * @param {...string} allowedFields - Allowed field names\n   * @returns {Object} Filtered object\n   */\n  filterAllowedFields(obj, ...allowedFields) {\n    const newObj = {};\n    Object.keys(obj).forEach((el) => {\n      if (allowedFields.includes(el)) {\n        newObj[el] = obj[el];\n      }\n    });\n    return newObj;\n  }\n\n  /**\n   * Clear user-related cache\n   * @param {string} userId - User ID\n   * @returns {Promise<void>}\n   */\n  async clearUserCache(userId) {\n    try {\n      const cacheKeys = [\n        `user:${userId}`,\n        `user:profile:${userId}`,\n        `user:favorites:${userId}`\n      ];\n\n      await Promise.all(\n        cacheKeys.map(key => this.deleteCachedData(key))\n      );\n    } catch (error) {\n      // Log error but don't throw - cache clearing is not critical\n      console.warn('Failed to clear user cache:', error.message);\n    }\n  }\n\n  /**\n   * Get user by ID with caching\n   * @param {string} userId - User ID\n   * @returns {Promise<Object>} User data\n   */\n  async getUserById(userId) {\n    const cacheKey = `user:${userId}`;\n\n    try {\n      // Try to get from cache first\n      let user = await this.getCachedData(cacheKey);\n\n      if (!user) {\n        user = await userRepository.findById(userId, {\n          select: '-password',\n          lean: true\n        });\n\n        if (user) {\n          // Cache for 15 minutes\n          await this.cacheData(cacheKey, user, 900);\n        }\n      }\n\n      return user;\n    } catch (error) {\n      // If cache fails, fall back to database\n      return await userRepository.findById(userId, {\n        select: '-password',\n        lean: true\n      });\n    }\n  }\n}\n\nmodule.exports = new UserService();"],"mappings":"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","ignoreList":[]}