ac2e40f991aa8f4b09786e018506a331
const Notification = require('../models/notification.model');
const {
  ValidationError,
  NotFoundError
} = require('../utils/errors');
const {
  successResponse
} = require('../utils/response');
const {
  info,
  error
} = require('../utils/logger');

// Get user's notifications
const getUserNotifications = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const {
      page = 1,
      limit = 20,
      type,
      isRead,
      priority
    } = req.query;

    // Build query
    const query = {
      user: userId
    };
    if (type) {
      query.type = type;
    }
    if (isRead !== undefined) {
      query.isRead = isRead === 'true';
    }
    if (priority) {
      query.priority = priority;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get notifications with pagination
    const notifications = await Notification.find(query).populate('booking', 'bookingReference checkInDate checkOutDate').populate('destination', 'title location imageUrl').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count
    const total = await Notification.countDocuments(query);

    // Get unread count
    const unreadCount = await Notification.getUnreadCount(userId);
    res.json(successResponse({
      notifications,
      unreadCount,
      pagination: {
        current: parseInt(page, 10),
        pages: Math.ceil(total / parseInt(limit, 10)),
        total
      }
    }, 'Notifications retrieved successfully'));
  } catch (err) {
    error('Error fetching notifications', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Mark notifications as read
const markNotificationsAsRead = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const {
      notificationIds
    } = req.body;

    // If no specific IDs provided, mark all as read
    const result = await Notification.markAsRead(userId, notificationIds);
    info('Notifications marked as read', {
      userId,
      notificationIds,
      modifiedCount: result.modifiedCount
    });
    res.json(successResponse({
      modifiedCount: result.modifiedCount
    }, 'Notifications marked as read successfully'));
  } catch (err) {
    error('Error marking notifications as read', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Delete notifications
const deleteNotifications = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const {
      notificationIds
    } = req.body;
    if (!notificationIds || notificationIds.length === 0) {
      throw new ValidationError('Notification IDs are required');
    }
    const result = await Notification.deleteMany({
      _id: {
        $in: notificationIds
      },
      user: userId
    });
    info('Notifications deleted', {
      userId,
      notificationIds,
      deletedCount: result.deletedCount
    });
    res.json(successResponse({
      deletedCount: result.deletedCount
    }, 'Notifications deleted successfully'));
  } catch (err) {
    error('Error deleting notifications', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Get notification by ID
const getNotificationById = async (req, res, next) => {
  try {
    const {
      notificationId
    } = req.params;
    const userId = req.user.id;
    const notification = await Notification.findOne({
      _id: notificationId,
      user: userId
    }).populate('booking', 'bookingReference checkInDate checkOutDate totalAmount').populate('destination', 'title location imageUrl');
    if (!notification) {
      throw new NotFoundError('Notification not found');
    }

    // Mark as read if not already read
    if (!notification.isRead) {
      notification.isRead = true;
      notification.readAt = new Date();
      await notification.save();
    }
    res.json(successResponse({
      notification
    }, 'Notification retrieved successfully'));
  } catch (err) {
    error('Error fetching notification', {
      error: err.message,
      notificationId: req.params.notificationId
    });
    next(err);
  }
};

// Get notification statistics
const getNotificationStats = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const stats = await Notification.aggregate([{
      $match: {
        user: userId
      }
    }, {
      $group: {
        _id: null,
        total: {
          $sum: 1
        },
        unread: {
          $sum: {
            $cond: [{
              $eq: ['$isRead', false]
            }, 1, 0]
          }
        },
        byType: {
          $push: {
            type: '$type',
            isRead: '$isRead'
          }
        },
        byPriority: {
          $push: {
            priority: '$priority',
            isRead: '$isRead'
          }
        }
      }
    }]);
    let notificationStats = {
      total: 0,
      unread: 0,
      byType: {},
      byPriority: {}
    };
    if (stats.length > 0) {
      const stat = stats[0];
      notificationStats.total = stat.total;
      notificationStats.unread = stat.unread;

      // Calculate by type
      stat.byType.forEach(item => {
        if (!notificationStats.byType[item.type]) {
          notificationStats.byType[item.type] = {
            total: 0,
            unread: 0
          };
        }
        notificationStats.byType[item.type].total++;
        if (!item.isRead) {
          notificationStats.byType[item.type].unread++;
        }
      });

      // Calculate by priority
      stat.byPriority.forEach(item => {
        if (!notificationStats.byPriority[item.priority]) {
          notificationStats.byPriority[item.priority] = {
            total: 0,
            unread: 0
          };
        }
        notificationStats.byPriority[item.priority].total++;
        if (!item.isRead) {
          notificationStats.byPriority[item.priority].unread++;
        }
      });
    }
    res.json(successResponse({
      notificationStats
    }, 'Notification statistics retrieved successfully'));
  } catch (err) {
    error('Error fetching notification stats', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Create notification (admin only)
const createNotification = async (req, res, next) => {
  try {
    const {
      userId,
      title,
      message,
      type,
      priority = 'medium',
      actionUrl,
      actionText,
      expiresAt
    } = req.body;

    // Validate required fields
    if (!userId || !title || !message || !type) {
      throw new ValidationError('Missing required notification information');
    }
    const notification = await Notification.createNotification({
      user: userId,
      title,
      message,
      type,
      priority,
      actionUrl,
      actionText,
      expiresAt: expiresAt ? new Date(expiresAt) : undefined
    });
    info('Notification created', {
      notificationId: notification._id,
      userId,
      type,
      priority
    });
    res.status(201).json(successResponse({
      notification
    }, 'Notification created successfully'));
  } catch (err) {
    error('Error creating notification', {
      error: err.message
    });
    next(err);
  }
};

// Get all notifications (admin only)
const getAllNotifications = async (req, res, next) => {
  try {
    const {
      page = 1,
      limit = 20,
      userId,
      type,
      isRead,
      priority
    } = req.query;

    // Build query
    const query = {};
    if (userId) {
      query.user = userId;
    }
    if (type) {
      query.type = type;
    }
    if (isRead !== undefined) {
      query.isRead = isRead === 'true';
    }
    if (priority) {
      query.priority = priority;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get notifications with pagination
    const notifications = await Notification.find(query).populate('user', 'name email').populate('booking', 'bookingReference').populate('destination', 'title location').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count
    const total = await Notification.countDocuments(query);
    res.json(successResponse({
      notifications,
      pagination: {
        current: parseInt(page, 10),
        pages: Math.ceil(total / parseInt(limit, 10)),
        total
      }
    }, 'All notifications retrieved successfully'));
  } catch (err) {
    error('Error fetching all notifications', {
      error: err.message
    });
    next(err);
  }
};

// Helper function to create system notifications
const createSystemNotification = async (userId, type, title, message, options = {}) => {
  try {
    const notification = await Notification.createNotification({
      user: userId,
      title,
      message,
      type,
      priority: options.priority || 'medium',
      actionUrl: options.actionUrl,
      actionText: options.actionText,
      expiresAt: options.expiresAt ? new Date(options.expiresAt) : undefined
    });
    info('System notification created', {
      notificationId: notification._id,
      userId,
      type
    });
    return notification;
  } catch (err) {
    error('Error creating system notification', {
      error: err.message,
      userId,
      type
    });
    throw err;
  }
};
module.exports = {
  getUserNotifications,
  markNotificationsAsRead,
  deleteNotifications,
  getNotificationById,
  getNotificationStats,
  createNotification,
  getAllNotifications,
  createSystemNotification
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOb3RpZmljYXRpb24iLCJyZXF1aXJlIiwiVmFsaWRhdGlvbkVycm9yIiwiTm90Rm91bmRFcnJvciIsInN1Y2Nlc3NSZXNwb25zZSIsImluZm8iLCJlcnJvciIsImdldFVzZXJOb3RpZmljYXRpb25zIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJJZCIsInVzZXIiLCJpZCIsInBhZ2UiLCJsaW1pdCIsInR5cGUiLCJpc1JlYWQiLCJwcmlvcml0eSIsInF1ZXJ5IiwidW5kZWZpbmVkIiwic2tpcCIsInBhcnNlSW50Iiwibm90aWZpY2F0aW9ucyIsImZpbmQiLCJwb3B1bGF0ZSIsInNvcnQiLCJjcmVhdGVkQXQiLCJ0b3RhbCIsImNvdW50RG9jdW1lbnRzIiwidW5yZWFkQ291bnQiLCJnZXRVbnJlYWRDb3VudCIsImpzb24iLCJwYWdpbmF0aW9uIiwiY3VycmVudCIsInBhZ2VzIiwiTWF0aCIsImNlaWwiLCJlcnIiLCJtZXNzYWdlIiwibWFya05vdGlmaWNhdGlvbnNBc1JlYWQiLCJub3RpZmljYXRpb25JZHMiLCJib2R5IiwicmVzdWx0IiwibWFya0FzUmVhZCIsIm1vZGlmaWVkQ291bnQiLCJkZWxldGVOb3RpZmljYXRpb25zIiwibGVuZ3RoIiwiZGVsZXRlTWFueSIsIl9pZCIsIiRpbiIsImRlbGV0ZWRDb3VudCIsImdldE5vdGlmaWNhdGlvbkJ5SWQiLCJub3RpZmljYXRpb25JZCIsInBhcmFtcyIsIm5vdGlmaWNhdGlvbiIsImZpbmRPbmUiLCJyZWFkQXQiLCJEYXRlIiwic2F2ZSIsImdldE5vdGlmaWNhdGlvblN0YXRzIiwic3RhdHMiLCJhZ2dyZWdhdGUiLCIkbWF0Y2giLCIkZ3JvdXAiLCIkc3VtIiwidW5yZWFkIiwiJGNvbmQiLCIkZXEiLCJieVR5cGUiLCIkcHVzaCIsImJ5UHJpb3JpdHkiLCJub3RpZmljYXRpb25TdGF0cyIsInN0YXQiLCJmb3JFYWNoIiwiaXRlbSIsImNyZWF0ZU5vdGlmaWNhdGlvbiIsInRpdGxlIiwiYWN0aW9uVXJsIiwiYWN0aW9uVGV4dCIsImV4cGlyZXNBdCIsInN0YXR1cyIsImdldEFsbE5vdGlmaWNhdGlvbnMiLCJjcmVhdGVTeXN0ZW1Ob3RpZmljYXRpb24iLCJvcHRpb25zIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIm5vdGlmaWNhdGlvbi5jb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IE5vdGlmaWNhdGlvbiA9IHJlcXVpcmUoJy4uL21vZGVscy9ub3RpZmljYXRpb24ubW9kZWwnKTtcbmNvbnN0IHsgVmFsaWRhdGlvbkVycm9yLCBOb3RGb3VuZEVycm9yIH0gPSByZXF1aXJlKCcuLi91dGlscy9lcnJvcnMnKTtcbmNvbnN0IHsgc3VjY2Vzc1Jlc3BvbnNlIH0gPSByZXF1aXJlKCcuLi91dGlscy9yZXNwb25zZScpO1xuY29uc3QgeyBpbmZvLCBlcnJvciB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbG9nZ2VyJyk7XG5cbi8vIEdldCB1c2VyJ3Mgbm90aWZpY2F0aW9uc1xuY29uc3QgZ2V0VXNlck5vdGlmaWNhdGlvbnMgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyLmlkO1xuICAgIGNvbnN0IHsgcGFnZSA9IDEsIGxpbWl0ID0gMjAsIHR5cGUsIGlzUmVhZCwgcHJpb3JpdHkgfSA9IHJlcS5xdWVyeTtcblxuICAgIC8vIEJ1aWxkIHF1ZXJ5XG4gICAgY29uc3QgcXVlcnkgPSB7IHVzZXI6IHVzZXJJZCB9O1xuICAgIGlmICh0eXBlKSB7XG4gICAgICBxdWVyeS50eXBlID0gdHlwZTtcbiAgICB9XG4gICAgaWYgKGlzUmVhZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBxdWVyeS5pc1JlYWQgPSBpc1JlYWQgPT09ICd0cnVlJztcbiAgICB9XG4gICAgaWYgKHByaW9yaXR5KSB7XG4gICAgICBxdWVyeS5wcmlvcml0eSA9IHByaW9yaXR5O1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBwYWdpbmF0aW9uXG4gICAgY29uc3Qgc2tpcCA9IChwYXJzZUludChwYWdlLCAxMCkgLSAxKSAqIHBhcnNlSW50KGxpbWl0LCAxMCk7XG5cbiAgICAvLyBHZXQgbm90aWZpY2F0aW9ucyB3aXRoIHBhZ2luYXRpb25cbiAgICBjb25zdCBub3RpZmljYXRpb25zID0gYXdhaXQgTm90aWZpY2F0aW9uLmZpbmQocXVlcnkpXG4gICAgICAucG9wdWxhdGUoJ2Jvb2tpbmcnLCAnYm9va2luZ1JlZmVyZW5jZSBjaGVja0luRGF0ZSBjaGVja091dERhdGUnKVxuICAgICAgLnBvcHVsYXRlKCdkZXN0aW5hdGlvbicsICd0aXRsZSBsb2NhdGlvbiBpbWFnZVVybCcpXG4gICAgICAuc29ydCh7IGNyZWF0ZWRBdDogLTEgfSlcbiAgICAgIC5za2lwKHNraXApXG4gICAgICAubGltaXQocGFyc2VJbnQobGltaXQsIDEwKSk7XG5cbiAgICAvLyBHZXQgdG90YWwgY291bnRcbiAgICBjb25zdCB0b3RhbCA9IGF3YWl0IE5vdGlmaWNhdGlvbi5jb3VudERvY3VtZW50cyhxdWVyeSk7XG5cbiAgICAvLyBHZXQgdW5yZWFkIGNvdW50XG4gICAgY29uc3QgdW5yZWFkQ291bnQgPSBhd2FpdCBOb3RpZmljYXRpb24uZ2V0VW5yZWFkQ291bnQodXNlcklkKTtcblxuICAgIHJlcy5qc29uKFxuICAgICAgc3VjY2Vzc1Jlc3BvbnNlKFxuICAgICAgICB7XG4gICAgICAgICAgbm90aWZpY2F0aW9ucyxcbiAgICAgICAgICB1bnJlYWRDb3VudCxcbiAgICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgICBjdXJyZW50OiBwYXJzZUludChwYWdlLCAxMCksXG4gICAgICAgICAgICBwYWdlczogTWF0aC5jZWlsKHRvdGFsIC8gcGFyc2VJbnQobGltaXQsIDEwKSksXG4gICAgICAgICAgICB0b3RhbFxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgJ05vdGlmaWNhdGlvbnMgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseSdcbiAgICAgIClcbiAgICApO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBmZXRjaGluZyBub3RpZmljYXRpb25zJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIHVzZXJJZDogcmVxLnVzZXI/LmlkIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gTWFyayBub3RpZmljYXRpb25zIGFzIHJlYWRcbmNvbnN0IG1hcmtOb3RpZmljYXRpb25zQXNSZWFkID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcbiAgICBjb25zdCB7IG5vdGlmaWNhdGlvbklkcyB9ID0gcmVxLmJvZHk7XG5cbiAgICAvLyBJZiBubyBzcGVjaWZpYyBJRHMgcHJvdmlkZWQsIG1hcmsgYWxsIGFzIHJlYWRcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBOb3RpZmljYXRpb24ubWFya0FzUmVhZCh1c2VySWQsIG5vdGlmaWNhdGlvbklkcyk7XG5cbiAgICBpbmZvKCdOb3RpZmljYXRpb25zIG1hcmtlZCBhcyByZWFkJywge1xuICAgICAgdXNlcklkLFxuICAgICAgbm90aWZpY2F0aW9uSWRzLFxuICAgICAgbW9kaWZpZWRDb3VudDogcmVzdWx0Lm1vZGlmaWVkQ291bnRcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKFxuICAgICAgc3VjY2Vzc1Jlc3BvbnNlKFxuICAgICAgICB7XG4gICAgICAgICAgbW9kaWZpZWRDb3VudDogcmVzdWx0Lm1vZGlmaWVkQ291bnRcbiAgICAgICAgfSxcbiAgICAgICAgJ05vdGlmaWNhdGlvbnMgbWFya2VkIGFzIHJlYWQgc3VjY2Vzc2Z1bGx5J1xuICAgICAgKVxuICAgICk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIG1hcmtpbmcgbm90aWZpY2F0aW9ucyBhcyByZWFkJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIHVzZXJJZDogcmVxLnVzZXI/LmlkIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gRGVsZXRlIG5vdGlmaWNhdGlvbnNcbmNvbnN0IGRlbGV0ZU5vdGlmaWNhdGlvbnMgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyLmlkO1xuICAgIGNvbnN0IHsgbm90aWZpY2F0aW9uSWRzIH0gPSByZXEuYm9keTtcblxuICAgIGlmICghbm90aWZpY2F0aW9uSWRzIHx8IG5vdGlmaWNhdGlvbklkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ05vdGlmaWNhdGlvbiBJRHMgYXJlIHJlcXVpcmVkJyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgTm90aWZpY2F0aW9uLmRlbGV0ZU1hbnkoe1xuICAgICAgX2lkOiB7ICRpbjogbm90aWZpY2F0aW9uSWRzIH0sXG4gICAgICB1c2VyOiB1c2VySWRcbiAgICB9KTtcblxuICAgIGluZm8oJ05vdGlmaWNhdGlvbnMgZGVsZXRlZCcsIHtcbiAgICAgIHVzZXJJZCxcbiAgICAgIG5vdGlmaWNhdGlvbklkcyxcbiAgICAgIGRlbGV0ZWRDb3VudDogcmVzdWx0LmRlbGV0ZWRDb3VudFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oXG4gICAgICBzdWNjZXNzUmVzcG9uc2UoXG4gICAgICAgIHtcbiAgICAgICAgICBkZWxldGVkQ291bnQ6IHJlc3VsdC5kZWxldGVkQ291bnRcbiAgICAgICAgfSxcbiAgICAgICAgJ05vdGlmaWNhdGlvbnMgZGVsZXRlZCBzdWNjZXNzZnVsbHknXG4gICAgICApXG4gICAgKTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgZGVsZXRpbmcgbm90aWZpY2F0aW9ucycsIHsgZXJyb3I6IGVyci5tZXNzYWdlLCB1c2VySWQ6IHJlcS51c2VyPy5pZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIEdldCBub3RpZmljYXRpb24gYnkgSURcbmNvbnN0IGdldE5vdGlmaWNhdGlvbkJ5SWQgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgbm90aWZpY2F0aW9uSWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG5cbiAgICBjb25zdCBub3RpZmljYXRpb24gPSBhd2FpdCBOb3RpZmljYXRpb24uZmluZE9uZSh7XG4gICAgICBfaWQ6IG5vdGlmaWNhdGlvbklkLFxuICAgICAgdXNlcjogdXNlcklkXG4gICAgfSlcbiAgICAgIC5wb3B1bGF0ZSgnYm9va2luZycsICdib29raW5nUmVmZXJlbmNlIGNoZWNrSW5EYXRlIGNoZWNrT3V0RGF0ZSB0b3RhbEFtb3VudCcpXG4gICAgICAucG9wdWxhdGUoJ2Rlc3RpbmF0aW9uJywgJ3RpdGxlIGxvY2F0aW9uIGltYWdlVXJsJyk7XG5cbiAgICBpZiAoIW5vdGlmaWNhdGlvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ05vdGlmaWNhdGlvbiBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICAvLyBNYXJrIGFzIHJlYWQgaWYgbm90IGFscmVhZHkgcmVhZFxuICAgIGlmICghbm90aWZpY2F0aW9uLmlzUmVhZCkge1xuICAgICAgbm90aWZpY2F0aW9uLmlzUmVhZCA9IHRydWU7XG4gICAgICBub3RpZmljYXRpb24ucmVhZEF0ID0gbmV3IERhdGUoKTtcbiAgICAgIGF3YWl0IG5vdGlmaWNhdGlvbi5zYXZlKCk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oXG4gICAgICBzdWNjZXNzUmVzcG9uc2UoXG4gICAgICAgIHsgbm90aWZpY2F0aW9uIH0sXG4gICAgICAgICdOb3RpZmljYXRpb24gcmV0cmlldmVkIHN1Y2Nlc3NmdWxseSdcbiAgICAgIClcbiAgICApO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBmZXRjaGluZyBub3RpZmljYXRpb24nLCB7IGVycm9yOiBlcnIubWVzc2FnZSwgbm90aWZpY2F0aW9uSWQ6IHJlcS5wYXJhbXMubm90aWZpY2F0aW9uSWQgfSk7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG4vLyBHZXQgbm90aWZpY2F0aW9uIHN0YXRpc3RpY3NcbmNvbnN0IGdldE5vdGlmaWNhdGlvblN0YXRzID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcblxuICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgTm90aWZpY2F0aW9uLmFnZ3JlZ2F0ZShbXG4gICAgICB7ICRtYXRjaDogeyB1c2VyOiB1c2VySWQgfSB9LFxuICAgICAge1xuICAgICAgICAkZ3JvdXA6IHtcbiAgICAgICAgICBfaWQ6IG51bGwsXG4gICAgICAgICAgdG90YWw6IHsgJHN1bTogMSB9LFxuICAgICAgICAgIHVucmVhZDoge1xuICAgICAgICAgICAgJHN1bTogeyAkY29uZDogW3sgJGVxOiBbJyRpc1JlYWQnLCBmYWxzZV0gfSwgMSwgMF0gfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgYnlUeXBlOiB7XG4gICAgICAgICAgICAkcHVzaDoge1xuICAgICAgICAgICAgICB0eXBlOiAnJHR5cGUnLFxuICAgICAgICAgICAgICBpc1JlYWQ6ICckaXNSZWFkJ1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgYnlQcmlvcml0eToge1xuICAgICAgICAgICAgJHB1c2g6IHtcbiAgICAgICAgICAgICAgcHJpb3JpdHk6ICckcHJpb3JpdHknLFxuICAgICAgICAgICAgICBpc1JlYWQ6ICckaXNSZWFkJ1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIF0pO1xuXG4gICAgbGV0IG5vdGlmaWNhdGlvblN0YXRzID0ge1xuICAgICAgdG90YWw6IDAsXG4gICAgICB1bnJlYWQ6IDAsXG4gICAgICBieVR5cGU6IHt9LFxuICAgICAgYnlQcmlvcml0eToge31cbiAgICB9O1xuXG4gICAgaWYgKHN0YXRzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHN0YXQgPSBzdGF0c1swXTtcbiAgICAgIG5vdGlmaWNhdGlvblN0YXRzLnRvdGFsID0gc3RhdC50b3RhbDtcbiAgICAgIG5vdGlmaWNhdGlvblN0YXRzLnVucmVhZCA9IHN0YXQudW5yZWFkO1xuXG4gICAgICAvLyBDYWxjdWxhdGUgYnkgdHlwZVxuICAgICAgc3RhdC5ieVR5cGUuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgaWYgKCFub3RpZmljYXRpb25TdGF0cy5ieVR5cGVbaXRlbS50eXBlXSkge1xuICAgICAgICAgIG5vdGlmaWNhdGlvblN0YXRzLmJ5VHlwZVtpdGVtLnR5cGVdID0geyB0b3RhbDogMCwgdW5yZWFkOiAwIH07XG4gICAgICAgIH1cbiAgICAgICAgbm90aWZpY2F0aW9uU3RhdHMuYnlUeXBlW2l0ZW0udHlwZV0udG90YWwrKztcbiAgICAgICAgaWYgKCFpdGVtLmlzUmVhZCkge1xuICAgICAgICAgIG5vdGlmaWNhdGlvblN0YXRzLmJ5VHlwZVtpdGVtLnR5cGVdLnVucmVhZCsrO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgLy8gQ2FsY3VsYXRlIGJ5IHByaW9yaXR5XG4gICAgICBzdGF0LmJ5UHJpb3JpdHkuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgaWYgKCFub3RpZmljYXRpb25TdGF0cy5ieVByaW9yaXR5W2l0ZW0ucHJpb3JpdHldKSB7XG4gICAgICAgICAgbm90aWZpY2F0aW9uU3RhdHMuYnlQcmlvcml0eVtpdGVtLnByaW9yaXR5XSA9IHsgdG90YWw6IDAsIHVucmVhZDogMCB9O1xuICAgICAgICB9XG4gICAgICAgIG5vdGlmaWNhdGlvblN0YXRzLmJ5UHJpb3JpdHlbaXRlbS5wcmlvcml0eV0udG90YWwrKztcbiAgICAgICAgaWYgKCFpdGVtLmlzUmVhZCkge1xuICAgICAgICAgIG5vdGlmaWNhdGlvblN0YXRzLmJ5UHJpb3JpdHlbaXRlbS5wcmlvcml0eV0udW5yZWFkKys7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJlcy5qc29uKFxuICAgICAgc3VjY2Vzc1Jlc3BvbnNlKFxuICAgICAgICB7IG5vdGlmaWNhdGlvblN0YXRzIH0sXG4gICAgICAgICdOb3RpZmljYXRpb24gc3RhdGlzdGljcyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5J1xuICAgICAgKVxuICAgICk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIGZldGNoaW5nIG5vdGlmaWNhdGlvbiBzdGF0cycsIHsgZXJyb3I6IGVyci5tZXNzYWdlLCB1c2VySWQ6IHJlcS51c2VyPy5pZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIENyZWF0ZSBub3RpZmljYXRpb24gKGFkbWluIG9ubHkpXG5jb25zdCBjcmVhdGVOb3RpZmljYXRpb24gPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHtcbiAgICAgIHVzZXJJZCxcbiAgICAgIHRpdGxlLFxuICAgICAgbWVzc2FnZSxcbiAgICAgIHR5cGUsXG4gICAgICBwcmlvcml0eSA9ICdtZWRpdW0nLFxuICAgICAgYWN0aW9uVXJsLFxuICAgICAgYWN0aW9uVGV4dCxcbiAgICAgIGV4cGlyZXNBdFxuICAgIH0gPSByZXEuYm9keTtcblxuICAgIC8vIFZhbGlkYXRlIHJlcXVpcmVkIGZpZWxkc1xuICAgIGlmICghdXNlcklkIHx8ICF0aXRsZSB8fCAhbWVzc2FnZSB8fCAhdHlwZSkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignTWlzc2luZyByZXF1aXJlZCBub3RpZmljYXRpb24gaW5mb3JtYXRpb24nKTtcbiAgICB9XG5cbiAgICBjb25zdCBub3RpZmljYXRpb24gPSBhd2FpdCBOb3RpZmljYXRpb24uY3JlYXRlTm90aWZpY2F0aW9uKHtcbiAgICAgIHVzZXI6IHVzZXJJZCxcbiAgICAgIHRpdGxlLFxuICAgICAgbWVzc2FnZSxcbiAgICAgIHR5cGUsXG4gICAgICBwcmlvcml0eSxcbiAgICAgIGFjdGlvblVybCxcbiAgICAgIGFjdGlvblRleHQsXG4gICAgICBleHBpcmVzQXQ6IGV4cGlyZXNBdCA/IG5ldyBEYXRlKGV4cGlyZXNBdCkgOiB1bmRlZmluZWRcbiAgICB9KTtcblxuICAgIGluZm8oJ05vdGlmaWNhdGlvbiBjcmVhdGVkJywge1xuICAgICAgbm90aWZpY2F0aW9uSWQ6IG5vdGlmaWNhdGlvbi5faWQsXG4gICAgICB1c2VySWQsXG4gICAgICB0eXBlLFxuICAgICAgcHJpb3JpdHlcbiAgICB9KTtcblxuICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKFxuICAgICAgc3VjY2Vzc1Jlc3BvbnNlKFxuICAgICAgICB7IG5vdGlmaWNhdGlvbiB9LFxuICAgICAgICAnTm90aWZpY2F0aW9uIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5J1xuICAgICAgKVxuICAgICk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIGNyZWF0aW5nIG5vdGlmaWNhdGlvbicsIHsgZXJyb3I6IGVyci5tZXNzYWdlIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gR2V0IGFsbCBub3RpZmljYXRpb25zIChhZG1pbiBvbmx5KVxuY29uc3QgZ2V0QWxsTm90aWZpY2F0aW9ucyA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBwYWdlID0gMSwgbGltaXQgPSAyMCwgdXNlcklkLCB0eXBlLCBpc1JlYWQsIHByaW9yaXR5IH0gPSByZXEucXVlcnk7XG5cbiAgICAvLyBCdWlsZCBxdWVyeVxuICAgIGNvbnN0IHF1ZXJ5ID0ge307XG4gICAgaWYgKHVzZXJJZCkge1xuICAgICAgcXVlcnkudXNlciA9IHVzZXJJZDtcbiAgICB9XG4gICAgaWYgKHR5cGUpIHtcbiAgICAgIHF1ZXJ5LnR5cGUgPSB0eXBlO1xuICAgIH1cbiAgICBpZiAoaXNSZWFkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHF1ZXJ5LmlzUmVhZCA9IGlzUmVhZCA9PT0gJ3RydWUnO1xuICAgIH1cbiAgICBpZiAocHJpb3JpdHkpIHtcbiAgICAgIHF1ZXJ5LnByaW9yaXR5ID0gcHJpb3JpdHk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHBhZ2luYXRpb25cbiAgICBjb25zdCBza2lwID0gKHBhcnNlSW50KHBhZ2UsIDEwKSAtIDEpICogcGFyc2VJbnQobGltaXQsIDEwKTtcblxuICAgIC8vIEdldCBub3RpZmljYXRpb25zIHdpdGggcGFnaW5hdGlvblxuICAgIGNvbnN0IG5vdGlmaWNhdGlvbnMgPSBhd2FpdCBOb3RpZmljYXRpb24uZmluZChxdWVyeSlcbiAgICAgIC5wb3B1bGF0ZSgndXNlcicsICduYW1lIGVtYWlsJylcbiAgICAgIC5wb3B1bGF0ZSgnYm9va2luZycsICdib29raW5nUmVmZXJlbmNlJylcbiAgICAgIC5wb3B1bGF0ZSgnZGVzdGluYXRpb24nLCAndGl0bGUgbG9jYXRpb24nKVxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXG4gICAgICAuc2tpcChza2lwKVxuICAgICAgLmxpbWl0KHBhcnNlSW50KGxpbWl0LCAxMCkpO1xuXG4gICAgLy8gR2V0IHRvdGFsIGNvdW50XG4gICAgY29uc3QgdG90YWwgPSBhd2FpdCBOb3RpZmljYXRpb24uY291bnREb2N1bWVudHMocXVlcnkpO1xuXG4gICAgcmVzLmpzb24oXG4gICAgICBzdWNjZXNzUmVzcG9uc2UoXG4gICAgICAgIHtcbiAgICAgICAgICBub3RpZmljYXRpb25zLFxuICAgICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICAgIGN1cnJlbnQ6IHBhcnNlSW50KHBhZ2UsIDEwKSxcbiAgICAgICAgICAgIHBhZ2VzOiBNYXRoLmNlaWwodG90YWwgLyBwYXJzZUludChsaW1pdCwgMTApKSxcbiAgICAgICAgICAgIHRvdGFsXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAnQWxsIG5vdGlmaWNhdGlvbnMgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseSdcbiAgICAgIClcbiAgICApO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBmZXRjaGluZyBhbGwgbm90aWZpY2F0aW9ucycsIHsgZXJyb3I6IGVyci5tZXNzYWdlIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNyZWF0ZSBzeXN0ZW0gbm90aWZpY2F0aW9uc1xuY29uc3QgY3JlYXRlU3lzdGVtTm90aWZpY2F0aW9uID0gYXN5bmModXNlcklkLCB0eXBlLCB0aXRsZSwgbWVzc2FnZSwgb3B0aW9ucyA9IHt9KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgbm90aWZpY2F0aW9uID0gYXdhaXQgTm90aWZpY2F0aW9uLmNyZWF0ZU5vdGlmaWNhdGlvbih7XG4gICAgICB1c2VyOiB1c2VySWQsXG4gICAgICB0aXRsZSxcbiAgICAgIG1lc3NhZ2UsXG4gICAgICB0eXBlLFxuICAgICAgcHJpb3JpdHk6IG9wdGlvbnMucHJpb3JpdHkgfHwgJ21lZGl1bScsXG4gICAgICBhY3Rpb25Vcmw6IG9wdGlvbnMuYWN0aW9uVXJsLFxuICAgICAgYWN0aW9uVGV4dDogb3B0aW9ucy5hY3Rpb25UZXh0LFxuICAgICAgZXhwaXJlc0F0OiBvcHRpb25zLmV4cGlyZXNBdCA/IG5ldyBEYXRlKG9wdGlvbnMuZXhwaXJlc0F0KSA6IHVuZGVmaW5lZFxuICAgIH0pO1xuXG4gICAgaW5mbygnU3lzdGVtIG5vdGlmaWNhdGlvbiBjcmVhdGVkJywge1xuICAgICAgbm90aWZpY2F0aW9uSWQ6IG5vdGlmaWNhdGlvbi5faWQsXG4gICAgICB1c2VySWQsXG4gICAgICB0eXBlXG4gICAgfSk7XG5cbiAgICByZXR1cm4gbm90aWZpY2F0aW9uO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgY3JlYXRpbmcgc3lzdGVtIG5vdGlmaWNhdGlvbicsIHsgZXJyb3I6IGVyci5tZXNzYWdlLCB1c2VySWQsIHR5cGUgfSk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgZ2V0VXNlck5vdGlmaWNhdGlvbnMsXG4gIG1hcmtOb3RpZmljYXRpb25zQXNSZWFkLFxuICBkZWxldGVOb3RpZmljYXRpb25zLFxuICBnZXROb3RpZmljYXRpb25CeUlkLFxuICBnZXROb3RpZmljYXRpb25TdGF0cyxcbiAgY3JlYXRlTm90aWZpY2F0aW9uLFxuICBnZXRBbGxOb3RpZmljYXRpb25zLFxuICBjcmVhdGVTeXN0ZW1Ob3RpZmljYXRpb25cbn07Il0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxZQUFZLEdBQUdDLE9BQU8sQ0FBQyw4QkFBOEIsQ0FBQztBQUM1RCxNQUFNO0VBQUVDLGVBQWU7RUFBRUM7QUFBYyxDQUFDLEdBQUdGLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQztBQUNyRSxNQUFNO0VBQUVHO0FBQWdCLENBQUMsR0FBR0gsT0FBTyxDQUFDLG1CQUFtQixDQUFDO0FBQ3hELE1BQU07RUFBRUksSUFBSTtFQUFFQztBQUFNLENBQUMsR0FBR0wsT0FBTyxDQUFDLGlCQUFpQixDQUFDOztBQUVsRDtBQUNBLE1BQU1NLG9CQUFvQixHQUFHLE1BQUFBLENBQU1DLEdBQUcsRUFBRUMsR0FBRyxFQUFFQyxJQUFJLEtBQUs7RUFDcEQsSUFBSTtJQUNGLE1BQU1DLE1BQU0sR0FBR0gsR0FBRyxDQUFDSSxJQUFJLENBQUNDLEVBQUU7SUFDMUIsTUFBTTtNQUFFQyxJQUFJLEdBQUcsQ0FBQztNQUFFQyxLQUFLLEdBQUcsRUFBRTtNQUFFQyxJQUFJO01BQUVDLE1BQU07TUFBRUM7SUFBUyxDQUFDLEdBQUdWLEdBQUcsQ0FBQ1csS0FBSzs7SUFFbEU7SUFDQSxNQUFNQSxLQUFLLEdBQUc7TUFBRVAsSUFBSSxFQUFFRDtJQUFPLENBQUM7SUFDOUIsSUFBSUssSUFBSSxFQUFFO01BQ1JHLEtBQUssQ0FBQ0gsSUFBSSxHQUFHQSxJQUFJO0lBQ25CO0lBQ0EsSUFBSUMsTUFBTSxLQUFLRyxTQUFTLEVBQUU7TUFDeEJELEtB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