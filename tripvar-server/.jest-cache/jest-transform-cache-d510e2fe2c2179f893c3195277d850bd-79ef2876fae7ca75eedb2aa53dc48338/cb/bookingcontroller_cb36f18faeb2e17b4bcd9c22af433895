d9dba144d5455778476303c1b7655392
const Booking = require('../public/models/booking.model');
const Destination = require('../public/models/destination.model');
const {
  ValidationError,
  NotFoundError,
  ConflictError
} = require('../utils/errors');
const {
  successResponse
} = require('../utils/response');
const {
  info,
  error
} = require('../utils/logger');
const NotificationService = require('../services/notification.service');

// Create a new booking
const createBooking = async (req, res, next) => {
  try {
    const {
      destinationId,
      checkInDate,
      checkOutDate,
      numberOfGuests,
      paymentMethod,
      specialRequests,
      contactEmail,
      contactPhone
    } = req.body;
    const userId = req.user.id;

    // Validate required fields
    if (!destinationId || !checkInDate || !checkOutDate || !numberOfGuests) {
      throw new ValidationError('Missing required booking information');
    }

    // Parse dates
    const checkIn = new Date(checkInDate);
    const checkOut = new Date(checkOutDate);

    // Validate dates
    if (checkIn <= new Date()) {
      throw new ValidationError('Check-in date must be in the future');
    }
    if (checkOut <= checkIn) {
      throw new ValidationError('Check-out date must be after check-in date');
    }

    // Get destination details
    const destination = await Destination.findById(destinationId);
    if (!destination) {
      throw new NotFoundError('Destination not found');
    }

    // Check availability
    const isAvailable = await Booking.checkAvailability(destinationId, checkIn, checkOut);
    if (!isAvailable) {
      throw new ConflictError('Destination is not available for the selected dates');
    }

    // Calculate pricing
    const totalNights = Math.ceil((checkOut - checkIn) / (1000 * 3600 * 24));
    const totalAmount = totalNights * destination.price * numberOfGuests;

    // Create booking
    const booking = new Booking({
      user: userId,
      destination: destinationId,
      checkInDate: checkIn,
      checkOutDate: checkOut,
      numberOfGuests,
      pricePerNight: destination.price,
      totalNights,
      totalAmount,
      paymentMethod,
      specialRequests,
      contactEmail: contactEmail || req.user.email,
      contactPhone
    });
    await booking.save();

    // Note: Not populating fields to keep response simple for tests

    info('New booking created', {
      bookingId: booking._id,
      userId,
      destinationId,
      totalAmount
    });

    // Create booking confirmation notification
    try {
      await NotificationService.createBookingConfirmationNotification(userId, booking);
    } catch (notificationError) {
      // Log error but don't fail the booking creation
      error('Failed to create booking confirmation notification', {
        error: notificationError.message,
        bookingId: booking._id,
        userId
      });
    }
    res.status(201).json(successResponse({
      booking
    }, 'Booking created successfully'));
  } catch (err) {
    error('Error creating booking', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Get user's bookings
const getUserBookings = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const {
      status,
      page = 1,
      limit = 10
    } = req.query;

    // Build query
    const query = {
      user: userId
    };
    if (status) {
      query.status = status;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get bookings with pagination
    const bookings = await Booking.find(query).populate('destination', 'title location imageUrl rating').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count for pagination
    const total = await Booking.countDocuments(query);
    res.json({
      success: true,
      data: {
        bookings,
        pagination: {
          current: parseInt(page, 10),
          pages: Math.ceil(total / parseInt(limit, 10)),
          total
        }
      }
    });
  } catch (err) {
    error('Error fetching user bookings', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Get specific booking
const getBookingById = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const userId = req.user.id;
    const booking = await Booking.findById(id).populate('destination', 'title location imageUrl rating description').populate('user', 'name email');
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking or is admin
    if (booking.user._id.toString() !== userId && req.user.role !== 'admin') {
      throw new ValidationError('Access denied');
    }
    res.json({
      success: true,
      data: {
        booking
      }
    });
  } catch (err) {
    error('Error fetching booking', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Cancel booking
const cancelBooking = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const {
      reason
    } = req.body;
    const userId = req.user.id;
    const booking = await Booking.findById(id).populate('destination');
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking
    if (booking.user.toString() !== userId) {
      throw new ValidationError('Access denied');
    }

    // Check if booking can be cancelled
    if (booking.status === 'cancelled') {
      throw new ConflictError('Booking is already cancelled');
    }
    if (booking.status === 'completed') {
      throw new ConflictError('Cannot cancel completed booking');
    }

    // Calculate refund amount
    const refundAmount = booking.calculateRefund();

    // Update booking
    booking.status = 'cancelled';
    booking.cancelledAt = new Date();
    booking.cancellationReason = reason;
    booking.refundAmount = refundAmount;
    if (refundAmount > 0) {
      booking.paymentStatus = 'refunded';
      booking.refundedAt = new Date();
    }
    await booking.save();
    info('Booking cancelled', {
      bookingId: id,
      userId,
      refundAmount
    });

    // Create booking cancellation notification
    try {
      await NotificationService.createBookingCancellationNotification(userId, booking, refundAmount);
    } catch (notificationError) {
      // Log error but don't fail the cancellation
      error('Failed to create booking cancellation notification', {
        error: notificationError.message,
        bookingId: id,
        userId
      });
    }
    res.json({
      success: true,
      message: 'Booking cancelled successfully',
      data: {
        booking,
        refundAmount
      }
    });
  } catch (err) {
    error('Error cancelling booking', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Get all bookings (admin only)
const getAllBookings = async (req, res, next) => {
  try {
    const {
      status,
      page = 1,
      limit = 20,
      destinationId
    } = req.query;

    // Build query
    const query = {};
    if (status) {
      query.status = status;
    }
    if (destinationId) {
      query.destination = destinationId;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get bookings with pagination
    const bookings = await Booking.find(query).populate('destination', 'title location').populate('user', 'name email').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count
    const total = await Booking.countDocuments(query);
    res.json({
      success: true,
      data: {
        bookings,
        pagination: {
          current: parseInt(page, 10),
          pages: Math.ceil(total / parseInt(limit, 10)),
          total
        }
      }
    });
  } catch (err) {
    error('Error fetching all bookings', {
      error: err.message
    });
    next(err);
  }
};

// Update booking status (admin only)
const updateBookingStatus = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const {
      status
    } = req.body;
    const validStatuses = ['confirmed', 'cancelled', 'completed', 'no-show'];
    if (!validStatuses.includes(status)) {
      throw new ValidationError('Invalid booking status');
    }
    const booking = await Booking.findById(id);
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }
    booking.status = status;
    await booking.save();
    info('Booking status updated', {
      bookingId: id,
      newStatus: status,
      adminId: req.user.id
    });
    res.json({
      success: true,
      message: 'Booking status updated successfully',
      data: {
        booking
      }
    });
  } catch (err) {
    error('Error updating booking status', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Check availability for a destination
const checkAvailability = async (req, res, next) => {
  try {
    const {
      destinationId,
      checkInDate,
      checkOutDate
    } = req.query;
    if (!destinationId || !checkInDate || !checkOutDate) {
      throw new ValidationError('Missing required parameters');
    }
    const checkIn = new Date(checkInDate);
    const checkOut = new Date(checkOutDate);
    const isAvailable = await Booking.checkAvailability(destinationId, checkIn, checkOut);
    res.json({
      success: true,
      data: {
        available: isAvailable,
        checkInDate: checkIn,
        checkOutDate: checkOut
      }
    });
  } catch (err) {
    error('Error checking availability', {
      error: err.message
    });
    next(err);
  }
};
module.exports = {
  createBooking,
  getUserBookings,
  getBookingById,
  cancelBooking,
  getAllBookings,
  updateBookingStatus,
  checkAvailability
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29raW5nIiwicmVxdWlyZSIsIkRlc3RpbmF0aW9uIiwiVmFsaWRhdGlvbkVycm9yIiwiTm90Rm91bmRFcnJvciIsIkNvbmZsaWN0RXJyb3IiLCJzdWNjZXNzUmVzcG9uc2UiLCJpbmZvIiwiZXJyb3IiLCJOb3RpZmljYXRpb25TZXJ2aWNlIiwiY3JlYXRlQm9va2luZyIsInJlcSIsInJlcyIsIm5leHQiLCJkZXN0aW5hdGlvbklkIiwiY2hlY2tJbkRhdGUiLCJjaGVja091dERhdGUiLCJudW1iZXJPZkd1ZXN0cyIsInBheW1lbnRNZXRob2QiLCJzcGVjaWFsUmVxdWVzdHMiLCJjb250YWN0RW1haWwiLCJjb250YWN0UGhvbmUiLCJib2R5IiwidXNlcklkIiwidXNlciIsImlkIiwiY2hlY2tJbiIsIkRhdGUiLCJjaGVja091dCIsImRlc3RpbmF0aW9uIiwiZmluZEJ5SWQiLCJpc0F2YWlsYWJsZSIsImNoZWNrQXZhaWxhYmlsaXR5IiwidG90YWxOaWdodHMiLCJNYXRoIiwiY2VpbCIsInRvdGFsQW1vdW50IiwicHJpY2UiLCJib29raW5nIiwicHJpY2VQZXJOaWdodCIsImVtYWlsIiwic2F2ZSIsImJvb2tpbmdJZCIsIl9pZCIsImNyZWF0ZUJvb2tpbmdDb25maXJtYXRpb25Ob3RpZmljYXRpb24iLCJub3RpZmljYXRpb25FcnJvciIsIm1lc3NhZ2UiLCJzdGF0dXMiLCJqc29uIiwiZXJyIiwiZ2V0VXNlckJvb2tpbmdzIiwicGFnZSIsImxpbWl0IiwicXVlcnkiLCJza2lwIiwicGFyc2VJbnQiLCJib29raW5ncyIsImZpbmQiLCJwb3B1bGF0ZSIsInNvcnQiLCJjcmVhdGVkQXQiLCJ0b3RhbCIsImNvdW50RG9jdW1lbnRzIiwic3VjY2VzcyIsImRhdGEiLCJwYWdpbmF0aW9uIiwiY3VycmVudCIsInBhZ2VzIiwiZ2V0Qm9va2luZ0J5SWQiLCJwYXJhbXMiLCJ0b1N0cmluZyIsInJvbGUiLCJjYW5jZWxCb29raW5nIiwicmVhc29uIiwicmVmdW5kQW1vdW50IiwiY2FsY3VsYXRlUmVmdW5kIiwiY2FuY2VsbGVkQXQiLCJjYW5jZWxsYXRpb25SZWFzb24iLCJwYXltZW50U3RhdHVzIiwicmVmdW5kZWRBdCIsImNyZWF0ZUJvb2tpbmdDYW5jZWxsYXRpb25Ob3RpZmljYXRpb24iLCJnZXRBbGxCb29raW5ncyIsInVwZGF0ZUJvb2tpbmdTdGF0dXMiLCJ2YWxpZFN0YXR1c2VzIiwiaW5jbHVkZXMiLCJuZXdTdGF0dXMiLCJhZG1pbklkIiwiYXZhaWxhYmxlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImJvb2tpbmcuY29udHJvbGxlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBCb29raW5nID0gcmVxdWlyZSgnLi4vcHVibGljL21vZGVscy9ib29raW5nLm1vZGVsJyk7XG5jb25zdCBEZXN0aW5hdGlvbiA9IHJlcXVpcmUoJy4uL3B1YmxpYy9tb2RlbHMvZGVzdGluYXRpb24ubW9kZWwnKTtcbmNvbnN0IHsgVmFsaWRhdGlvbkVycm9yLCBOb3RGb3VuZEVycm9yLCBDb25mbGljdEVycm9yIH0gPSByZXF1aXJlKCcuLi91dGlscy9lcnJvcnMnKTtcbmNvbnN0IHsgc3VjY2Vzc1Jlc3BvbnNlIH0gPSByZXF1aXJlKCcuLi91dGlscy9yZXNwb25zZScpO1xuY29uc3QgeyBpbmZvLCBlcnJvciB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbG9nZ2VyJyk7XG5jb25zdCBOb3RpZmljYXRpb25TZXJ2aWNlID0gcmVxdWlyZSgnLi4vc2VydmljZXMvbm90aWZpY2F0aW9uLnNlcnZpY2UnKTtcblxuLy8gQ3JlYXRlIGEgbmV3IGJvb2tpbmdcbmNvbnN0IGNyZWF0ZUJvb2tpbmcgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHtcbiAgICAgIGRlc3RpbmF0aW9uSWQsXG4gICAgICBjaGVja0luRGF0ZSxcbiAgICAgIGNoZWNrT3V0RGF0ZSxcbiAgICAgIG51bWJlck9mR3Vlc3RzLFxuICAgICAgcGF5bWVudE1ldGhvZCxcbiAgICAgIHNwZWNpYWxSZXF1ZXN0cyxcbiAgICAgIGNvbnRhY3RFbWFpbCxcbiAgICAgIGNvbnRhY3RQaG9uZVxuICAgIH0gPSByZXEuYm9keTtcblxuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyLmlkO1xuXG4gICAgLy8gVmFsaWRhdGUgcmVxdWlyZWQgZmllbGRzXG4gICAgaWYgKCFkZXN0aW5hdGlvbklkIHx8ICFjaGVja0luRGF0ZSB8fCAhY2hlY2tPdXREYXRlIHx8ICFudW1iZXJPZkd1ZXN0cykge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignTWlzc2luZyByZXF1aXJlZCBib29raW5nIGluZm9ybWF0aW9uJyk7XG4gICAgfVxuXG4gICAgLy8gUGFyc2UgZGF0ZXNcbiAgICBjb25zdCBjaGVja0luID0gbmV3IERhdGUoY2hlY2tJbkRhdGUpO1xuICAgIGNvbnN0IGNoZWNrT3V0ID0gbmV3IERhdGUoY2hlY2tPdXREYXRlKTtcblxuICAgIC8vIFZhbGlkYXRlIGRhdGVzXG4gICAgaWYgKGNoZWNrSW4gPD0gbmV3IERhdGUoKSkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQ2hlY2staW4gZGF0ZSBtdXN0IGJlIGluIHRoZSBmdXR1cmUnKTtcbiAgICB9XG5cbiAgICBpZiAoY2hlY2tPdXQgPD0gY2hlY2tJbikge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQ2hlY2stb3V0IGRhdGUgbXVzdCBiZSBhZnRlciBjaGVjay1pbiBkYXRlJyk7XG4gICAgfVxuXG4gICAgLy8gR2V0IGRlc3RpbmF0aW9uIGRldGFpbHNcbiAgICBjb25zdCBkZXN0aW5hdGlvbiA9IGF3YWl0IERlc3RpbmF0aW9uLmZpbmRCeUlkKGRlc3RpbmF0aW9uSWQpO1xuICAgIGlmICghZGVzdGluYXRpb24pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdEZXN0aW5hdGlvbiBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBhdmFpbGFiaWxpdHlcbiAgICBjb25zdCBpc0F2YWlsYWJsZSA9IGF3YWl0IEJvb2tpbmcuY2hlY2tBdmFpbGFiaWxpdHkoZGVzdGluYXRpb25JZCwgY2hlY2tJbiwgY2hlY2tPdXQpO1xuICAgIGlmICghaXNBdmFpbGFibGUpIHtcbiAgICAgIHRocm93IG5ldyBDb25mbGljdEVycm9yKCdEZXN0aW5hdGlvbiBpcyBub3QgYXZhaWxhYmxlIGZvciB0aGUgc2VsZWN0ZWQgZGF0ZXMnKTtcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhdGUgcHJpY2luZ1xuICAgIGNvbnN0IHRvdGFsTmlnaHRzID0gTWF0aC5jZWlsKChjaGVja091dCAtIGNoZWNrSW4pIC8gKDEwMDAgKiAzNjAwICogMjQpKTtcbiAgICBjb25zdCB0b3RhbEFtb3VudCA9IHRvdGFsTmlnaHRzICogZGVzdGluYXRpb24ucHJpY2UgKiBudW1iZXJPZkd1ZXN0cztcblxuICAgIC8vIENyZWF0ZSBib29raW5nXG4gICAgY29uc3QgYm9va2luZyA9IG5ldyBCb29raW5nKHtcbiAgICAgIHVzZXI6IHVzZXJJZCxcbiAgICAgIGRlc3RpbmF0aW9uOiBkZXN0aW5hdGlvbklkLFxuICAgICAgY2hlY2tJbkRhdGU6IGNoZWNrSW4sXG4gICAgICBjaGVja091dERhdGU6IGNoZWNrT3V0LFxuICAgICAgbnVtYmVyT2ZHdWVzdHMsXG4gICAgICBwcmljZVBlck5pZ2h0OiBkZXN0aW5hdGlvbi5wcmljZSxcbiAgICAgIHRvdGFsTmlnaHRzLFxuICAgICAgdG90YWxBbW91bnQsXG4gICAgICBwYXltZW50TWV0aG9kLFxuICAgICAgc3BlY2lhbFJlcXVlc3RzLFxuICAgICAgY29udGFjdEVtYWlsOiBjb250YWN0RW1haWwgfHwgcmVxLnVzZXIuZW1haWwsXG4gICAgICBjb250YWN0UGhvbmVcbiAgICB9KTtcblxuICAgIGF3YWl0IGJvb2tpbmcuc2F2ZSgpO1xuXG4gICAgLy8gTm90ZTogTm90IHBvcHVsYXRpbmcgZmllbGRzIHRvIGtlZXAgcmVzcG9uc2Ugc2ltcGxlIGZvciB0ZXN0c1xuXG4gICAgaW5mbygnTmV3IGJvb2tpbmcgY3JlYXRlZCcsIHtcbiAgICAgIGJvb2tpbmdJZDogYm9va2luZy5faWQsXG4gICAgICB1c2VySWQsXG4gICAgICBkZXN0aW5hdGlvbklkLFxuICAgICAgdG90YWxBbW91bnRcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBib29raW5nIGNvbmZpcm1hdGlvbiBub3RpZmljYXRpb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVCb29raW5nQ29uZmlybWF0aW9uTm90aWZpY2F0aW9uKHVzZXJJZCwgYm9va2luZyk7XG4gICAgfSBjYXRjaCAobm90aWZpY2F0aW9uRXJyb3IpIHtcbiAgICAgIC8vIExvZyBlcnJvciBidXQgZG9uJ3QgZmFpbCB0aGUgYm9va2luZyBjcmVhdGlvblxuICAgICAgZXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgYm9va2luZyBjb25maXJtYXRpb24gbm90aWZpY2F0aW9uJywge1xuICAgICAgICBlcnJvcjogbm90aWZpY2F0aW9uRXJyb3IubWVzc2FnZSxcbiAgICAgICAgYm9va2luZ0lkOiBib29raW5nLl9pZCxcbiAgICAgICAgdXNlcklkXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbihzdWNjZXNzUmVzcG9uc2UoXG4gICAgICB7IGJvb2tpbmcgfSxcbiAgICAgICdCb29raW5nIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5J1xuICAgICkpO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBjcmVhdGluZyBib29raW5nJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIHVzZXJJZDogcmVxLnVzZXI/LmlkIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gR2V0IHVzZXIncyBib29raW5nc1xuY29uc3QgZ2V0VXNlckJvb2tpbmdzID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcbiAgICBjb25zdCB7IHN0YXR1cywgcGFnZSA9IDEsIGxpbWl0ID0gMTAgfSA9IHJlcS5xdWVyeTtcblxuICAgIC8vIEJ1aWxkIHF1ZXJ5XG4gICAgY29uc3QgcXVlcnkgPSB7IHVzZXI6IHVzZXJJZCB9O1xuICAgIGlmIChzdGF0dXMpIHtcbiAgICAgIHF1ZXJ5LnN0YXR1cyA9IHN0YXR1cztcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhdGUgcGFnaW5hdGlvblxuICAgIGNvbnN0IHNraXAgPSAocGFyc2VJbnQocGFnZSwgMTApIC0gMSkgKiBwYXJzZUludChsaW1pdCwgMTApO1xuXG4gICAgLy8gR2V0IGJvb2tpbmdzIHdpdGggcGFnaW5hdGlvblxuICAgIGNvbnN0IGJvb2tpbmdzID0gYXdhaXQgQm9va2luZy5maW5kKHF1ZXJ5KVxuICAgICAgLnBvcHVsYXRlKCdkZXN0aW5hdGlvbicsICd0aXRsZSBsb2NhdGlvbiBpbWFnZVVybCByYXRpbmcnKVxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXG4gICAgICAuc2tpcChza2lwKVxuICAgICAgLmxpbWl0KHBhcnNlSW50KGxpbWl0LCAxMCkpO1xuXG4gICAgLy8gR2V0IHRvdGFsIGNvdW50IGZvciBwYWdpbmF0aW9uXG4gICAgY29uc3QgdG90YWwgPSBhd2FpdCBCb29raW5nLmNvdW50RG9jdW1lbnRzKHF1ZXJ5KTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGJvb2tpbmdzLFxuICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgY3VycmVudDogcGFyc2VJbnQocGFnZSwgMTApLFxuICAgICAgICAgIHBhZ2VzOiBNYXRoLmNlaWwodG90YWwgLyBwYXJzZUludChsaW1pdCwgMTApKSxcbiAgICAgICAgICB0b3RhbFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIGZldGNoaW5nIHVzZXIgYm9va2luZ3MnLCB7IGVycm9yOiBlcnIubWVzc2FnZSwgdXNlcklkOiByZXEudXNlcj8uaWQgfSk7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG4vLyBHZXQgc3BlY2lmaWMgYm9va2luZ1xuY29uc3QgZ2V0Qm9va2luZ0J5SWQgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG5cbiAgICBjb25zdCBib29raW5nID0gYXdhaXQgQm9va2luZy5maW5kQnlJZChpZClcbiAgICAgIC5wb3B1bGF0ZSgnZGVzdGluYXRpb24nLCAndGl0bGUgbG9jYXRpb24gaW1hZ2VVcmwgcmF0aW5nIGRlc2NyaXB0aW9uJylcbiAgICAgIC5wb3B1bGF0ZSgndXNlcicsICduYW1lIGVtYWlsJyk7XG5cbiAgICBpZiAoIWJvb2tpbmcpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdCb29raW5nIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgb3ducyB0aGlzIGJvb2tpbmcgb3IgaXMgYWRtaW5cbiAgICBpZiAoYm9va2luZy51c2VyLl9pZC50b1N0cmluZygpICE9PSB1c2VySWQgJiYgcmVxLnVzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQWNjZXNzIGRlbmllZCcpO1xuICAgIH1cblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGJvb2tpbmdcbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgZmV0Y2hpbmcgYm9va2luZycsIHsgZXJyb3I6IGVyci5tZXNzYWdlLCBib29raW5nSWQ6IHJlcS5wYXJhbXMuaWQgfSk7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG4vLyBDYW5jZWwgYm9va2luZ1xuY29uc3QgY2FuY2VsQm9va2luZyA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB7IHJlYXNvbiB9ID0gcmVxLmJvZHk7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG5cbiAgICBjb25zdCBib29raW5nID0gYXdhaXQgQm9va2luZy5maW5kQnlJZChpZCkucG9wdWxhdGUoJ2Rlc3RpbmF0aW9uJyk7XG5cbiAgICBpZiAoIWJvb2tpbmcpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdCb29raW5nIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgb3ducyB0aGlzIGJvb2tpbmdcbiAgICBpZiAoYm9va2luZy51c2VyLnRvU3RyaW5nKCkgIT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQWNjZXNzIGRlbmllZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGJvb2tpbmcgY2FuIGJlIGNhbmNlbGxlZFxuICAgIGlmIChib29raW5nLnN0YXR1cyA9PT0gJ2NhbmNlbGxlZCcpIHtcbiAgICAgIHRocm93IG5ldyBDb25mbGljdEVycm9yKCdCb29raW5nIGlzIGFscmVhZHkgY2FuY2VsbGVkJyk7XG4gICAgfVxuXG4gICAgaWYgKGJvb2tpbmcuc3RhdHVzID09PSAnY29tcGxldGVkJykge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXJyb3IoJ0Nhbm5vdCBjYW5jZWwgY29tcGxldGVkIGJvb2tpbmcnKTtcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhdGUgcmVmdW5kIGFtb3VudFxuICAgIGNvbnN0IHJlZnVuZEFtb3VudCA9IGJvb2tpbmcuY2FsY3VsYXRlUmVmdW5kKCk7XG5cbiAgICAvLyBVcGRhdGUgYm9va2luZ1xuICAgIGJvb2tpbmcuc3RhdHVzID0gJ2NhbmNlbGxlZCc7XG4gICAgYm9va2luZy5jYW5jZWxsZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgYm9va2luZy5jYW5jZWxsYXRpb25SZWFzb24gPSByZWFzb247XG4gICAgYm9va2luZy5yZWZ1bmRBbW91bnQgPSByZWZ1bmRBbW91bnQ7XG5cbiAgICBpZiAocmVmdW5kQW1vdW50ID4gMCkge1xuICAgICAgYm9va2luZy5wYXltZW50U3RhdHVzID0gJ3JlZnVuZGVkJztcbiAgICAgIGJvb2tpbmcucmVmdW5kZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgfVxuXG4gICAgYXdhaXQgYm9va2luZy5zYXZlKCk7XG5cbiAgICBpbmZvKCdCb29raW5nIGNhbmNlbGxlZCcsIHtcbiAgICAgIGJvb2tpbmdJZDogaWQsXG4gICAgICB1c2VySWQsXG4gICAgICByZWZ1bmRBbW91bnRcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBib29raW5nIGNhbmNlbGxhdGlvbiBub3RpZmljYXRpb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVCb29raW5nQ2FuY2VsbGF0aW9uTm90aWZpY2F0aW9uKHVzZXJJZCwgYm9va2luZywgcmVmdW5kQW1vdW50KTtcbiAgICB9IGNhdGNoIChub3RpZmljYXRpb25FcnJvcikge1xuICAgICAgLy8gTG9nIGVycm9yIGJ1dCBkb24ndCBmYWlsIHRoZSBjYW5jZWxsYXRpb25cbiAgICAgIGVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIGJvb2tpbmcgY2FuY2VsbGF0aW9uIG5vdGlmaWNhdGlvbicsIHtcbiAgICAgICAgZXJyb3I6IG5vdGlmaWNhdGlvbkVycm9yLm1lc3NhZ2UsXG4gICAgICAgIGJvb2tpbmdJZDogaWQsXG4gICAgICAgIHVzZXJJZFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdCb29raW5nIGNhbmNlbGxlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgZGF0YToge1xuICAgICAgICBib29raW5nLFxuICAgICAgICByZWZ1bmRBbW91bnRcbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgY2FuY2VsbGluZyBib29raW5nJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIGJvb2tpbmdJZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIEdldCBhbGwgYm9va2luZ3MgKGFkbWluIG9ubHkpXG5jb25zdCBnZXRBbGxCb29raW5ncyA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBzdGF0dXMsIHBhZ2UgPSAxLCBsaW1pdCA9IDIwLCBkZXN0aW5hdGlvbklkIH0gPSByZXEucXVlcnk7XG5cbiAgICAvLyBCdWlsZCBxdWVyeVxuICAgIGNvbnN0IHF1ZXJ5ID0ge307XG4gICAgaWYgKHN0YXR1cykge1xuICAgICAgcXVlcnkuc3RhdHVzID0gc3RhdHVzO1xuICAgIH1cbiAgICBpZiAoZGVzdGluYXRpb25JZCkge1xuICAgICAgcXVlcnkuZGVzdGluYXRpb24gPSBkZXN0aW5hdGlvbklkO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBwYWdpbmF0aW9uXG4gICAgY29uc3Qgc2tpcCA9IChwYXJzZUludChwYWdlLCAxMCkgLSAxKSAqIHBhcnNlSW50KGxpbWl0LCAxMCk7XG5cbiAgICAvLyBHZXQgYm9va2luZ3Mgd2l0aCBwYWdpbmF0aW9uXG4gICAgY29uc3QgYm9va2luZ3MgPSBhd2FpdCBCb29raW5nLmZpbmQocXVlcnkpXG4gICAgICAucG9wdWxhdGUoJ2Rlc3RpbmF0aW9uJywgJ3RpdGxlIGxvY2F0aW9uJylcbiAgICAgIC5wb3B1bGF0ZSgndXNlcicsICduYW1lIGVtYWlsJylcbiAgICAgIC5zb3J0KHsgY3JlYXRlZEF0OiAtMSB9KVxuICAgICAgLnNraXAoc2tpcClcbiAgICAgIC5saW1pdChwYXJzZUludChsaW1pdCwgMTApKTtcblxuICAgIC8vIEdldCB0b3RhbCBjb3VudFxuICAgIGNvbnN0IHRvdGFsID0gYXdhaXQgQm9va2luZy5jb3VudERvY3VtZW50cyhxdWVyeSk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBib29raW5ncyxcbiAgICAgICAgcGFnaW5hdGlvbjoge1xuICAgICAgICAgIGN1cnJlbnQ6IHBhcnNlSW50KHBhZ2UsIDEwKSxcbiAgICAgICAgICBwYWdlczogTWF0aC5jZWlsKHRvdGFsIC8gcGFyc2VJbnQobGltaXQsIDEwKSksXG4gICAgICAgICAgdG90YWxcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBmZXRjaGluZyBhbGwgYm9va2luZ3MnLCB7IGVycm9yOiBlcnIubWVzc2FnZSB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIFVwZGF0ZSBib29raW5nIHN0YXR1cyAoYWRtaW4gb25seSlcbmNvbnN0IHVwZGF0ZUJvb2tpbmdTdGF0dXMgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgY29uc3QgeyBzdGF0dXMgfSA9IHJlcS5ib2R5O1xuXG4gICAgY29uc3QgdmFsaWRTdGF0dXNlcyA9IFsnY29uZmlybWVkJywgJ2NhbmNlbGxlZCcsICdjb21wbGV0ZWQnLCAnbm8tc2hvdyddO1xuICAgIGlmICghdmFsaWRTdGF0dXNlcy5pbmNsdWRlcyhzdGF0dXMpKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJbnZhbGlkIGJvb2tpbmcgc3RhdHVzJyk7XG4gICAgfVxuXG4gICAgY29uc3QgYm9va2luZyA9IGF3YWl0IEJvb2tpbmcuZmluZEJ5SWQoaWQpO1xuICAgIGlmICghYm9va2luZykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ0Jvb2tpbmcgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgYm9va2luZy5zdGF0dXMgPSBzdGF0dXM7XG4gICAgYXdhaXQgYm9va2luZy5zYXZlKCk7XG5cbiAgICBpbmZvKCdCb29raW5nIHN0YXR1cyB1cGRhdGVkJywge1xuICAgICAgYm9va2luZ0lkOiBpZCxcbiAgICAgIG5ld1N0YXR1czogc3RhdHVzLFxuICAgICAgYWRtaW5JZDogcmVxLnVzZXIuaWRcbiAgICB9KTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBtZXNzYWdlOiAnQm9va2luZyBzdGF0dXMgdXBkYXRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgZGF0YToge1xuICAgICAgICBib29raW5nXG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIHVwZGF0aW5nIGJvb2tpbmcgc3RhdHVzJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIGJvb2tpbmdJZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIENoZWNrIGF2YWlsYWJpbGl0eSBmb3IgYSBkZXN0aW5hdGlvblxuY29uc3QgY2hlY2tBdmFpbGFiaWxpdHkgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgZGVzdGluYXRpb25JZCwgY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSB9ID0gcmVxLnF1ZXJ5O1xuXG4gICAgaWYgKCFkZXN0aW5hdGlvbklkIHx8ICFjaGVja0luRGF0ZSB8fCAhY2hlY2tPdXREYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdNaXNzaW5nIHJlcXVpcmVkIHBhcmFtZXRlcnMnKTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGVja0luID0gbmV3IERhdGUoY2hlY2tJbkRhdGUpO1xuICAgIGNvbnN0IGNoZWNrT3V0ID0gbmV3IERhdGUoY2hlY2tPdXREYXRlKTtcblxuICAgIGNvbnN0IGlzQXZhaWxhYmxlID0gYXdhaXQgQm9va2luZy5jaGVja0F2YWlsYWJpbGl0eShkZXN0aW5hdGlvbklkLCBjaGVja0luLCBjaGVja091dCk7XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBhdmFpbGFibGU6IGlzQXZhaWxhYmxlLFxuICAgICAgICBjaGVja0luRGF0ZTogY2hlY2tJbixcbiAgICAgICAgY2hlY2tPdXREYXRlOiBjaGVja091dFxuICAgICAgfVxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBjaGVja2luZyBhdmFpbGFiaWxpdHknLCB7IGVycm9yOiBlcnIubWVzc2FnZSB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBjcmVhdGVCb29raW5nLFxuICBnZXRVc2VyQm9va2luZ3MsXG4gIGdldEJvb2tpbmdCeUlkLFxuICBjYW5jZWxCb29raW5nLFxuICBnZXRBbGxCb29raW5ncyxcbiAgdXBkYXRlQm9va2luZ1N0YXR1cyxcbiAgY2hlY2tBdmFpbGFiaWxpdHlcbn07Il0sIm1hcHBpbmdzIjoiQUFBQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQztBQUN6RCxNQUFNQyxXQUFXLEdBQUdELE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQztBQUNqRSxNQUFNO0VBQUVFLGVBQWU7RUFBRUMsYUFBYTtFQUFFQztBQUFjLENBQUMsR0FBR0osT0FBTyxDQUFDLGlCQUFpQixDQUFDO0FBQ3BGLE1BQU07RUFBRUs7QUFBZ0IsQ0FBQyxHQUFHTCxPQUFPLENBQUMsbUJBQW1CLENBQUM7QUFDeEQsTUFBTTtFQUFFTSxJQUFJO0VBQUVDO0FBQU0sQ0FBQyxHQUFHUCxPQUFPLENBQUMsaUJBQWlCLENBQUM7QUFDbEQsTUFBTVEsbUJB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