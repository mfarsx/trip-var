e0b31de2e6c20859142c87f5c65d0959
const mongoose = require('mongoose');
const bookingSchema = new mongoose.Schema({
  // User who made the booking
  user: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: [true, 'Booking must belong to a user']
  },
  // Destination being booked
  destination: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Destination',
    required: [true, 'Booking must be for a destination']
  },
  // Booking dates
  checkInDate: {
    type: Date,
    required: [true, 'Check-in date is required'],
    validate: {
      validator: function (v) {
        // Check-in date must be in the future
        return v > new Date();
      },
      message: 'Check-in date must be in the future'
    }
  },
  checkOutDate: {
    type: Date,
    required: [true, 'Check-out date is required'],
    validate: {
      validator: function (v) {
        // Check-out date must be after check-in date
        return v > this.checkInDate;
      },
      message: 'Check-out date must be after check-in date'
    }
  },
  // Number of guests
  numberOfGuests: {
    type: Number,
    required: [true, 'Number of guests is required'],
    min: [1, 'At least 1 guest is required'],
    max: [10, 'Maximum 10 guests allowed']
  },
  // Pricing information
  pricePerNight: {
    type: Number,
    required: [true, 'Price per night is required'],
    min: [0, 'Price cannot be negative']
  },
  totalNights: {
    type: Number,
    required: true,
    min: [1, 'At least 1 night is required']
  },
  totalAmount: {
    type: Number,
    required: [true, 'Total amount is required'],
    min: [0, 'Total amount cannot be negative']
  },
  // Payment information
  paymentMethod: {
    type: String,
    required: [true, 'Payment method is required'],
    enum: {
      values: ['credit-card', 'paypal', 'bank-transfer'],
      message: 'Payment method must be credit-card, paypal, or bank-transfer'
    }
  },
  paymentStatus: {
    type: String,
    required: true,
    enum: {
      values: ['pending', 'paid', 'failed', 'refunded'],
      message: 'Payment status must be pending, paid, failed, or refunded'
    },
    default: 'pending'
  },
  paymentIntentId: {
    type: String,
    required: false // Will be set when payment is processed
  },
  // Booking status
  status: {
    type: String,
    required: true,
    enum: {
      values: ['confirmed', 'cancelled', 'completed', 'no-show'],
      message: 'Status must be confirmed, cancelled, completed, or no-show'
    },
    default: 'confirmed'
  },
  // Additional information
  specialRequests: {
    type: String,
    maxlength: [500, 'Special requests cannot exceed 500 characters'],
    required: false
  },
  // Contact information for the booking
  contactEmail: {
    type: String,
    required: [true, 'Contact email is required'],
    lowercase: true,
    trim: true,
    validate: {
      validator: function (v) {
        return /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(v);
      },
      message: 'Please provide a valid email address'
    }
  },
  contactPhone: {
    type: String,
    required: false,
    trim: true
  },
  // Cancellation information
  cancelledAt: {
    type: Date,
    required: false
  },
  cancellationReason: {
    type: String,
    required: false,
    maxlength: [200, 'Cancellation reason cannot exceed 200 characters']
  },
  // Refund information
  refundAmount: {
    type: Number,
    required: false,
    min: [0, 'Refund amount cannot be negative']
  },
  refundedAt: {
    type: Date,
    required: false
  }
}, {
  timestamps: true,
  toJSON: {
    virtuals: true
  },
  toObject: {
    virtuals: true
  }
});

// Virtual field for booking duration in days
bookingSchema.virtual('duration').get(function () {
  if (this.checkInDate && this.checkOutDate) {
    const timeDiff = this.checkOutDate.getTime() - this.checkInDate.getTime();
    return Math.ceil(timeDiff / (1000 * 3600 * 24));
  }
  return 0;
});

// Virtual field for booking reference number
bookingSchema.virtual('bookingReference').get(function () {
  return `TRV-${this._id.toString().slice(-8).toUpperCase()}`;
});

// Pre-save middleware to calculate total nights and amount
bookingSchema.pre('save', function (next) {
  if (this.checkInDate && this.checkOutDate && this.pricePerNight) {
    const timeDiff = this.checkOutDate.getTime() - this.checkInDate.getTime();
    this.totalNights = Math.ceil(timeDiff / (1000 * 3600 * 24));
    this.totalAmount = this.totalNights * this.pricePerNight * this.numberOfGuests;
  }
  next();
});

// Index for better query performance
bookingSchema.index({
  user: 1,
  createdAt: -1
});
bookingSchema.index({
  destination: 1,
  checkInDate: 1,
  checkOutDate: 1
});
bookingSchema.index({
  status: 1
});
bookingSchema.index({
  paymentStatus: 1
});

// Static method to check availability
bookingSchema.statics.checkAvailability = async function (destinationId, checkInDate, checkOutDate) {
  const existingBookings = await this.find({
    destination: destinationId,
    status: {
      $in: ['confirmed', 'completed']
    },
    $or: [{
      checkInDate: {
        $lt: checkOutDate
      },
      checkOutDate: {
        $gt: checkInDate
      }
    }]
  });
  return existingBookings.length === 0;
};

// Instance method to calculate refund amount
bookingSchema.methods.calculateRefund = function () {
  if (this.status !== 'cancelled') {
    return 0;
  }
  const now = new Date();
  const daysUntilCheckIn = Math.ceil((this.checkInDate - now) / (1000 * 3600 * 24));

  // Refund policy: 100% if cancelled 7+ days before, 50% if 3-6 days, 0% if less than 3 days
  if (daysUntilCheckIn >= 7) {
    return this.totalAmount;
  } else if (daysUntilCheckIn >= 3) {
    return this.totalAmount * 0.5;
  } else {
    return 0;
  }
};
const Booking = mongoose.model('Booking', bookingSchema);
module.exports = Booking;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJib29raW5nU2NoZW1hIiwiU2NoZW1hIiwidXNlciIsInR5cGUiLCJUeXBlcyIsIk9iamVjdElkIiwicmVmIiwicmVxdWlyZWQiLCJkZXN0aW5hdGlvbiIsImNoZWNrSW5EYXRlIiwiRGF0ZSIsInZhbGlkYXRlIiwidmFsaWRhdG9yIiwidiIsIm1lc3NhZ2UiLCJjaGVja091dERhdGUiLCJudW1iZXJPZkd1ZXN0cyIsIk51bWJlciIsIm1pbiIsIm1heCIsInByaWNlUGVyTmlnaHQiLCJ0b3RhbE5pZ2h0cyIsInRvdGFsQW1vdW50IiwicGF5bWVudE1ldGhvZCIsIlN0cmluZyIsImVudW0iLCJ2YWx1ZXMiLCJwYXltZW50U3RhdHVzIiwiZGVmYXVsdCIsInBheW1lbnRJbnRlbnRJZCIsInN0YXR1cyIsInNwZWNpYWxSZXF1ZXN0cyIsIm1heGxlbmd0aCIsImNvbnRhY3RFbWFpbCIsImxvd2VyY2FzZSIsInRyaW0iLCJ0ZXN0IiwiY29udGFjdFBob25lIiwiY2FuY2VsbGVkQXQiLCJjYW5jZWxsYXRpb25SZWFzb24iLCJyZWZ1bmRBbW91bnQiLCJyZWZ1bmRlZEF0IiwidGltZXN0YW1wcyIsInRvSlNPTiIsInZpcnR1YWxzIiwidG9PYmplY3QiLCJ2aXJ0dWFsIiwiZ2V0IiwidGltZURpZmYiLCJnZXRUaW1lIiwiTWF0aCIsImNlaWwiLCJfaWQiLCJ0b1N0cmluZyIsInNsaWNlIiwidG9VcHBlckNhc2UiLCJwcmUiLCJuZXh0IiwiaW5kZXgiLCJjcmVhdGVkQXQiLCJzdGF0aWNzIiwiY2hlY2tBdmFpbGFiaWxpdHkiLCJkZXN0aW5hdGlvbklkIiwiZXhpc3RpbmdCb29raW5ncyIsImZpbmQiLCIkaW4iLCIkb3IiLCIkbHQiLCIkZ3QiLCJsZW5ndGgiLCJtZXRob2RzIiwiY2FsY3VsYXRlUmVmdW5kIiwibm93IiwiZGF5c1VudGlsQ2hlY2tJbiIsIkJvb2tpbmciLCJtb2RlbCIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJib29raW5nLm1vZGVsLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IG1vbmdvb3NlID0gcmVxdWlyZSgnbW9uZ29vc2UnKTtcblxuY29uc3QgYm9va2luZ1NjaGVtYSA9IG5ldyBtb25nb29zZS5TY2hlbWEoXG4gIHtcbiAgICAvLyBVc2VyIHdobyBtYWRlIHRoZSBib29raW5nXG4gICAgdXNlcjoge1xuICAgICAgdHlwZTogbW9uZ29vc2UuU2NoZW1hLlR5cGVzLk9iamVjdElkLFxuICAgICAgcmVmOiAnVXNlcicsXG4gICAgICByZXF1aXJlZDogW3RydWUsICdCb29raW5nIG11c3QgYmVsb25nIHRvIGEgdXNlciddXG4gICAgfSxcblxuICAgIC8vIERlc3RpbmF0aW9uIGJlaW5nIGJvb2tlZFxuICAgIGRlc3RpbmF0aW9uOiB7XG4gICAgICB0eXBlOiBtb25nb29zZS5TY2hlbWEuVHlwZXMuT2JqZWN0SWQsXG4gICAgICByZWY6ICdEZXN0aW5hdGlvbicsXG4gICAgICByZXF1aXJlZDogW3RydWUsICdCb29raW5nIG11c3QgYmUgZm9yIGEgZGVzdGluYXRpb24nXVxuICAgIH0sXG5cbiAgICAvLyBCb29raW5nIGRhdGVzXG4gICAgY2hlY2tJbkRhdGU6IHtcbiAgICAgIHR5cGU6IERhdGUsXG4gICAgICByZXF1aXJlZDogW3RydWUsICdDaGVjay1pbiBkYXRlIGlzIHJlcXVpcmVkJ10sXG4gICAgICB2YWxpZGF0ZToge1xuICAgICAgICB2YWxpZGF0b3I6IGZ1bmN0aW9uKHYpIHtcbiAgICAgICAgICAvLyBDaGVjay1pbiBkYXRlIG11c3QgYmUgaW4gdGhlIGZ1dHVyZVxuICAgICAgICAgIHJldHVybiB2ID4gbmV3IERhdGUoKTtcbiAgICAgICAgfSxcbiAgICAgICAgbWVzc2FnZTogJ0NoZWNrLWluIGRhdGUgbXVzdCBiZSBpbiB0aGUgZnV0dXJlJ1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBjaGVja091dERhdGU6IHtcbiAgICAgIHR5cGU6IERhdGUsXG4gICAgICByZXF1aXJlZDogW3RydWUsICdDaGVjay1vdXQgZGF0ZSBpcyByZXF1aXJlZCddLFxuICAgICAgdmFsaWRhdGU6IHtcbiAgICAgICAgdmFsaWRhdG9yOiBmdW5jdGlvbih2KSB7XG4gICAgICAgICAgLy8gQ2hlY2stb3V0IGRhdGUgbXVzdCBiZSBhZnRlciBjaGVjay1pbiBkYXRlXG4gICAgICAgICAgcmV0dXJuIHYgPiB0aGlzLmNoZWNrSW5EYXRlO1xuICAgICAgICB9LFxuICAgICAgICBtZXNzYWdlOiAnQ2hlY2stb3V0IGRhdGUgbXVzdCBiZSBhZnRlciBjaGVjay1pbiBkYXRlJ1xuICAgICAgfVxuICAgIH0sXG5cbiAgICAvLyBOdW1iZXIgb2YgZ3Vlc3RzXG4gICAgbnVtYmVyT2ZHdWVzdHM6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHJlcXVpcmVkOiBbdHJ1ZSwgJ051bWJlciBvZiBndWVzdHMgaXMgcmVxdWlyZWQnXSxcbiAgICAgIG1pbjogWzEsICdBdCBsZWFzdCAxIGd1ZXN0IGlzIHJlcXVpcmVkJ10sXG4gICAgICBtYXg6IFsxMCwgJ01heGltdW0gMTAgZ3Vlc3RzIGFsbG93ZWQnXVxuICAgIH0sXG5cbiAgICAvLyBQcmljaW5nIGluZm9ybWF0aW9uXG4gICAgcHJpY2VQZXJOaWdodDoge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgcmVxdWlyZWQ6IFt0cnVlLCAnUHJpY2UgcGVyIG5pZ2h0IGlzIHJlcXVpcmVkJ10sXG4gICAgICBtaW46IFswLCAnUHJpY2UgY2Fubm90IGJlIG5lZ2F0aXZlJ11cbiAgICB9LFxuXG4gICAgdG90YWxOaWdodHM6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgbWluOiBbMSwgJ0F0IGxlYXN0IDEgbmlnaHQgaXMgcmVxdWlyZWQnXVxuICAgIH0sXG5cbiAgICB0b3RhbEFtb3VudDoge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgcmVxdWlyZWQ6IFt0cnVlLCAnVG90YWwgYW1vdW50IGlzIHJlcXVpcmVkJ10sXG4gICAgICBtaW46IFswLCAnVG90YWwgYW1vdW50IGNhbm5vdCBiZSBuZWdhdGl2ZSddXG4gICAgfSxcblxuICAgIC8vIFBheW1lbnQgaW5mb3JtYXRpb25cbiAgICBwYXltZW50TWV0aG9kOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICByZXF1aXJlZDogW3RydWUsICdQYXltZW50IG1ldGhvZCBpcyByZXF1aXJlZCddLFxuICAgICAgZW51bToge1xuICAgICAgICB2YWx1ZXM6IFsnY3JlZGl0LWNhcmQnLCAncGF5cGFsJywgJ2JhbmstdHJhbnNmZXInXSxcbiAgICAgICAgbWVzc2FnZTogJ1BheW1lbnQgbWV0aG9kIG11c3QgYmUgY3JlZGl0LWNhcmQsIHBheXBhbCwgb3IgYmFuay10cmFuc2ZlcidcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgcGF5bWVudFN0YXR1czoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IHRydWUsXG4gICAgICBlbnVtOiB7XG4gICAgICAgIHZhbHVlczogWydwZW5kaW5nJywgJ3BhaWQnLCAnZmFpbGVkJywgJ3JlZnVuZGVkJ10sXG4gICAgICAgIG1lc3NhZ2U6ICdQYXltZW50IHN0YXR1cyBtdXN0IGJlIHBlbmRpbmcsIHBhaWQsIGZhaWxlZCwgb3IgcmVmdW5kZWQnXG4gICAgICB9LFxuICAgICAgZGVmYXVsdDogJ3BlbmRpbmcnXG4gICAgfSxcblxuICAgIHBheW1lbnRJbnRlbnRJZDoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IGZhbHNlIC8vIFdpbGwgYmUgc2V0IHdoZW4gcGF5bWVudCBpcyBwcm9jZXNzZWRcbiAgICB9LFxuXG4gICAgLy8gQm9va2luZyBzdGF0dXNcbiAgICBzdGF0dXM6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgICAgZW51bToge1xuICAgICAgICB2YWx1ZXM6IFsnY29uZmlybWVkJywgJ2NhbmNlbGxlZCcsICdjb21wbGV0ZWQnLCAnbm8tc2hvdyddLFxuICAgICAgICBtZXNzYWdlOiAnU3RhdHVzIG11c3QgYmUgY29uZmlybWVkLCBjYW5jZWxsZWQsIGNvbXBsZXRlZCwgb3Igbm8tc2hvdydcbiAgICAgIH0sXG4gICAgICBkZWZhdWx0OiAnY29uZmlybWVkJ1xuICAgIH0sXG5cbiAgICAvLyBBZGRpdGlvbmFsIGluZm9ybWF0aW9uXG4gICAgc3BlY2lhbFJlcXVlc3RzOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBtYXhsZW5ndGg6IFs1MDAsICdTcGVjaWFsIHJlcXVlc3RzIGNhbm5vdCBleGNlZWQgNTAwIGNoYXJhY3RlcnMnXSxcbiAgICAgIHJlcXVpcmVkOiBmYWxzZVxuICAgIH0sXG5cbiAgICAvLyBDb250YWN0IGluZm9ybWF0aW9uIGZvciB0aGUgYm9va2luZ1xuICAgIGNvbnRhY3RFbWFpbDoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IFt0cnVlLCAnQ29udGFjdCBlbWFpbCBpcyByZXF1aXJlZCddLFxuICAgICAgbG93ZXJjYXNlOiB0cnVlLFxuICAgICAgdHJpbTogdHJ1ZSxcbiAgICAgIHZhbGlkYXRlOiB7XG4gICAgICAgIHZhbGlkYXRvcjogZnVuY3Rpb24odikge1xuICAgICAgICAgIHJldHVybiAvXlxcdysoWy4tXT9cXHcrKSpAXFx3KyhbLi1dP1xcdyspKihcXC5cXHd7MiwzfSkrJC8udGVzdCh2KTtcbiAgICAgICAgfSxcbiAgICAgICAgbWVzc2FnZTogJ1BsZWFzZSBwcm92aWRlIGEgdmFsaWQgZW1haWwgYWRkcmVzcydcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgY29udGFjdFBob25lOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICByZXF1aXJlZDogZmFsc2UsXG4gICAgICB0cmltOiB0cnVlXG4gICAgfSxcblxuICAgIC8vIENhbmNlbGxhdGlvbiBpbmZvcm1hdGlvblxuICAgIGNhbmNlbGxlZEF0OiB7XG4gICAgICB0eXBlOiBEYXRlLFxuICAgICAgcmVxdWlyZWQ6IGZhbHNlXG4gICAgfSxcblxuICAgIGNhbmNlbGxhdGlvblJlYXNvbjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgcmVxdWlyZWQ6IGZhbHNlLFxuICAgICAgbWF4bGVuZ3RoOiBbMjAwLCAnQ2FuY2VsbGF0aW9uIHJlYXNvbiBjYW5ub3QgZXhjZWVkIDIwMCBjaGFyYWN0ZXJzJ11cbiAgICB9LFxuXG4gICAgLy8gUmVmdW5kIGluZm9ybWF0aW9uXG4gICAgcmVmdW5kQW1vdW50OiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICByZXF1aXJlZDogZmFsc2UsXG4gICAgICBtaW46IFswLCAnUmVmdW5kIGFtb3VudCBjYW5ub3QgYmUgbmVnYXRpdmUnXVxuICAgIH0sXG5cbiAgICByZWZ1bmRlZEF0OiB7XG4gICAgICB0eXBlOiBEYXRlLFxuICAgICAgcmVxdWlyZWQ6IGZhbHNlXG4gICAgfVxuICB9LFxuICB7XG4gICAgdGltZXN0YW1wczogdHJ1ZSxcbiAgICB0b0pTT046IHsgdmlydHVhbHM6IHRydWUgfSxcbiAgICB0b09iamVjdDogeyB2aXJ0dWFsczogdHJ1ZSB9XG4gIH1cbik7XG5cbi8vIFZpcnR1YWwgZmllbGQgZm9yIGJvb2tpbmcgZHVyYXRpb24gaW4gZGF5c1xuYm9va2luZ1NjaGVtYS52aXJ0dWFsKCdkdXJhdGlvbicpLmdldChmdW5jdGlvbigpIHtcbiAgaWYgKHRoaXMuY2hlY2tJbkRhdGUgJiYgdGhpcy5jaGVja091dERhdGUpIHtcbiAgICBjb25zdCB0aW1lRGlmZiA9IHRoaXMuY2hlY2tPdXREYXRlLmdldFRpbWUoKSAtIHRoaXMuY2hlY2tJbkRhdGUuZ2V0VGltZSgpO1xuICAgIHJldHVybiBNYXRoLmNlaWwodGltZURpZmYgLyAoMTAwMCAqIDM2MDAgKiAyNCkpO1xuICB9XG4gIHJldHVybiAwO1xufSk7XG5cbi8vIFZpcnR1YWwgZmllbGQgZm9yIGJvb2tpbmcgcmVmZXJlbmNlIG51bWJlclxuYm9va2luZ1NjaGVtYS52aXJ0dWFsKCdib29raW5nUmVmZXJlbmNlJykuZ2V0KGZ1bmN0aW9uKCkge1xuICByZXR1cm4gYFRSVi0ke3RoaXMuX2lkLnRvU3RyaW5nKCkuc2xpY2UoLTgpLnRvVXBwZXJDYXNlKCl9YDtcbn0pO1xuXG4vLyBQcmUtc2F2ZSBtaWRkbGV3YXJlIHRvIGNhbGN1bGF0ZSB0b3RhbCBuaWdodHMgYW5kIGFtb3VudFxuYm9va2luZ1NjaGVtYS5wcmUoJ3NhdmUnLCBmdW5jdGlvbihuZXh0KSB7XG4gIGlmICh0aGlzLmNoZWNrSW5EYXRlICYmIHRoaXMuY2hlY2tPdXREYXRlICYmIHRoaXMucHJpY2VQZXJOaWdodCkge1xuICAgIGNvbnN0IHRpbWVEaWZmID0gdGhpcy5jaGVja091dERhdGUuZ2V0VGltZSgpIC0gdGhpcy5jaGVja0luRGF0ZS5nZXRUaW1lKCk7XG4gICAgdGhpcy50b3RhbE5pZ2h0cyA9IE1hdGguY2VpbCh0aW1lRGlmZiAvICgxMDAwICogMzYwMCAqIDI0KSk7XG4gICAgdGhpcy50b3RhbEFtb3VudCA9IHRoaXMudG90YWxOaWdodHMgKiB0aGlzLnByaWNlUGVyTmlnaHQgKiB0aGlzLm51bWJlck9mR3Vlc3RzO1xuICB9XG4gIG5leHQoKTtcbn0pO1xuXG4vLyBJbmRleCBmb3IgYmV0dGVyIHF1ZXJ5IHBlcmZvcm1hbmNlXG5ib29raW5nU2NoZW1hLmluZGV4KHsgdXNlcjogMSwgY3JlYXRlZEF0OiAtMSB9KTtcbmJvb2tpbmdTY2hlbWEuaW5kZXgoeyBkZXN0aW5hdGlvbjogMSwgY2hlY2tJbkRhdGU6IDEsIGNoZWNrT3V0RGF0ZTogMSB9KTtcbmJvb2tpbmdTY2hlbWEuaW5kZXgoeyBzdGF0dXM6IDEgfSk7XG5ib29raW5nU2NoZW1hLmluZGV4KHsgcGF5bWVudFN0YXR1czogMSB9KTtcblxuLy8gU3RhdGljIG1ldGhvZCB0byBjaGVjayBhdmFpbGFiaWxpdHlcbmJvb2tpbmdTY2hlbWEuc3RhdGljcy5jaGVja0F2YWlsYWJpbGl0eSA9IGFzeW5jIGZ1bmN0aW9uKGRlc3RpbmF0aW9uSWQsIGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpIHtcbiAgY29uc3QgZXhpc3RpbmdCb29raW5ncyA9IGF3YWl0IHRoaXMuZmluZCh7XG4gICAgZGVzdGluYXRpb246IGRlc3RpbmF0aW9uSWQsXG4gICAgc3RhdHVzOiB7ICRpbjogWydjb25maXJtZWQnLCAnY29tcGxldGVkJ10gfSxcbiAgICAkb3I6IFtcbiAgICAgIHtcbiAgICAgICAgY2hlY2tJbkRhdGU6IHsgJGx0OiBjaGVja091dERhdGUgfSxcbiAgICAgICAgY2hlY2tPdXREYXRlOiB7ICRndDogY2hlY2tJbkRhdGUgfVxuICAgICAgfVxuICAgIF1cbiAgfSk7XG5cbiAgcmV0dXJuIGV4aXN0aW5nQm9va2luZ3MubGVuZ3RoID09PSAwO1xufTtcblxuLy8gSW5zdGFuY2UgbWV0aG9kIHRvIGNhbGN1bGF0ZSByZWZ1bmQgYW1vdW50XG5ib29raW5nU2NoZW1hLm1ldGhvZHMuY2FsY3VsYXRlUmVmdW5kID0gZnVuY3Rpb24oKSB7XG4gIGlmICh0aGlzLnN0YXR1cyAhPT0gJ2NhbmNlbGxlZCcpIHtcbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gIGNvbnN0IGRheXNVbnRpbENoZWNrSW4gPSBNYXRoLmNlaWwoKHRoaXMuY2hlY2tJbkRhdGUgLSBub3cpIC8gKDEwMDAgKiAzNjAwICogMjQpKTtcblxuICAvLyBSZWZ1bmQgcG9saWN5OiAxMDAlIGlmIGNhbmNlbGxlZCA3KyBkYXlzIGJlZm9yZSwgNTAlIGlmIDMtNiBkYXlzLCAwJSBpZiBsZXNzIHRoYW4gMyBkYXlzXG4gIGlmIChkYXlzVW50aWxDaGVja0luID49IDcpIHtcbiAgICByZXR1cm4gdGhpcy50b3RhbEFtb3VudDtcbiAgfSBlbHNlIGlmIChkYXlzVW50aWxDaGVja0luID49IDMpIHtcbiAgICByZXR1cm4gdGhpcy50b3RhbEFtb3VudCAqIDAuNTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gMDtcbiAgfVxufTtcblxuY29uc3QgQm9va2luZyA9IG1vbmdvb3NlLm1vZGVsKCdCb29raW5nJywgYm9va2luZ1NjaGVtYSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQm9va2luZzsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLFFBQVEsR0FBR0MsT0FBTyxDQUFDLFVBQVUsQ0FBQztBQUVwQyxNQUFNQyxhQUFhLEdBQUcsSUFBSUYsUUFBUSxDQUFDRyxNQUFNLENBQ3ZDO0VBQ0U7RUFDQUMsSUFBSSxFQUFFO0lBQ0pDLElBQUksRUFBRUwsUUFBUSxDQUFDRyxNQUFNLENBQUNHLEtBQUssQ0FBQ0MsUUFBUTtJQUNwQ0MsR0FBRyxFQUFFLE1BQU07SUFDWEMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLCtCQUErQjtFQUNsRCxDQUFDO0VBRUQ7RUFDQUMsV0FBVyxFQUFFO0lBQ1hMLElBQUksRUFBRUwsUUFBUSxDQUFDRyxNQUFNLENBQUNHLEtBQUssQ0FBQ0MsUUFBUTtJQUNwQ0MsR0FBRyxFQUFFLGFBQWE7SUFDbEJDLFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSxtQ0FBbUM7RUFDdEQsQ0FBQztFQUVEO0VBQ0FFLFdBQVcsRUFBRTtJQUNYTixJQUFJLEVBQUVPLElBQUk7SUFDVkgsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLDJCQUEyQixDQUFDO0lBQzdDSSxRQUFRLEVBQUU7TUFDUkMsU0FBUyxFQUFFLFNBQUFBLENBQVNDLENBQUMsRUFBRTtRQUNyQjtRQUNBLE9BQU9BLENBQUMsR0FBRyxJQUFJSCxJQUFJLENBQUMsQ0FBQztNQUN2QixDQUFDO01BQ0RJLE9BQU8sRUFBRTtJQUNYO0VBQ0YsQ0FBQztFQUVEQyxZQUFZLEVBQUU7SUFDWlosSUFBSSxFQUFFTyxJQUFJO0lBQ1ZILFFBQVEsRUFBRSxDQUFDLElBQUksRUFBRSw0QkFBNEIsQ0FBQztJQUM5Q0ksUUFBUSxFQUFFO01BQ1JDLFNBQVMsRUFBRSxTQUFBQSxDQUFTQyxDQUFDLEVBQUU7UUFDckI7UUFDQSxPQUFPQSxDQUFDLEdBQUcsSUFBSSxDQUFDSixXQUFXO01BQzdCLENBQUM7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