d65d2b1a592c41f3b872f863a8cc612d
const Booking = require('../public/models/booking.model');
const {
  ValidationError,
  NotFoundError,
  ConflictError
} = require('../utils/errors');
const {
  successResponse
} = require('../utils/response');
const {
  info,
  error
} = require('../utils/logger');

// Simulate payment processing (replace with real payment provider integration)
const simulatePaymentProcessing = async paymentData => {
  // Simulate processing delay
  await new Promise(resolve => setTimeout(resolve, 1000));

  // Simulate 95% success rate
  const success = Math.random() > 0.05;
  if (success) {
    return {
      success: true,
      paymentIntentId: `pi_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      transactionId: `txn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      amount: paymentData.amount,
      currency: 'USD',
      status: 'succeeded'
    };
  } else {
    return {
      success: false,
      error: 'Payment processing failed',
      errorCode: 'PAYMENT_FAILED'
    };
  }
};

// Simulate refund processing (replace with real payment provider integration)
const simulateRefundProcessing = async refundData => {
  // Simulate processing delay
  await new Promise(resolve => setTimeout(resolve, 1000));

  // Simulate 98% success rate for refunds
  const success = Math.random() > 0.02;
  if (success) {
    return {
      success: true,
      refundId: `re_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      amount: refundData.amount,
      currency: 'USD',
      status: 'succeeded'
    };
  } else {
    return {
      success: false,
      error: 'Refund processing failed',
      errorCode: 'REFUND_FAILED'
    };
  }
};

// Process payment for a booking
const processPayment = async (req, res, next) => {
  try {
    const {
      bookingId
    } = req.params;
    const {
      paymentMethod,
      paymentDetails
    } = req.body;
    const userId = req.user.id;

    // Find the booking
    const booking = await Booking.findById(bookingId).populate('destination');
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking
    if (booking.user.toString() !== userId) {
      throw new ValidationError('Access denied');
    }

    // Check if booking is already paid
    if (booking.paymentStatus === 'paid') {
      throw new ConflictError('Booking is already paid');
    }

    // Check if booking is cancelled
    if (booking.status === 'cancelled') {
      throw new ConflictError('Cannot process payment for cancelled booking');
    }

    // Simulate payment processing
    // In a real application, you would integrate with payment providers like Stripe, PayPal, etc.
    const paymentResult = await simulatePaymentProcessing({
      amount: booking.totalAmount,
      paymentMethod,
      paymentDetails,
      bookingId
    });
    if (paymentResult.success) {
      // Update booking with payment information
      booking.paymentStatus = 'paid';
      booking.paymentIntentId = paymentResult.paymentIntentId;
      booking.paymentMethod = paymentMethod;
      await booking.save();
      info('Payment processed successfully', {
        bookingId,
        userId,
        amount: booking.totalAmount,
        paymentMethod
      });
      res.json(successResponse({
        booking,
        paymentResult
      }, 'Payment processed successfully'));
    } else {
      // Payment failed
      booking.paymentStatus = 'failed';
      await booking.save();
      throw new ValidationError(paymentResult.error || 'Payment processing failed');
    }
  } catch (err) {
    error('Error processing payment', {
      error: err.message,
      bookingId: req.params.bookingId
    });
    next(err);
  }
};

// Get payment status for a booking
const getPaymentStatus = async (req, res, next) => {
  try {
    const {
      bookingId
    } = req.params;
    const userId = req.user.id;
    const booking = await Booking.findById(bookingId).select('paymentStatus paymentMethod totalAmount paymentIntentId createdAt').populate('destination', 'title');
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking
    if (booking.user.toString() !== userId) {
      throw new ValidationError('Access denied');
    }
    res.json(successResponse({
      booking: {
        id: booking._id,
        destination: booking.destination,
        paymentStatus: booking.paymentStatus,
        paymentMethod: booking.paymentMethod,
        totalAmount: booking.totalAmount,
        paymentIntentId: booking.paymentIntentId,
        createdAt: booking.createdAt
      }
    }, 'Payment status retrieved successfully'));
  } catch (err) {
    error('Error fetching payment status', {
      error: err.message,
      bookingId: req.params.bookingId
    });
    next(err);
  }
};

// Refund a booking
const processRefund = async (req, res, next) => {
  try {
    const {
      bookingId
    } = req.params;
    const {
      reason
    } = req.body;
    const userId = req.user.id;
    const booking = await Booking.findById(bookingId);
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking or is admin
    if (booking.user.toString() !== userId && req.user.role !== 'admin') {
      throw new ValidationError('Access denied');
    }

    // Check if booking is paid
    if (booking.paymentStatus !== 'paid') {
      throw new ConflictError('Cannot refund unpaid booking');
    }

    // Check if booking is already refunded
    if (booking.paymentStatus === 'refunded') {
      throw new ConflictError('Booking is already refunded');
    }

    // Calculate refund amount
    const refundAmount = booking.calculateRefund();
    if (refundAmount === 0) {
      throw new ValidationError('No refund available for this booking');
    }

    // Simulate refund processing
    const refundResult = await simulateRefundProcessing({
      paymentIntentId: booking.paymentIntentId,
      amount: refundAmount,
      reason
    });
    if (refundResult.success) {
      // Update booking with refund information
      booking.paymentStatus = 'refunded';
      booking.refundAmount = refundAmount;
      booking.refundedAt = new Date();
      booking.cancellationReason = reason;
      await booking.save();
      info('Refund processed successfully', {
        bookingId,
        userId,
        refundAmount,
        reason
      });
      res.json(successResponse({
        booking,
        refundResult
      }, 'Refund processed successfully'));
    } else {
      throw new ValidationError(refundResult.error || 'Refund processing failed');
    }
  } catch (err) {
    error('Error processing refund', {
      error: err.message,
      bookingId: req.params.bookingId
    });
    next(err);
  }
};

// Get payment history for a user
const getPaymentHistory = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const {
      page = 1,
      limit = 10,
      status
    } = req.query;

    // Build query
    const query = {
      user: userId
    };
    if (status) {
      query.paymentStatus = status;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get bookings with payment information
    const bookings = await Booking.find(query).select('paymentStatus paymentMethod totalAmount paymentIntentId createdAt refundAmount refundedAt').populate('destination', 'title location imageUrl').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count
    const total = await Booking.countDocuments(query);

    // Calculate payment statistics
    const stats = await Booking.aggregate([{
      $match: {
        user: userId
      }
    }, {
      $group: {
        _id: null,
        totalSpent: {
          $sum: '$totalAmount'
        },
        totalRefunded: {
          $sum: {
            $ifNull: ['$refundAmount', 0]
          }
        },
        paidBookings: {
          $sum: {
            $cond: [{
              $eq: ['$paymentStatus', 'paid']
            }, 1, 0]
          }
        },
        refundedBookings: {
          $sum: {
            $cond: [{
              $eq: ['$paymentStatus', 'refunded']
            }, 1, 0]
          }
        }
      }
    }]);
    const paymentStats = stats.length > 0 ? stats[0] : {
      totalSpent: 0,
      totalRefunded: 0,
      paidBookings: 0,
      refundedBookings: 0
    };
    res.json(successResponse({
      bookings,
      paymentStats,
      pagination: {
        current: parseInt(page, 10),
        pages: Math.ceil(total / parseInt(limit, 10)),
        total
      }
    }, 'Payment history retrieved successfully'));
  } catch (err) {
    error('Error fetching payment history', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};
module.exports = {
  processPayment,
  getPaymentStatus,
  processRefund,
  getPaymentHistory
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29raW5nIiwicmVxdWlyZSIsIlZhbGlkYXRpb25FcnJvciIsIk5vdEZvdW5kRXJyb3IiLCJDb25mbGljdEVycm9yIiwic3VjY2Vzc1Jlc3BvbnNlIiwiaW5mbyIsImVycm9yIiwic2ltdWxhdGVQYXltZW50UHJvY2Vzc2luZyIsInBheW1lbnREYXRhIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0Iiwic3VjY2VzcyIsIk1hdGgiLCJyYW5kb20iLCJwYXltZW50SW50ZW50SWQiLCJEYXRlIiwibm93IiwidG9TdHJpbmciLCJzdWJzdHIiLCJ0cmFuc2FjdGlvbklkIiwiYW1vdW50IiwiY3VycmVuY3kiLCJzdGF0dXMiLCJlcnJvckNvZGUiLCJzaW11bGF0ZVJlZnVuZFByb2Nlc3NpbmciLCJyZWZ1bmREYXRhIiwicmVmdW5kSWQiLCJwcm9jZXNzUGF5bWVudCIsInJlcSIsInJlcyIsIm5leHQiLCJib29raW5nSWQiLCJwYXJhbXMiLCJwYXltZW50TWV0aG9kIiwicGF5bWVudERldGFpbHMiLCJib2R5IiwidXNlcklkIiwidXNlciIsImlkIiwiYm9va2luZyIsImZpbmRCeUlkIiwicG9wdWxhdGUiLCJwYXltZW50U3RhdHVzIiwicGF5bWVudFJlc3VsdCIsInRvdGFsQW1vdW50Iiwic2F2ZSIsImpzb24iLCJlcnIiLCJtZXNzYWdlIiwiZ2V0UGF5bWVudFN0YXR1cyIsInNlbGVjdCIsIl9pZCIsImRlc3RpbmF0aW9uIiwiY3JlYXRlZEF0IiwicHJvY2Vzc1JlZnVuZCIsInJlYXNvbiIsInJvbGUiLCJyZWZ1bmRBbW91bnQiLCJjYWxjdWxhdGVSZWZ1bmQiLCJyZWZ1bmRSZXN1bHQiLCJyZWZ1bmRlZEF0IiwiY2FuY2VsbGF0aW9uUmVhc29uIiwiZ2V0UGF5bWVudEhpc3RvcnkiLCJwYWdlIiwibGltaXQiLCJxdWVyeSIsInNraXAiLCJwYXJzZUludCIsImJvb2tpbmdzIiwiZmluZCIsInNvcnQiLCJ0b3RhbCIsImNvdW50RG9jdW1lbnRzIiwic3RhdHMiLCJhZ2dyZWdhdGUiLCIkbWF0Y2giLCIkZ3JvdXAiLCJ0b3RhbFNwZW50IiwiJHN1bSIsInRvdGFsUmVmdW5kZWQiLCIkaWZOdWxsIiwicGFpZEJvb2tpbmdzIiwiJGNvbmQiLCIkZXEiLCJyZWZ1bmRlZEJvb2tpbmdzIiwicGF5bWVudFN0YXRzIiwibGVuZ3RoIiwicGFnaW5hdGlvbiIsImN1cnJlbnQiLCJwYWdlcyIsImNlaWwiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsicGF5bWVudC5jb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEJvb2tpbmcgPSByZXF1aXJlKCcuLi9wdWJsaWMvbW9kZWxzL2Jvb2tpbmcubW9kZWwnKTtcbmNvbnN0IHsgVmFsaWRhdGlvbkVycm9yLCBOb3RGb3VuZEVycm9yLCBDb25mbGljdEVycm9yIH0gPSByZXF1aXJlKCcuLi91dGlscy9lcnJvcnMnKTtcbmNvbnN0IHsgc3VjY2Vzc1Jlc3BvbnNlIH0gPSByZXF1aXJlKCcuLi91dGlscy9yZXNwb25zZScpO1xuY29uc3QgeyBpbmZvLCBlcnJvciB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvbG9nZ2VyJyk7XG5cbi8vIFNpbXVsYXRlIHBheW1lbnQgcHJvY2Vzc2luZyAocmVwbGFjZSB3aXRoIHJlYWwgcGF5bWVudCBwcm92aWRlciBpbnRlZ3JhdGlvbilcbmNvbnN0IHNpbXVsYXRlUGF5bWVudFByb2Nlc3NpbmcgPSBhc3luYyhwYXltZW50RGF0YSkgPT4ge1xuICAvLyBTaW11bGF0ZSBwcm9jZXNzaW5nIGRlbGF5XG4gIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMDAwKSk7XG5cbiAgLy8gU2ltdWxhdGUgOTUlIHN1Y2Nlc3MgcmF0ZVxuICBjb25zdCBzdWNjZXNzID0gTWF0aC5yYW5kb20oKSA+IDAuMDU7XG5cbiAgaWYgKHN1Y2Nlc3MpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIHBheW1lbnRJbnRlbnRJZDogYHBpXyR7RGF0ZS5ub3coKX1fJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YCxcbiAgICAgIHRyYW5zYWN0aW9uSWQ6IGB0eG5fJHtEYXRlLm5vdygpfV8ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gLFxuICAgICAgYW1vdW50OiBwYXltZW50RGF0YS5hbW91bnQsXG4gICAgICBjdXJyZW5jeTogJ1VTRCcsXG4gICAgICBzdGF0dXM6ICdzdWNjZWVkZWQnXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ1BheW1lbnQgcHJvY2Vzc2luZyBmYWlsZWQnLFxuICAgICAgZXJyb3JDb2RlOiAnUEFZTUVOVF9GQUlMRUQnXG4gICAgfTtcbiAgfVxufTtcblxuLy8gU2ltdWxhdGUgcmVmdW5kIHByb2Nlc3NpbmcgKHJlcGxhY2Ugd2l0aCByZWFsIHBheW1lbnQgcHJvdmlkZXIgaW50ZWdyYXRpb24pXG5jb25zdCBzaW11bGF0ZVJlZnVuZFByb2Nlc3NpbmcgPSBhc3luYyhyZWZ1bmREYXRhKSA9PiB7XG4gIC8vIFNpbXVsYXRlIHByb2Nlc3NpbmcgZGVsYXlcbiAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKTtcblxuICAvLyBTaW11bGF0ZSA5OCUgc3VjY2VzcyByYXRlIGZvciByZWZ1bmRzXG4gIGNvbnN0IHN1Y2Nlc3MgPSBNYXRoLnJhbmRvbSgpID4gMC4wMjtcblxuICBpZiAoc3VjY2Vzcykge1xuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgcmVmdW5kSWQ6IGByZV8ke0RhdGUubm93KCl9XyR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWAsXG4gICAgICBhbW91bnQ6IHJlZnVuZERhdGEuYW1vdW50LFxuICAgICAgY3VycmVuY3k6ICdVU0QnLFxuICAgICAgc3RhdHVzOiAnc3VjY2VlZGVkJ1xuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdSZWZ1bmQgcHJvY2Vzc2luZyBmYWlsZWQnLFxuICAgICAgZXJyb3JDb2RlOiAnUkVGVU5EX0ZBSUxFRCdcbiAgICB9O1xuICB9XG59O1xuXG4vLyBQcm9jZXNzIHBheW1lbnQgZm9yIGEgYm9va2luZ1xuY29uc3QgcHJvY2Vzc1BheW1lbnQgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHsgYm9va2luZ0lkIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IHsgcGF5bWVudE1ldGhvZCwgcGF5bWVudERldGFpbHMgfSA9IHJlcS5ib2R5O1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyLmlkO1xuXG4gICAgLy8gRmluZCB0aGUgYm9va2luZ1xuICAgIGNvbnN0IGJvb2tpbmcgPSBhd2FpdCBCb29raW5nLmZpbmRCeUlkKGJvb2tpbmdJZCkucG9wdWxhdGUoJ2Rlc3RpbmF0aW9uJyk7XG5cbiAgICBpZiAoIWJvb2tpbmcpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdCb29raW5nIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgb3ducyB0aGlzIGJvb2tpbmdcbiAgICBpZiAoYm9va2luZy51c2VyLnRvU3RyaW5nKCkgIT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQWNjZXNzIGRlbmllZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGJvb2tpbmcgaXMgYWxyZWFkeSBwYWlkXG4gICAgaWYgKGJvb2tpbmcucGF5bWVudFN0YXR1cyA9PT0gJ3BhaWQnKSB7XG4gICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFcnJvcignQm9va2luZyBpcyBhbHJlYWR5IHBhaWQnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBib29raW5nIGlzIGNhbmNlbGxlZFxuICAgIGlmIChib29raW5nLnN0YXR1cyA9PT0gJ2NhbmNlbGxlZCcpIHtcbiAgICAgIHRocm93IG5ldyBDb25mbGljdEVycm9yKCdDYW5ub3QgcHJvY2VzcyBwYXltZW50IGZvciBjYW5jZWxsZWQgYm9va2luZycpO1xuICAgIH1cblxuICAgIC8vIFNpbXVsYXRlIHBheW1lbnQgcHJvY2Vzc2luZ1xuICAgIC8vIEluIGEgcmVhbCBhcHBsaWNhdGlvbiwgeW91IHdvdWxkIGludGVncmF0ZSB3aXRoIHBheW1lbnQgcHJvdmlkZXJzIGxpa2UgU3RyaXBlLCBQYXlQYWwsIGV0Yy5cbiAgICBjb25zdCBwYXltZW50UmVzdWx0ID0gYXdhaXQgc2ltdWxhdGVQYXltZW50UHJvY2Vzc2luZyh7XG4gICAgICBhbW91bnQ6IGJvb2tpbmcudG90YWxBbW91bnQsXG4gICAgICBwYXltZW50TWV0aG9kLFxuICAgICAgcGF5bWVudERldGFpbHMsXG4gICAgICBib29raW5nSWRcbiAgICB9KTtcblxuICAgIGlmIChwYXltZW50UmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIC8vIFVwZGF0ZSBib29raW5nIHdpdGggcGF5bWVudCBpbmZvcm1hdGlvblxuICAgICAgYm9va2luZy5wYXltZW50U3RhdHVzID0gJ3BhaWQnO1xuICAgICAgYm9va2luZy5wYXltZW50SW50ZW50SWQgPSBwYXltZW50UmVzdWx0LnBheW1lbnRJbnRlbnRJZDtcbiAgICAgIGJvb2tpbmcucGF5bWVudE1ldGhvZCA9IHBheW1lbnRNZXRob2Q7XG5cbiAgICAgIGF3YWl0IGJvb2tpbmcuc2F2ZSgpO1xuXG4gICAgICBpbmZvKCdQYXltZW50IHByb2Nlc3NlZCBzdWNjZXNzZnVsbHknLCB7XG4gICAgICAgIGJvb2tpbmdJZCxcbiAgICAgICAgdXNlcklkLFxuICAgICAgICBhbW91bnQ6IGJvb2tpbmcudG90YWxBbW91bnQsXG4gICAgICAgIHBheW1lbnRNZXRob2RcbiAgICAgIH0pO1xuXG4gICAgICByZXMuanNvbihcbiAgICAgICAgc3VjY2Vzc1Jlc3BvbnNlKFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIGJvb2tpbmcsXG4gICAgICAgICAgICBwYXltZW50UmVzdWx0XG4gICAgICAgICAgfSxcbiAgICAgICAgICAnUGF5bWVudCBwcm9jZXNzZWQgc3VjY2Vzc2Z1bGx5J1xuICAgICAgICApXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBQYXltZW50IGZhaWxlZFxuICAgICAgYm9va2luZy5wYXltZW50U3RhdHVzID0gJ2ZhaWxlZCc7XG4gICAgICBhd2FpdCBib29raW5nLnNhdmUoKTtcblxuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcihwYXltZW50UmVzdWx0LmVycm9yIHx8ICdQYXltZW50IHByb2Nlc3NpbmcgZmFpbGVkJyk7XG4gICAgfVxuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBwcm9jZXNzaW5nIHBheW1lbnQnLCB7IGVycm9yOiBlcnIubWVzc2FnZSwgYm9va2luZ0lkOiByZXEucGFyYW1zLmJvb2tpbmdJZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIEdldCBwYXltZW50IHN0YXR1cyBmb3IgYSBib29raW5nXG5jb25zdCBnZXRQYXltZW50U3RhdHVzID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGJvb2tpbmdJZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcblxuICAgIGNvbnN0IGJvb2tpbmcgPSBhd2FpdCBCb29raW5nLmZpbmRCeUlkKGJvb2tpbmdJZClcbiAgICAgIC5zZWxlY3QoJ3BheW1lbnRTdGF0dXMgcGF5bWVudE1ldGhvZCB0b3RhbEFtb3VudCBwYXltZW50SW50ZW50SWQgY3JlYXRlZEF0JylcbiAgICAgIC5wb3B1bGF0ZSgnZGVzdGluYXRpb24nLCAndGl0bGUnKTtcblxuICAgIGlmICghYm9va2luZykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ0Jvb2tpbmcgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBvd25zIHRoaXMgYm9va2luZ1xuICAgIGlmIChib29raW5nLnVzZXIudG9TdHJpbmcoKSAhPT0gdXNlcklkKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdBY2Nlc3MgZGVuaWVkJyk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oXG4gICAgICBzdWNjZXNzUmVzcG9uc2UoXG4gICAgICAgIHtcbiAgICAgICAgICBib29raW5nOiB7XG4gICAgICAgICAgICBpZDogYm9va2luZy5faWQsXG4gICAgICAgICAgICBkZXN0aW5hdGlvbjogYm9va2luZy5kZXN0aW5hdGlvbixcbiAgICAgICAgICAgIHBheW1lbnRTdGF0dXM6IGJvb2tpbmcucGF5bWVudFN0YXR1cyxcbiAgICAgICAgICAgIHBheW1lbnRNZXRob2Q6IGJvb2tpbmcucGF5bWVudE1ldGhvZCxcbiAgICAgICAgICAgIHRvdGFsQW1vdW50OiBib29raW5nLnRvdGFsQW1vdW50LFxuICAgICAgICAgICAgcGF5bWVudEludGVudElkOiBib29raW5nLnBheW1lbnRJbnRlbnRJZCxcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogYm9va2luZy5jcmVhdGVkQXRcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgICdQYXltZW50IHN0YXR1cyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5J1xuICAgICAgKVxuICAgICk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIGZldGNoaW5nIHBheW1lbnQgc3RhdHVzJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIGJvb2tpbmdJZDogcmVxLnBhcmFtcy5ib29raW5nSWQgfSk7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG4vLyBSZWZ1bmQgYSBib29raW5nXG5jb25zdCBwcm9jZXNzUmVmdW5kID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGJvb2tpbmdJZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB7IHJlYXNvbiB9ID0gcmVxLmJvZHk7XG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG5cbiAgICBjb25zdCBib29raW5nID0gYXdhaXQgQm9va2luZy5maW5kQnlJZChib29raW5nSWQpO1xuXG4gICAgaWYgKCFib29raW5nKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcignQm9va2luZyBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB1c2VyIG93bnMgdGhpcyBib29raW5nIG9yIGlzIGFkbWluXG4gICAgaWYgKGJvb2tpbmcudXNlci50b1N0cmluZygpICE9PSB1c2VySWQgJiYgcmVxLnVzZXIucm9sZSAhPT0gJ2FkbWluJykge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignQWNjZXNzIGRlbmllZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGJvb2tpbmcgaXMgcGFpZFxuICAgIGlmIChib29raW5nLnBheW1lbnRTdGF0dXMgIT09ICdwYWlkJykge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXJyb3IoJ0Nhbm5vdCByZWZ1bmQgdW5wYWlkIGJvb2tpbmcnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBib29raW5nIGlzIGFscmVhZHkgcmVmdW5kZWRcbiAgICBpZiAoYm9va2luZy5wYXltZW50U3RhdHVzID09PSAncmVmdW5kZWQnKSB7XG4gICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFcnJvcignQm9va2luZyBpcyBhbHJlYWR5IHJlZnVuZGVkJyk7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHJlZnVuZCBhbW91bnRcbiAgICBjb25zdCByZWZ1bmRBbW91bnQgPSBib29raW5nLmNhbGN1bGF0ZVJlZnVuZCgpO1xuXG4gICAgaWYgKHJlZnVuZEFtb3VudCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignTm8gcmVmdW5kIGF2YWlsYWJsZSBmb3IgdGhpcyBib29raW5nJyk7XG4gICAgfVxuXG4gICAgLy8gU2ltdWxhdGUgcmVmdW5kIHByb2Nlc3NpbmdcbiAgICBjb25zdCByZWZ1bmRSZXN1bHQgPSBhd2FpdCBzaW11bGF0ZVJlZnVuZFByb2Nlc3Npbmcoe1xuICAgICAgcGF5bWVudEludGVudElkOiBib29raW5nLnBheW1lbnRJbnRlbnRJZCxcbiAgICAgIGFtb3VudDogcmVmdW5kQW1vdW50LFxuICAgICAgcmVhc29uXG4gICAgfSk7XG5cbiAgICBpZiAocmVmdW5kUmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIC8vIFVwZGF0ZSBib29raW5nIHdpdGggcmVmdW5kIGluZm9ybWF0aW9uXG4gICAgICBib29raW5nLnBheW1lbnRTdGF0dXMgPSAncmVmdW5kZWQnO1xuICAgICAgYm9va2luZy5yZWZ1bmRBbW91bnQgPSByZWZ1bmRBbW91bnQ7XG4gICAgICBib29raW5nLnJlZnVuZGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgICAgYm9va2luZy5jYW5jZWxsYXRpb25SZWFzb24gPSByZWFzb247XG5cbiAgICAgIGF3YWl0IGJvb2tpbmcuc2F2ZSgpO1xuXG4gICAgICBpbmZvKCdSZWZ1bmQgcHJvY2Vzc2VkIHN1Y2Nlc3NmdWxseScsIHtcbiAgICAgICAgYm9va2luZ0lkLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHJlZnVuZEFtb3VudCxcbiAgICAgICAgcmVhc29uXG4gICAgICB9KTtcblxuICAgICAgcmVzLmpzb24oXG4gICAgICAgIHN1Y2Nlc3NSZXNwb25zZShcbiAgICAgICAgICB7XG4gICAgICAgICAgICBib29raW5nLFxuICAgICAgICAgICAgcmVmdW5kUmVzdWx0XG4gICAgICAgICAgfSxcbiAgICAgICAgICAnUmVmdW5kIHByb2Nlc3NlZCBzdWNjZXNzZnVsbHknXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IocmVmdW5kUmVzdWx0LmVycm9yIHx8ICdSZWZ1bmQgcHJvY2Vzc2luZyBmYWlsZWQnKTtcbiAgICB9XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIHByb2Nlc3NpbmcgcmVmdW5kJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIGJvb2tpbmdJZDogcmVxLnBhcmFtcy5ib29raW5nSWQgfSk7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG4vLyBHZXQgcGF5bWVudCBoaXN0b3J5IGZvciBhIHVzZXJcbmNvbnN0IGdldFBheW1lbnRIaXN0b3J5ID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcbiAgICBjb25zdCB7IHBhZ2UgPSAxLCBsaW1pdCA9IDEwLCBzdGF0dXMgfSA9IHJlcS5xdWVyeTtcblxuICAgIC8vIEJ1aWxkIHF1ZXJ5XG4gICAgY29uc3QgcXVlcnkgPSB7IHVzZXI6IHVzZXJJZCB9O1xuICAgIGlmIChzdGF0dXMpIHtcbiAgICAgIHF1ZXJ5LnBheW1lbnRTdGF0dXMgPSBzdGF0dXM7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHBhZ2luYXRpb25cbiAgICBjb25zdCBza2lwID0gKHBhcnNlSW50KHBhZ2UsIDEwKSAtIDEpICogcGFyc2VJbnQobGltaXQsIDEwKTtcblxuICAgIC8vIEdldCBib29raW5ncyB3aXRoIHBheW1lbnQgaW5mb3JtYXRpb25cbiAgICBjb25zdCBib29raW5ncyA9IGF3YWl0IEJvb2tpbmcuZmluZChxdWVyeSlcbiAgICAgIC5zZWxlY3QoJ3BheW1lbnRTdGF0dXMgcGF5bWVudE1ldGhvZCB0b3RhbEFtb3VudCBwYXltZW50SW50ZW50SWQgY3JlYXRlZEF0IHJlZnVuZEFtb3VudCByZWZ1bmRlZEF0JylcbiAgICAgIC5wb3B1bGF0ZSgnZGVzdGluYXRpb24nLCAndGl0bGUgbG9jYXRpb24gaW1hZ2VVcmwnKVxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXG4gICAgICAuc2tpcChza2lwKVxuICAgICAgLmxpbWl0KHBhcnNlSW50KGxpbWl0LCAxMCkpO1xuXG4gICAgLy8gR2V0IHRvdGFsIGNvdW50XG4gICAgY29uc3QgdG90YWwgPSBhd2FpdCBCb29raW5nLmNvdW50RG9jdW1lbnRzKHF1ZXJ5KTtcblxuICAgIC8vIENhbGN1bGF0ZSBwYXltZW50IHN0YXRpc3RpY3NcbiAgICBjb25zdCBzdGF0cyA9IGF3YWl0IEJvb2tpbmcuYWdncmVnYXRlKFtcbiAgICAgIHsgJG1hdGNoOiB7IHVzZXI6IHVzZXJJZCB9IH0sXG4gICAgICB7XG4gICAgICAgICRncm91cDoge1xuICAgICAgICAgIF9pZDogbnVsbCxcbiAgICAgICAgICB0b3RhbFNwZW50OiB7ICRzdW06ICckdG90YWxBbW91bnQnIH0sXG4gICAgICAgICAgdG90YWxSZWZ1bmRlZDogeyAkc3VtOiB7ICRpZk51bGw6IFsnJHJlZnVuZEFtb3VudCcsIDBdIH0gfSxcbiAgICAgICAgICBwYWlkQm9va2luZ3M6IHtcbiAgICAgICAgICAgICRzdW06IHsgJGNvbmQ6IFt7ICRlcTogWyckcGF5bWVudFN0YXR1cycsICdwYWlkJ10gfSwgMSwgMF0gfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgcmVmdW5kZWRCb29raW5nczoge1xuICAgICAgICAgICAgJHN1bTogeyAkY29uZDogW3sgJGVxOiBbJyRwYXltZW50U3RhdHVzJywgJ3JlZnVuZGVkJ10gfSwgMSwgMF0gfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIF0pO1xuXG4gICAgY29uc3QgcGF5bWVudFN0YXRzID0gc3RhdHMubGVuZ3RoID4gMCA/IHN0YXRzWzBdIDoge1xuICAgICAgdG90YWxTcGVudDogMCxcbiAgICAgIHRvdGFsUmVmdW5kZWQ6IDAsXG4gICAgICBwYWlkQm9va2luZ3M6IDAsXG4gICAgICByZWZ1bmRlZEJvb2tpbmdzOiAwXG4gICAgfTtcblxuICAgIHJlcy5qc29uKFxuICAgICAgc3VjY2Vzc1Jlc3BvbnNlKFxuICAgICAgICB7XG4gICAgICAgICAgYm9va2luZ3MsXG4gICAgICAgICAgcGF5bWVudFN0YXRzLFxuICAgICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICAgIGN1cnJlbnQ6IHBhcnNlSW50KHBhZ2UsIDEwKSxcbiAgICAgICAgICAgIHBhZ2VzOiBNYXRoLmNlaWwodG90YWwgLyBwYXJzZUludChsaW1pdCwgMTApKSxcbiAgICAgICAgICAgIHRvdGFsXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAnUGF5bWVudCBoaXN0b3J5IHJldHJpZXZlZCBzdWNjZXNzZnVsbHknXG4gICAgICApXG4gICAgKTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgZmV0Y2hpbmcgcGF5bWVudCBoaXN0b3J5JywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIHVzZXJJZDogcmVxLnVzZXI/LmlkIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHByb2Nlc3NQYXltZW50LFxuICBnZXRQYXltZW50U3RhdHVzLFxuICBwcm9jZXNzUmVmdW5kLFxuICBnZXRQYXltZW50SGlzdG9yeVxufTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGdDQUFnQyxDQUFDO0FBQ3pELE1BQU07RUFBRUMsZUFBZTtFQUFFQyxhQUFhO0VBQUVDO0FBQWMsQ0FBQyxHQUFHSCxPQUFPLENBQUMsaUJBQWlCLENBQUM7QUFDcEYsTUFBTTtFQUFFSTtBQUFnQixDQUFDLEdBQUdKLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztBQUN4RCxNQUFNO0VBQUVLLElBQUk7RUFBRUM7QUFBTSxDQUFDLEdBQUdOLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQzs7QUFFbEQ7QUFDQSxNQUFNTyx5QkFBeUIsR0FBRyxNQUFNQyxXQUFXLElBQUs7RUFDdEQ7RUFD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