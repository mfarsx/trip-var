{"version":3,"names":["cov_1mjvm98adb","actualCoverage","jwt","s","require","promisify","User","UnauthorizedError","ForbiddenError","exports","authenticate","req","res","next","f","token","b","headers","authorization","startsWith","split","cookies","decoded","verify","process","env","JWT_SECRET","algorithms","user","findById","id","changedPasswordAfter","iat","err","name","status","json","message","error","authorize","roles","includes","role","protect","restrictTo"],"sources":["auth.js"],"sourcesContent":["const jwt = require('jsonwebtoken');\nconst { promisify } = require('util');\nconst User = require('../models/user.model');\nconst { UnauthorizedError, ForbiddenError } = require('../utils/errors');\n\nexports.authenticate = async(req, res, next) => {\n  try {\n    // 1) Get token and check if it exists\n    let token;\n    if (\n      req.headers.authorization &&\n      req.headers.authorization.startsWith('Bearer')\n    ) {\n      token = req.headers.authorization.split(' ')[1];\n    }\n\n    // Additional security: Check for token in cookies as fallback\n    if (!token && req.cookies && req.cookies.token) {\n      token = req.cookies.token;\n    }\n\n    if (!token) {\n      throw new UnauthorizedError(\n        'You are not logged in! Please log in to get access.'\n      );\n    }\n\n    // 2) Verify token\n    try {\n      const decoded = await promisify(jwt.verify)(token, process.env.JWT_SECRET, {\n        algorithms: ['HS256'] // Explicitly specify algorithm for security\n      });\n\n      // 3) Check if user still exists\n      const user = await User.findById(decoded.id);\n      if (!user) {\n        throw new UnauthorizedError(\n          'The user belonging to this token no longer exists.'\n        );\n      }\n\n      // 4) Check if user changed password after the token was issued\n      if (user.changedPasswordAfter(decoded.iat)) {\n        throw new UnauthorizedError(\n          'User recently changed password! Please log in again.'\n        );\n      }\n\n      // Grant access to protected route\n      req.user = user;\n      next();\n    } catch (err) {\n      // Handle JWT specific errors with clear messages\n      if (err.name === 'TokenExpiredError') {\n        return res.status(401).json({\n          status: 'fail',\n          message: 'Your token has expired. Please log in again.'\n        });\n      } else if (err.name === 'JsonWebTokenError') {\n        return res.status(401).json({\n          status: 'fail',\n          message: 'Invalid token. Please log in again.'\n        });\n      }\n      throw err;\n    }\n  } catch (error) {\n    next(error);\n  }\n};\n\nexports.authorize = (...roles) => {\n  return (req, res, next) => {\n    if (!roles.includes(req.user.role)) {\n      return next(\n        new ForbiddenError('You do not have permission to perform this action')\n      );\n    }\n    next();\n  };\n};\n\n// Keep the old exports for backward compatibility\nexports.protect = exports.authenticate;\nexports.restrictTo = exports.authorize;\n"],"mappings":"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","ignoreList":[]}