{"version":3,"names":["redisUtils","require","info","error","redisCache","options","key","ttl","skipCache","req","res","next","query","cacheKey","method","originalUrl","cachedData","getCache","path","json","_cached","_cacheKey","originalJson","data","setCache","catch","err","message","call","stack","invalidateCache","pattern","getRedisClient","client","keys","length","del","keysCount","redisSession","sessionId","cookies","headers","sessionData","getSession","session","setSession","newSessionId","randomUUID","cookie","httpOnly","secure","process","env","NODE_ENV","maxAge","clearSession","deleteSession","clearCookie","module","exports"],"sources":["redisCache.js"],"sourcesContent":["const { redisUtils } = require('../config/redis');\nconst { info, error } = require('../utils/logger');\n\n/**\n * Redis caching middleware\n * @param {Object} options - Cache options\n * @param {string} options.key - Cache key (can be a function that receives req)\n * @param {number} options.ttl - Time to live in seconds (default: 3600)\n * @param {boolean} options.skipCache - Skip cache for certain conditions\n * @returns {Function} Express middleware function\n */\nconst redisCache = (options = {}) => {\n  const { key, ttl = 3600, skipCache = false } = options;\n\n  return async(req, res, next) => {\n    // Skip caching if requested\n    if (skipCache || req.query.skipCache === 'true') {\n      return next();\n    }\n\n    try {\n      // Generate cache key\n      let cacheKey;\n      if (typeof key === 'function') {\n        cacheKey = key(req);\n      } else if (key) {\n        cacheKey = key;\n      } else {\n        // Default cache key based on URL and query params\n        cacheKey = `cache:${req.method}:${req.originalUrl}`;\n      }\n\n      // Try to get from cache\n      const cachedData = await redisUtils.getCache(cacheKey);\n\n      if (cachedData) {\n        info('Cache hit', { key: cacheKey, path: req.path });\n        return res.json({\n          ...cachedData,\n          _cached: true,\n          _cacheKey: cacheKey\n        });\n      }\n\n      // Cache miss - continue to route handler\n      info('Cache miss', { key: cacheKey, path: req.path });\n\n      // Store original res.json to intercept response\n      const originalJson = res.json;\n      res.json = function(data) {\n        // Cache the response (async, don't wait)\n        redisUtils.setCache(cacheKey, data, ttl).catch(err => {\n          error('Failed to cache response', { error: err.message, cacheKey });\n        });\n\n        // Call original json method\n        return originalJson.call(this, data);\n      };\n\n      next();\n    } catch (err) {\n      // If Redis fails, continue without caching\n      error('Redis cache middleware error', { error: err.message, stack: err.stack });\n      next();\n    }\n  };\n};\n\n/**\n * Invalidate cache by key pattern\n * @param {string} pattern - Key pattern to invalidate\n */\nconst invalidateCache = async(pattern) => {\n  try {\n    const { getRedisClient } = require('../config/redis');\n    const client = getRedisClient();\n    const keys = await client.keys(pattern);\n\n    if (keys.length > 0) {\n      await client.del(...keys);\n      info('Cache invalidated', { pattern, keysCount: keys.length });\n    }\n  } catch (err) {\n    error('Failed to invalidate cache', { error: err.message, pattern });\n  }\n};\n\n/**\n * Session middleware using Redis\n */\nconst redisSession = (options = {}) => {\n  const { ttl = 86400 } = options; // 24 hours default\n\n  return async(req, res, next) => {\n    try {\n      // Get session ID from cookie or header\n      const sessionId = req.cookies?.sessionId || req.headers['x-session-id'];\n\n      if (sessionId) {\n        const sessionData = await redisUtils.getSession(sessionId);\n        if (sessionData) {\n          req.session = sessionData;\n        }\n      }\n\n      // Add session methods to response\n      res.setSession = async(data) => {\n        const newSessionId = sessionId || require('crypto').randomUUID();\n        await redisUtils.setSession(newSessionId, data, ttl);\n        res.cookie('sessionId', newSessionId, {\n          httpOnly: true,\n          secure: process.env.NODE_ENV === 'production',\n          maxAge: ttl * 1000\n        });\n        req.session = data;\n        return newSessionId;\n      };\n\n      res.clearSession = async() => {\n        if (sessionId) {\n          await redisUtils.deleteSession(sessionId);\n          res.clearCookie('sessionId');\n          delete req.session;\n        }\n      };\n\n      next();\n    } catch (err) {\n      error('Redis session middleware error', { error: err.message, stack: err.stack });\n      next();\n    }\n  };\n};\n\nmodule.exports = {\n  redisCache,\n  invalidateCache,\n  redisSession\n};"],"mappings":"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","ignoreList":[]}