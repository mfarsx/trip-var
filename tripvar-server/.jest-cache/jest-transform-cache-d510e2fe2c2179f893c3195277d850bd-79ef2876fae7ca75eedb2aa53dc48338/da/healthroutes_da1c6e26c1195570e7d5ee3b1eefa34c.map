{"version":3,"names":["express","require","router","Router","mongoose","getRedisClient","config","os","process","healthChecker","redisClient","get","req","res","health","status","timestamp","Date","toISOString","service","version","env","npm_package_version","environment","server","nodeEnv","uptime","json","dbState","connection","readyState","database","error","message","startTime","now","ping","responseTime","redis","metrics","system","memory","used","memoryUsage","free","freemem","total","totalmem","cpu","loadAverage","loadavg","cpus","length","platform","arch","nodeVersion","pid","ppid","title","argv","execPath","services","checks","dbStartTime","dbResponseTime","mongodb","redisStartTime","redisResponseTime","memoryUsagePercent","heapUsed","heapTotal","Math","round","usagePercent","statusCode","redisReady","redisError","console","warn","reason","module","exports"],"sources":["health.routes.js"],"sourcesContent":["const express = require('express');\nconst router = express.Router();\nconst mongoose = require('mongoose');\nconst { getRedisClient } = require('../config/redis');\n// const { HealthChecker, createHealthCheckMiddleware, createReadinessMiddleware, createLivenessMiddleware, createMetricsMiddleware } = require('../middleware/healthCheck');\n\nconst config = require('../config/config');\nconst os = require('os');\nconst process = require('process');\n\n// Initialize health checker\nlet healthChecker;\nlet redisClient;\n\n// Initialize health checker without Redis initially\n// healthChecker = new HealthChecker(null); // HealthChecker not implemented yet\n\n// Metrics middleware\n// const metricsMiddleware = createMetricsMiddleware(); // Metrics middleware not implemented yet\n\n// Basic health check\nrouter.get('/', (req, res) => {\n  const health = {\n    status: 'ok',\n    timestamp: new Date().toISOString(),\n    service: 'tripvar-server',\n    version: process.env.npm_package_version || '1.0.0',\n    environment: config.server.nodeEnv,\n    uptime: process.uptime()\n  };\n\n  res.json(health);\n});\n\n// Database health check\nrouter.get('/db', async(req, res) => {\n  try {\n    const dbState = mongoose.connection.readyState;\n    if (dbState === 1) {\n      res.json({ status: 'ok', database: 'connected' });\n    } else {\n      res.status(503).json({ status: 'error', database: 'disconnected' });\n    }\n  } catch (error) {\n    res.status(503).json({ status: 'error', message: error.message });\n  }\n});\n\n// Redis health check\nrouter.get('/redis', async(req, res) => {\n  try {\n    const redisClient = getRedisClient();\n    const startTime = Date.now();\n    await redisClient.ping();\n    const responseTime = Date.now() - startTime;\n\n    res.json({\n      status: 'ok',\n      redis: 'connected',\n      responseTime: `${responseTime}ms`\n    });\n  } catch (error) {\n    res.status(503).json({\n      status: 'error',\n      redis: 'disconnected',\n      message: error.message\n    });\n  }\n});\n\n// System metrics\nrouter.get('/metrics', (req, res) => {\n  const metrics = {\n    timestamp: new Date().toISOString(),\n    system: {\n      uptime: process.uptime(),\n      memory: {\n        used: process.memoryUsage(),\n        free: os.freemem(),\n        total: os.totalmem()\n      },\n      cpu: {\n        loadAverage: os.loadavg(),\n        cpus: os.cpus().length\n      },\n      platform: os.platform(),\n      arch: os.arch(),\n      nodeVersion: process.version\n    },\n    process: {\n      pid: process.pid,\n      ppid: process.ppid,\n      title: process.title,\n      argv: process.argv,\n      execPath: process.execPath\n    }\n  };\n\n  res.json(metrics);\n});\n\n// Complete health check (all services)\nrouter.get('/all', async(req, res) => {\n  const startTime = Date.now();\n  const health = {\n    status: 'ok',\n    timestamp: new Date().toISOString(),\n    service: 'tripvar-server',\n    version: process.env.npm_package_version || '1.0.0',\n    environment: config.server.nodeEnv,\n    uptime: process.uptime(),\n    services: {},\n    checks: {}\n  };\n\n  // Check MongoDB\n  try {\n    const dbStartTime = Date.now();\n    const dbState = mongoose.connection.readyState;\n    const dbResponseTime = Date.now() - dbStartTime;\n\n    health.services.mongodb = {\n      status: dbState === 1 ? 'connected' : 'disconnected',\n      responseTime: `${dbResponseTime}ms`,\n      readyState: dbState\n    };\n\n    health.checks.mongodb = dbState === 1 ? 'pass' : 'fail';\n\n    if (dbState !== 1) {\n      health.status = 'degraded';\n    }\n  } catch (error) {\n    health.services.mongodb = {\n      status: 'error',\n      error: error.message\n    };\n    health.checks.mongodb = 'fail';\n    health.status = 'error';\n  }\n\n  // Check Redis\n  try {\n    const redisStartTime = Date.now();\n    const redisClient = getRedisClient();\n    await redisClient.ping();\n    const redisResponseTime = Date.now() - redisStartTime;\n\n    health.services.redis = {\n      status: 'connected',\n      responseTime: `${redisResponseTime}ms`\n    };\n\n    health.checks.redis = 'pass';\n  } catch (error) {\n    health.services.redis = {\n      status: 'disconnected',\n      error: error.message\n    };\n    health.checks.redis = 'fail';\n    health.status = 'degraded';\n  }\n\n  // System health\n  const memoryUsage = process.memoryUsage();\n  const memoryUsagePercent = (memoryUsage.heapUsed / memoryUsage.heapTotal) * 100;\n\n  health.system = {\n    memory: {\n      used: `${Math.round(memoryUsage.heapUsed / 1024 / 1024)}MB`,\n      total: `${Math.round(memoryUsage.heapTotal / 1024 / 1024)}MB`,\n      usagePercent: Math.round(memoryUsagePercent)\n    },\n    uptime: `${Math.round(process.uptime())}s`,\n    loadAverage: os.loadavg()\n  };\n\n  // Overall response time\n  health.responseTime = `${Date.now() - startTime}ms`;\n\n  // Determine status code\n  let statusCode = 200;\n  if (health.status === 'error') {\n    statusCode = 503;\n  } else if (health.status === 'degraded') {\n    statusCode = 200; // Still operational but with issues\n  }\n\n  res.status(statusCode).json(health);\n});\n\n// Readiness probe (for Kubernetes)\nrouter.get('/ready', async(req, res) => {\n  try {\n    // Check if all critical services are ready\n    const dbState = mongoose.connection.readyState;\n\n    // Check Redis if available\n    let redisReady = true;\n    try {\n      const redisClient = getRedisClient();\n      await redisClient.ping();\n    } catch (redisError) {\n      redisReady = false;\n      // Redis is not critical for readiness, just log the warning\n      console.warn('Redis not ready:', redisError.message);\n    }\n\n    if (dbState === 1) {\n      res.status(200).json({\n        status: 'ready',\n        services: {\n          database: 'ready',\n          redis: redisReady ? 'ready' : 'not ready'\n        }\n      });\n    } else {\n      res.status(503).json({ status: 'not ready', reason: 'database not connected' });\n    }\n  } catch (error) {\n    res.status(503).json({ status: 'not ready', reason: error.message });\n  }\n});\n\n// Liveness probe (for Kubernetes)\nrouter.get('/live', (req, res) => {\n  // Simple check if the process is alive\n  res.status(200).json({ status: 'alive', uptime: process.uptime() });\n});\n\nmodule.exports = router;\n"],"mappings":"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","ignoreList":[]}