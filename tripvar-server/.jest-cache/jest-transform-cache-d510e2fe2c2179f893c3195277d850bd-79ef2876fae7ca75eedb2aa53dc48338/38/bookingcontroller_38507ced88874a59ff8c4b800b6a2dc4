a1314284d5e5e074741d78aa7238fa8c
const Booking = require('../public/models/booking.model');
const Destination = require('../public/models/destination.model');
const {
  ValidationError,
  NotFoundError,
  ConflictError
} = require('../utils/errors');
const {
  info,
  error
} = require('../utils/logger');
const NotificationService = require('../services/notification.service');

// Create a new booking
const createBooking = async (req, res, next) => {
  try {
    const {
      destinationId,
      checkInDate,
      checkOutDate,
      numberOfGuests,
      paymentMethod,
      specialRequests,
      contactEmail,
      contactPhone
    } = req.body;
    const userId = req.user.id;

    // Validate required fields
    if (!destinationId || !checkInDate || !checkOutDate || !numberOfGuests) {
      throw new ValidationError('Missing required booking information');
    }

    // Parse dates
    const checkIn = new Date(checkInDate);
    const checkOut = new Date(checkOutDate);

    // Validate dates
    if (checkIn <= new Date()) {
      throw new ValidationError('Check-in date must be in the future');
    }
    if (checkOut <= checkIn) {
      throw new ValidationError('Check-out date must be after check-in date');
    }

    // Get destination details
    const destination = await Destination.findById(destinationId);
    if (!destination) {
      throw new NotFoundError('Destination not found');
    }

    // Check availability
    const isAvailable = await Booking.checkAvailability(destinationId, checkIn, checkOut);
    if (!isAvailable) {
      throw new ConflictError('Destination is not available for the selected dates');
    }

    // Calculate pricing
    const totalNights = Math.ceil((checkOut - checkIn) / (1000 * 3600 * 24));
    const totalAmount = totalNights * destination.price * numberOfGuests;

    // Create booking
    const booking = new Booking({
      user: userId,
      destination: destinationId,
      checkInDate: checkIn,
      checkOutDate: checkOut,
      numberOfGuests,
      pricePerNight: destination.price,
      totalNights,
      totalAmount,
      paymentMethod,
      specialRequests,
      contactEmail: contactEmail || req.user.email,
      contactPhone
    });
    await booking.save();

    // Populate the booking with destination and user details
    await booking.populate([{
      path: 'destination',
      select: 'title location imageUrl'
    }, {
      path: 'user',
      select: 'name email'
    }]);
    info('New booking created', {
      bookingId: booking._id,
      userId,
      destinationId,
      totalAmount
    });

    // Create booking confirmation notification
    try {
      await NotificationService.createBookingConfirmationNotification(userId, booking);
    } catch (notificationError) {
      // Log error but don't fail the booking creation
      error('Failed to create booking confirmation notification', {
        error: notificationError.message,
        bookingId: booking._id,
        userId
      });
    }
    res.status(201).json({
      success: true,
      message: 'Booking created successfully',
      data: {
        booking: booking
      }
    });
  } catch (err) {
    error('Error creating booking', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Get user's bookings
const getUserBookings = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const {
      status,
      page = 1,
      limit = 10
    } = req.query;

    // Build query
    const query = {
      user: userId
    };
    if (status) {
      query.status = status;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get bookings with pagination
    const bookings = await Booking.find(query).populate('destination', 'title location imageUrl rating').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count for pagination
    const total = await Booking.countDocuments(query);
    res.json({
      success: true,
      data: {
        bookings,
        pagination: {
          current: parseInt(page, 10),
          pages: Math.ceil(total / parseInt(limit, 10)),
          total
        }
      }
    });
  } catch (err) {
    error('Error fetching user bookings', {
      error: err.message,
      userId: req.user?.id
    });
    next(err);
  }
};

// Get specific booking
const getBookingById = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const userId = req.user.id;
    const booking = await Booking.findById(id).populate('destination', 'title location imageUrl rating description').populate('user', 'name email');
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking or is admin
    if (booking.user._id.toString() !== userId && req.user.role !== 'admin') {
      throw new ValidationError('Access denied');
    }
    res.json({
      success: true,
      data: {
        booking
      }
    });
  } catch (err) {
    error('Error fetching booking', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Cancel booking
const cancelBooking = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const {
      reason
    } = req.body;
    const userId = req.user.id;
    const booking = await Booking.findById(id).populate('destination');
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }

    // Check if user owns this booking
    if (booking.user.toString() !== userId) {
      throw new ValidationError('Access denied');
    }

    // Check if booking can be cancelled
    if (booking.status === 'cancelled') {
      throw new ConflictError('Booking is already cancelled');
    }
    if (booking.status === 'completed') {
      throw new ConflictError('Cannot cancel completed booking');
    }

    // Calculate refund amount
    const refundAmount = booking.calculateRefund();

    // Update booking
    booking.status = 'cancelled';
    booking.cancelledAt = new Date();
    booking.cancellationReason = reason;
    booking.refundAmount = refundAmount;
    if (refundAmount > 0) {
      booking.paymentStatus = 'refunded';
      booking.refundedAt = new Date();
    }
    await booking.save();
    info('Booking cancelled', {
      bookingId: id,
      userId,
      refundAmount
    });

    // Create booking cancellation notification
    try {
      await NotificationService.createBookingCancellationNotification(userId, booking, refundAmount);
    } catch (notificationError) {
      // Log error but don't fail the cancellation
      error('Failed to create booking cancellation notification', {
        error: notificationError.message,
        bookingId: id,
        userId
      });
    }
    res.json({
      success: true,
      message: 'Booking cancelled successfully',
      data: {
        booking,
        refundAmount
      }
    });
  } catch (err) {
    error('Error cancelling booking', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Get all bookings (admin only)
const getAllBookings = async (req, res, next) => {
  try {
    const {
      status,
      page = 1,
      limit = 20,
      destinationId
    } = req.query;

    // Build query
    const query = {};
    if (status) {
      query.status = status;
    }
    if (destinationId) {
      query.destination = destinationId;
    }

    // Calculate pagination
    const skip = (parseInt(page, 10) - 1) * parseInt(limit, 10);

    // Get bookings with pagination
    const bookings = await Booking.find(query).populate('destination', 'title location').populate('user', 'name email').sort({
      createdAt: -1
    }).skip(skip).limit(parseInt(limit, 10));

    // Get total count
    const total = await Booking.countDocuments(query);
    res.json({
      success: true,
      data: {
        bookings,
        pagination: {
          current: parseInt(page, 10),
          pages: Math.ceil(total / parseInt(limit, 10)),
          total
        }
      }
    });
  } catch (err) {
    error('Error fetching all bookings', {
      error: err.message
    });
    next(err);
  }
};

// Update booking status (admin only)
const updateBookingStatus = async (req, res, next) => {
  try {
    const {
      id
    } = req.params;
    const {
      status
    } = req.body;
    const validStatuses = ['confirmed', 'cancelled', 'completed', 'no-show'];
    if (!validStatuses.includes(status)) {
      throw new ValidationError('Invalid booking status');
    }
    const booking = await Booking.findById(id);
    if (!booking) {
      throw new NotFoundError('Booking not found');
    }
    booking.status = status;
    await booking.save();
    info('Booking status updated', {
      bookingId: id,
      newStatus: status,
      adminId: req.user.id
    });
    res.json({
      success: true,
      message: 'Booking status updated successfully',
      data: {
        booking
      }
    });
  } catch (err) {
    error('Error updating booking status', {
      error: err.message,
      bookingId: req.params.id
    });
    next(err);
  }
};

// Check availability for a destination
const checkAvailability = async (req, res, next) => {
  try {
    const {
      destinationId,
      checkInDate,
      checkOutDate
    } = req.query;
    if (!destinationId || !checkInDate || !checkOutDate) {
      throw new ValidationError('Missing required parameters');
    }
    const checkIn = new Date(checkInDate);
    const checkOut = new Date(checkOutDate);
    const isAvailable = await Booking.checkAvailability(destinationId, checkIn, checkOut);
    res.json({
      success: true,
      data: {
        available: isAvailable,
        checkInDate: checkIn,
        checkOutDate: checkOut
      }
    });
  } catch (err) {
    error('Error checking availability', {
      error: err.message
    });
    next(err);
  }
};
module.exports = {
  createBooking,
  getUserBookings,
  getBookingById,
  cancelBooking,
  getAllBookings,
  updateBookingStatus,
  checkAvailability
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCb29raW5nIiwicmVxdWlyZSIsIkRlc3RpbmF0aW9uIiwiVmFsaWRhdGlvbkVycm9yIiwiTm90Rm91bmRFcnJvciIsIkNvbmZsaWN0RXJyb3IiLCJpbmZvIiwiZXJyb3IiLCJOb3RpZmljYXRpb25TZXJ2aWNlIiwiY3JlYXRlQm9va2luZyIsInJlcSIsInJlcyIsIm5leHQiLCJkZXN0aW5hdGlvbklkIiwiY2hlY2tJbkRhdGUiLCJjaGVja091dERhdGUiLCJudW1iZXJPZkd1ZXN0cyIsInBheW1lbnRNZXRob2QiLCJzcGVjaWFsUmVxdWVzdHMiLCJjb250YWN0RW1haWwiLCJjb250YWN0UGhvbmUiLCJib2R5IiwidXNlcklkIiwidXNlciIsImlkIiwiY2hlY2tJbiIsIkRhdGUiLCJjaGVja091dCIsImRlc3RpbmF0aW9uIiwiZmluZEJ5SWQiLCJpc0F2YWlsYWJsZSIsImNoZWNrQXZhaWxhYmlsaXR5IiwidG90YWxOaWdodHMiLCJNYXRoIiwiY2VpbCIsInRvdGFsQW1vdW50IiwicHJpY2UiLCJib29raW5nIiwicHJpY2VQZXJOaWdodCIsImVtYWlsIiwic2F2ZSIsInBvcHVsYXRlIiwicGF0aCIsInNlbGVjdCIsImJvb2tpbmdJZCIsIl9pZCIsImNyZWF0ZUJvb2tpbmdDb25maXJtYXRpb25Ob3RpZmljYXRpb24iLCJub3RpZmljYXRpb25FcnJvciIsIm1lc3NhZ2UiLCJzdGF0dXMiLCJqc29uIiwic3VjY2VzcyIsImRhdGEiLCJlcnIiLCJnZXRVc2VyQm9va2luZ3MiLCJwYWdlIiwibGltaXQiLCJxdWVyeSIsInNraXAiLCJwYXJzZUludCIsImJvb2tpbmdzIiwiZmluZCIsInNvcnQiLCJjcmVhdGVkQXQiLCJ0b3RhbCIsImNvdW50RG9jdW1lbnRzIiwicGFnaW5hdGlvbiIsImN1cnJlbnQiLCJwYWdlcyIsImdldEJvb2tpbmdCeUlkIiwicGFyYW1zIiwidG9TdHJpbmciLCJyb2xlIiwiY2FuY2VsQm9va2luZyIsInJlYXNvbiIsInJlZnVuZEFtb3VudCIsImNhbGN1bGF0ZVJlZnVuZCIsImNhbmNlbGxlZEF0IiwiY2FuY2VsbGF0aW9uUmVhc29uIiwicGF5bWVudFN0YXR1cyIsInJlZnVuZGVkQXQiLCJjcmVhdGVCb29raW5nQ2FuY2VsbGF0aW9uTm90aWZpY2F0aW9uIiwiZ2V0QWxsQm9va2luZ3MiLCJ1cGRhdGVCb29raW5nU3RhdHVzIiwidmFsaWRTdGF0dXNlcyIsImluY2x1ZGVzIiwibmV3U3RhdHVzIiwiYWRtaW5JZCIsImF2YWlsYWJsZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJib29raW5nLmNvbnRyb2xsZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQm9va2luZyA9IHJlcXVpcmUoJy4uL3B1YmxpYy9tb2RlbHMvYm9va2luZy5tb2RlbCcpO1xuY29uc3QgRGVzdGluYXRpb24gPSByZXF1aXJlKCcuLi9wdWJsaWMvbW9kZWxzL2Rlc3RpbmF0aW9uLm1vZGVsJyk7XG5jb25zdCB7IFZhbGlkYXRpb25FcnJvciwgTm90Rm91bmRFcnJvciwgQ29uZmxpY3RFcnJvciB9ID0gcmVxdWlyZSgnLi4vdXRpbHMvZXJyb3JzJyk7XG5jb25zdCB7IGluZm8sIGVycm9yIH0gPSByZXF1aXJlKCcuLi91dGlscy9sb2dnZXInKTtcbmNvbnN0IE5vdGlmaWNhdGlvblNlcnZpY2UgPSByZXF1aXJlKCcuLi9zZXJ2aWNlcy9ub3RpZmljYXRpb24uc2VydmljZScpO1xuXG4vLyBDcmVhdGUgYSBuZXcgYm9va2luZ1xuY29uc3QgY3JlYXRlQm9va2luZyA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3Qge1xuICAgICAgZGVzdGluYXRpb25JZCxcbiAgICAgIGNoZWNrSW5EYXRlLFxuICAgICAgY2hlY2tPdXREYXRlLFxuICAgICAgbnVtYmVyT2ZHdWVzdHMsXG4gICAgICBwYXltZW50TWV0aG9kLFxuICAgICAgc3BlY2lhbFJlcXVlc3RzLFxuICAgICAgY29udGFjdEVtYWlsLFxuICAgICAgY29udGFjdFBob25lXG4gICAgfSA9IHJlcS5ib2R5O1xuXG4gICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuaWQ7XG5cbiAgICAvLyBWYWxpZGF0ZSByZXF1aXJlZCBmaWVsZHNcbiAgICBpZiAoIWRlc3RpbmF0aW9uSWQgfHwgIWNoZWNrSW5EYXRlIHx8ICFjaGVja091dERhdGUgfHwgIW51bWJlck9mR3Vlc3RzKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdNaXNzaW5nIHJlcXVpcmVkIGJvb2tpbmcgaW5mb3JtYXRpb24nKTtcbiAgICB9XG5cbiAgICAvLyBQYXJzZSBkYXRlc1xuICAgIGNvbnN0IGNoZWNrSW4gPSBuZXcgRGF0ZShjaGVja0luRGF0ZSk7XG4gICAgY29uc3QgY2hlY2tPdXQgPSBuZXcgRGF0ZShjaGVja091dERhdGUpO1xuXG4gICAgLy8gVmFsaWRhdGUgZGF0ZXNcbiAgICBpZiAoY2hlY2tJbiA8PSBuZXcgRGF0ZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdDaGVjay1pbiBkYXRlIG11c3QgYmUgaW4gdGhlIGZ1dHVyZScpO1xuICAgIH1cblxuICAgIGlmIChjaGVja091dCA8PSBjaGVja0luKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdDaGVjay1vdXQgZGF0ZSBtdXN0IGJlIGFmdGVyIGNoZWNrLWluIGRhdGUnKTtcbiAgICB9XG5cbiAgICAvLyBHZXQgZGVzdGluYXRpb24gZGV0YWlsc1xuICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gYXdhaXQgRGVzdGluYXRpb24uZmluZEJ5SWQoZGVzdGluYXRpb25JZCk7XG4gICAgaWYgKCFkZXN0aW5hdGlvbikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ0Rlc3RpbmF0aW9uIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGF2YWlsYWJpbGl0eVxuICAgIGNvbnN0IGlzQXZhaWxhYmxlID0gYXdhaXQgQm9va2luZy5jaGVja0F2YWlsYWJpbGl0eShkZXN0aW5hdGlvbklkLCBjaGVja0luLCBjaGVja091dCk7XG4gICAgaWYgKCFpc0F2YWlsYWJsZSkge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXJyb3IoJ0Rlc3RpbmF0aW9uIGlzIG5vdCBhdmFpbGFibGUgZm9yIHRoZSBzZWxlY3RlZCBkYXRlcycpO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBwcmljaW5nXG4gICAgY29uc3QgdG90YWxOaWdodHMgPSBNYXRoLmNlaWwoKGNoZWNrT3V0IC0gY2hlY2tJbikgLyAoMTAwMCAqIDM2MDAgKiAyNCkpO1xuICAgIGNvbnN0IHRvdGFsQW1vdW50ID0gdG90YWxOaWdodHMgKiBkZXN0aW5hdGlvbi5wcmljZSAqIG51bWJlck9mR3Vlc3RzO1xuXG4gICAgLy8gQ3JlYXRlIGJvb2tpbmdcbiAgICBjb25zdCBib29raW5nID0gbmV3IEJvb2tpbmcoe1xuICAgICAgdXNlcjogdXNlcklkLFxuICAgICAgZGVzdGluYXRpb246IGRlc3RpbmF0aW9uSWQsXG4gICAgICBjaGVja0luRGF0ZTogY2hlY2tJbixcbiAgICAgIGNoZWNrT3V0RGF0ZTogY2hlY2tPdXQsXG4gICAgICBudW1iZXJPZkd1ZXN0cyxcbiAgICAgIHByaWNlUGVyTmlnaHQ6IGRlc3RpbmF0aW9uLnByaWNlLFxuICAgICAgdG90YWxOaWdodHMsXG4gICAgICB0b3RhbEFtb3VudCxcbiAgICAgIHBheW1lbnRNZXRob2QsXG4gICAgICBzcGVjaWFsUmVxdWVzdHMsXG4gICAgICBjb250YWN0RW1haWw6IGNvbnRhY3RFbWFpbCB8fCByZXEudXNlci5lbWFpbCxcbiAgICAgIGNvbnRhY3RQaG9uZVxuICAgIH0pO1xuXG4gICAgYXdhaXQgYm9va2luZy5zYXZlKCk7XG5cbiAgICAvLyBQb3B1bGF0ZSB0aGUgYm9va2luZyB3aXRoIGRlc3RpbmF0aW9uIGFuZCB1c2VyIGRldGFpbHNcbiAgICBhd2FpdCBib29raW5nLnBvcHVsYXRlKFtcbiAgICAgIHsgcGF0aDogJ2Rlc3RpbmF0aW9uJywgc2VsZWN0OiAndGl0bGUgbG9jYXRpb24gaW1hZ2VVcmwnIH0sXG4gICAgICB7IHBhdGg6ICd1c2VyJywgc2VsZWN0OiAnbmFtZSBlbWFpbCcgfVxuICAgIF0pO1xuXG4gICAgaW5mbygnTmV3IGJvb2tpbmcgY3JlYXRlZCcsIHtcbiAgICAgIGJvb2tpbmdJZDogYm9va2luZy5faWQsXG4gICAgICB1c2VySWQsXG4gICAgICBkZXN0aW5hdGlvbklkLFxuICAgICAgdG90YWxBbW91bnRcbiAgICB9KTtcblxuICAgIC8vIENyZWF0ZSBib29raW5nIGNvbmZpcm1hdGlvbiBub3RpZmljYXRpb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgTm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVCb29raW5nQ29uZmlybWF0aW9uTm90aWZpY2F0aW9uKHVzZXJJZCwgYm9va2luZyk7XG4gICAgfSBjYXRjaCAobm90aWZpY2F0aW9uRXJyb3IpIHtcbiAgICAgIC8vIExvZyBlcnJvciBidXQgZG9uJ3QgZmFpbCB0aGUgYm9va2luZyBjcmVhdGlvblxuICAgICAgZXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgYm9va2luZyBjb25maXJtYXRpb24gbm90aWZpY2F0aW9uJywge1xuICAgICAgICBlcnJvcjogbm90aWZpY2F0aW9uRXJyb3IubWVzc2FnZSxcbiAgICAgICAgYm9va2luZ0lkOiBib29raW5nLl9pZCxcbiAgICAgICAgdXNlcklkXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgbWVzc2FnZTogJ0Jvb2tpbmcgY3JlYXRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgZGF0YToge1xuICAgICAgICBib29raW5nOiBib29raW5nXG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIGNyZWF0aW5nIGJvb2tpbmcnLCB7IGVycm9yOiBlcnIubWVzc2FnZSwgdXNlcklkOiByZXEudXNlcj8uaWQgfSk7XG4gICAgbmV4dChlcnIpO1xuICB9XG59O1xuXG4vLyBHZXQgdXNlcidzIGJvb2tpbmdzXG5jb25zdCBnZXRVc2VyQm9va2luZ3MgPSBhc3luYyhyZXEsIHJlcywgbmV4dCkgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHJlcS51c2VyLmlkO1xuICAgIGNvbnN0IHsgc3RhdHVzLCBwYWdlID0gMSwgbGltaXQgPSAxMCB9ID0gcmVxLnF1ZXJ5O1xuXG4gICAgLy8gQnVpbGQgcXVlcnlcbiAgICBjb25zdCBxdWVyeSA9IHsgdXNlcjogdXNlcklkIH07XG4gICAgaWYgKHN0YXR1cykge1xuICAgICAgcXVlcnkuc3RhdHVzID0gc3RhdHVzO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBwYWdpbmF0aW9uXG4gICAgY29uc3Qgc2tpcCA9IChwYXJzZUludChwYWdlLCAxMCkgLSAxKSAqIHBhcnNlSW50KGxpbWl0LCAxMCk7XG5cbiAgICAvLyBHZXQgYm9va2luZ3Mgd2l0aCBwYWdpbmF0aW9uXG4gICAgY29uc3QgYm9va2luZ3MgPSBhd2FpdCBCb29raW5nLmZpbmQocXVlcnkpXG4gICAgICAucG9wdWxhdGUoJ2Rlc3RpbmF0aW9uJywgJ3RpdGxlIGxvY2F0aW9uIGltYWdlVXJsIHJhdGluZycpXG4gICAgICAuc29ydCh7IGNyZWF0ZWRBdDogLTEgfSlcbiAgICAgIC5za2lwKHNraXApXG4gICAgICAubGltaXQocGFyc2VJbnQobGltaXQsIDEwKSk7XG5cbiAgICAvLyBHZXQgdG90YWwgY291bnQgZm9yIHBhZ2luYXRpb25cbiAgICBjb25zdCB0b3RhbCA9IGF3YWl0IEJvb2tpbmcuY291bnREb2N1bWVudHMocXVlcnkpO1xuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgYm9va2luZ3MsXG4gICAgICAgIHBhZ2luYXRpb246IHtcbiAgICAgICAgICBjdXJyZW50OiBwYXJzZUludChwYWdlLCAxMCksXG4gICAgICAgICAgcGFnZXM6IE1hdGguY2VpbCh0b3RhbCAvIHBhcnNlSW50KGxpbWl0LCAxMCkpLFxuICAgICAgICAgIHRvdGFsXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgZmV0Y2hpbmcgdXNlciBib29raW5ncycsIHsgZXJyb3I6IGVyci5tZXNzYWdlLCB1c2VySWQ6IHJlcS51c2VyPy5pZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIEdldCBzcGVjaWZpYyBib29raW5nXG5jb25zdCBnZXRCb29raW5nQnlJZCA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcblxuICAgIGNvbnN0IGJvb2tpbmcgPSBhd2FpdCBCb29raW5nLmZpbmRCeUlkKGlkKVxuICAgICAgLnBvcHVsYXRlKCdkZXN0aW5hdGlvbicsICd0aXRsZSBsb2NhdGlvbiBpbWFnZVVybCByYXRpbmcgZGVzY3JpcHRpb24nKVxuICAgICAgLnBvcHVsYXRlKCd1c2VyJywgJ25hbWUgZW1haWwnKTtcblxuICAgIGlmICghYm9va2luZykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ0Jvb2tpbmcgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBvd25zIHRoaXMgYm9va2luZyBvciBpcyBhZG1pblxuICAgIGlmIChib29raW5nLnVzZXIuX2lkLnRvU3RyaW5nKCkgIT09IHVzZXJJZCAmJiByZXEudXNlci5yb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdBY2Nlc3MgZGVuaWVkJyk7XG4gICAgfVxuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgYm9va2luZ1xuICAgICAgfVxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBmZXRjaGluZyBib29raW5nJywgeyBlcnJvcjogZXJyLm1lc3NhZ2UsIGJvb2tpbmdJZDogcmVxLnBhcmFtcy5pZCB9KTtcbiAgICBuZXh0KGVycik7XG4gIH1cbn07XG5cbi8vIENhbmNlbCBib29raW5nXG5jb25zdCBjYW5jZWxCb29raW5nID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgIGNvbnN0IHsgcmVhc29uIH0gPSByZXEuYm9keTtcbiAgICBjb25zdCB1c2VySWQgPSByZXEudXNlci5pZDtcblxuICAgIGNvbnN0IGJvb2tpbmcgPSBhd2FpdCBCb29raW5nLmZpbmRCeUlkKGlkKS5wb3B1bGF0ZSgnZGVzdGluYXRpb24nKTtcblxuICAgIGlmICghYm9va2luZykge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ0Jvb2tpbmcgbm90IGZvdW5kJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBvd25zIHRoaXMgYm9va2luZ1xuICAgIGlmIChib29raW5nLnVzZXIudG9TdHJpbmcoKSAhPT0gdXNlcklkKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdBY2Nlc3MgZGVuaWVkJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgYm9va2luZyBjYW4gYmUgY2FuY2VsbGVkXG4gICAgaWYgKGJvb2tpbmcuc3RhdHVzID09PSAnY2FuY2VsbGVkJykge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXJyb3IoJ0Jvb2tpbmcgaXMgYWxyZWFkeSBjYW5jZWxsZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoYm9va2luZy5zdGF0dXMgPT09ICdjb21wbGV0ZWQnKSB7XG4gICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFcnJvcignQ2Fubm90IGNhbmNlbCBjb21wbGV0ZWQgYm9va2luZycpO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSByZWZ1bmQgYW1vdW50XG4gICAgY29uc3QgcmVmdW5kQW1vdW50ID0gYm9va2luZy5jYWxjdWxhdGVSZWZ1bmQoKTtcblxuICAgIC8vIFVwZGF0ZSBib29raW5nXG4gICAgYm9va2luZy5zdGF0dXMgPSAnY2FuY2VsbGVkJztcbiAgICBib29raW5nLmNhbmNlbGxlZEF0ID0gbmV3IERhdGUoKTtcbiAgICBib29raW5nLmNhbmNlbGxhdGlvblJlYXNvbiA9IHJlYXNvbjtcbiAgICBib29raW5nLnJlZnVuZEFtb3VudCA9IHJlZnVuZEFtb3VudDtcblxuICAgIGlmIChyZWZ1bmRBbW91bnQgPiAwKSB7XG4gICAgICBib29raW5nLnBheW1lbnRTdGF0dXMgPSAncmVmdW5kZWQnO1xuICAgICAgYm9va2luZy5yZWZ1bmRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICB9XG5cbiAgICBhd2FpdCBib29raW5nLnNhdmUoKTtcblxuICAgIGluZm8oJ0Jvb2tpbmcgY2FuY2VsbGVkJywge1xuICAgICAgYm9va2luZ0lkOiBpZCxcbiAgICAgIHVzZXJJZCxcbiAgICAgIHJlZnVuZEFtb3VudFxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIGJvb2tpbmcgY2FuY2VsbGF0aW9uIG5vdGlmaWNhdGlvblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBOb3RpZmljYXRpb25TZXJ2aWNlLmNyZWF0ZUJvb2tpbmdDYW5jZWxsYXRpb25Ob3RpZmljYXRpb24odXNlcklkLCBib29raW5nLCByZWZ1bmRBbW91bnQpO1xuICAgIH0gY2F0Y2ggKG5vdGlmaWNhdGlvbkVycm9yKSB7XG4gICAgICAvLyBMb2cgZXJyb3IgYnV0IGRvbid0IGZhaWwgdGhlIGNhbmNlbGxhdGlvblxuICAgICAgZXJyb3IoJ0ZhaWxlZCB0byBjcmVhdGUgYm9va2luZyBjYW5jZWxsYXRpb24gbm90aWZpY2F0aW9uJywge1xuICAgICAgICBlcnJvcjogbm90aWZpY2F0aW9uRXJyb3IubWVzc2FnZSxcbiAgICAgICAgYm9va2luZ0lkOiBpZCxcbiAgICAgICAgdXNlcklkXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXMuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgbWVzc2FnZTogJ0Jvb2tpbmcgY2FuY2VsbGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGJvb2tpbmcsXG4gICAgICAgIHJlZnVuZEFtb3VudFxuICAgICAgfVxuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGVycm9yKCdFcnJvciBjYW5jZWxsaW5nIGJvb2tpbmcnLCB7IGVycm9yOiBlcnIubWVzc2FnZSwgYm9va2luZ0lkOiByZXEucGFyYW1zLmlkIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gR2V0IGFsbCBib29raW5ncyAoYWRtaW4gb25seSlcbmNvbnN0IGdldEFsbEJvb2tpbmdzID0gYXN5bmMocmVxLCByZXMsIG5leHQpID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7IHN0YXR1cywgcGFnZSA9IDEsIGxpbWl0ID0gMjAsIGRlc3RpbmF0aW9uSWQgfSA9IHJlcS5xdWVyeTtcblxuICAgIC8vIEJ1aWxkIHF1ZXJ5XG4gICAgY29uc3QgcXVlcnkgPSB7fTtcbiAgICBpZiAoc3RhdHVzKSB7XG4gICAgICBxdWVyeS5zdGF0dXMgPSBzdGF0dXM7XG4gICAgfVxuICAgIGlmIChkZXN0aW5hdGlvbklkKSB7XG4gICAgICBxdWVyeS5kZXN0aW5hdGlvbiA9IGRlc3RpbmF0aW9uSWQ7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHBhZ2luYXRpb25cbiAgICBjb25zdCBza2lwID0gKHBhcnNlSW50KHBhZ2UsIDEwKSAtIDEpICogcGFyc2VJbnQobGltaXQsIDEwKTtcblxuICAgIC8vIEdldCBib29raW5ncyB3aXRoIHBhZ2luYXRpb25cbiAgICBjb25zdCBib29raW5ncyA9IGF3YWl0IEJvb2tpbmcuZmluZChxdWVyeSlcbiAgICAgIC5wb3B1bGF0ZSgnZGVzdGluYXRpb24nLCAndGl0bGUgbG9jYXRpb24nKVxuICAgICAgLnBvcHVsYXRlKCd1c2VyJywgJ25hbWUgZW1haWwnKVxuICAgICAgLnNvcnQoeyBjcmVhdGVkQXQ6IC0xIH0pXG4gICAgICAuc2tpcChza2lwKVxuICAgICAgLmxpbWl0KHBhcnNlSW50KGxpbWl0LCAxMCkpO1xuXG4gICAgLy8gR2V0IHRvdGFsIGNvdW50XG4gICAgY29uc3QgdG90YWwgPSBhd2FpdCBCb29raW5nLmNvdW50RG9jdW1lbnRzKHF1ZXJ5KTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGJvb2tpbmdzLFxuICAgICAgICBwYWdpbmF0aW9uOiB7XG4gICAgICAgICAgY3VycmVudDogcGFyc2VJbnQocGFnZSwgMTApLFxuICAgICAgICAgIHBhZ2VzOiBNYXRoLmNlaWwodG90YWwgLyBwYXJzZUludChsaW1pdCwgMTApKSxcbiAgICAgICAgICB0b3RhbFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIGZldGNoaW5nIGFsbCBib29raW5ncycsIHsgZXJyb3I6IGVyci5tZXNzYWdlIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gVXBkYXRlIGJvb2tpbmcgc3RhdHVzIChhZG1pbiBvbmx5KVxuY29uc3QgdXBkYXRlQm9va2luZ1N0YXR1cyA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICBjb25zdCB7IHN0YXR1cyB9ID0gcmVxLmJvZHk7XG5cbiAgICBjb25zdCB2YWxpZFN0YXR1c2VzID0gWydjb25maXJtZWQnLCAnY2FuY2VsbGVkJywgJ2NvbXBsZXRlZCcsICduby1zaG93J107XG4gICAgaWYgKCF2YWxpZFN0YXR1c2VzLmluY2x1ZGVzKHN0YXR1cykpIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ0ludmFsaWQgYm9va2luZyBzdGF0dXMnKTtcbiAgICB9XG5cbiAgICBjb25zdCBib29raW5nID0gYXdhaXQgQm9va2luZy5maW5kQnlJZChpZCk7XG4gICAgaWYgKCFib29raW5nKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcignQm9va2luZyBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICBib29raW5nLnN0YXR1cyA9IHN0YXR1cztcbiAgICBhd2FpdCBib29raW5nLnNhdmUoKTtcblxuICAgIGluZm8oJ0Jvb2tpbmcgc3RhdHVzIHVwZGF0ZWQnLCB7XG4gICAgICBib29raW5nSWQ6IGlkLFxuICAgICAgbmV3U3RhdHVzOiBzdGF0dXMsXG4gICAgICBhZG1pbklkOiByZXEudXNlci5pZFxuICAgIH0pO1xuXG4gICAgcmVzLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdCb29raW5nIHN0YXR1cyB1cGRhdGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGJvb2tpbmdcbiAgICAgIH1cbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBlcnJvcignRXJyb3IgdXBkYXRpbmcgYm9va2luZyBzdGF0dXMnLCB7IGVycm9yOiBlcnIubWVzc2FnZSwgYm9va2luZ0lkOiByZXEucGFyYW1zLmlkIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxuLy8gQ2hlY2sgYXZhaWxhYmlsaXR5IGZvciBhIGRlc3RpbmF0aW9uXG5jb25zdCBjaGVja0F2YWlsYWJpbGl0eSA9IGFzeW5jKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBkZXN0aW5hdGlvbklkLCBjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlIH0gPSByZXEucXVlcnk7XG5cbiAgICBpZiAoIWRlc3RpbmF0aW9uSWQgfHwgIWNoZWNrSW5EYXRlIHx8ICFjaGVja091dERhdGUpIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ01pc3NpbmcgcmVxdWlyZWQgcGFyYW1ldGVycycpO1xuICAgIH1cblxuICAgIGNvbnN0IGNoZWNrSW4gPSBuZXcgRGF0ZShjaGVja0luRGF0ZSk7XG4gICAgY29uc3QgY2hlY2tPdXQgPSBuZXcgRGF0ZShjaGVja091dERhdGUpO1xuXG4gICAgY29uc3QgaXNBdmFpbGFibGUgPSBhd2FpdCBCb29raW5nLmNoZWNrQXZhaWxhYmlsaXR5KGRlc3RpbmF0aW9uSWQsIGNoZWNrSW4sIGNoZWNrT3V0KTtcblxuICAgIHJlcy5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGF2YWlsYWJsZTogaXNBdmFpbGFibGUsXG4gICAgICAgIGNoZWNrSW5EYXRlOiBjaGVja0luLFxuICAgICAgICBjaGVja091dERhdGU6IGNoZWNrT3V0XG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgZXJyb3IoJ0Vycm9yIGNoZWNraW5nIGF2YWlsYWJpbGl0eScsIHsgZXJyb3I6IGVyci5tZXNzYWdlIH0pO1xuICAgIG5leHQoZXJyKTtcbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGNyZWF0ZUJvb2tpbmcsXG4gIGdldFVzZXJCb29raW5ncyxcbiAgZ2V0Qm9va2luZ0J5SWQsXG4gIGNhbmNlbEJvb2tpbmcsXG4gIGdldEFsbEJvb2tpbmdzLFxuICB1cGRhdGVCb29raW5nU3RhdHVzLFxuICBjaGVja0F2YWlsYWJpbGl0eVxufTsiXSwibWFwcGluZ3MiOiJBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGdDQUFnQyxDQUFDO0FBQ3pELE1BQU1DLFdBQVcsR0FBR0QsT0FBTyxDQUFDLG9DQUFvQyxDQUFDO0FBQ2pFLE1BQU07RUFBRUUsZUFBZTtFQUFFQyxhQUFhO0VBQUVDO0FBQWMsQ0FBQyxHQUFHSixPQUFPLENBQUMsaUJBQWlCLENBQUM7QUFDcEYs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